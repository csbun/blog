<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Tree-shaking ES2015 | Hans Chan&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- hexo-algolia -->
  <meta property="algolia:search" data-application-id="1DJDVE2IL4" data-api-key="c784a416f2e153ae75b1288ed8c3b0d8" data-index-name="BLOG">

  <meta name="description" content="🌲🎅 ~~ 圣诞快乐 ~~ 🎉✨ Rollup之前看到 rollup.js 就觉得很有趣，后来终于有空，把我的小项目 silly-datetime 改成了 ES2015 然后用 Rollup 转成 CommonJS 和 UMD 两个版本分别给 npm 和 Bower 使用。">
<meta name="keywords" content="ES2015,Browserify,webpack,Rollup">
<meta property="og:type" content="article">
<meta property="og:title" content="Tree-shaking ES2015">
<meta property="og:url" content="http://csbun.github.io/blog/2015/12/tree-shaking-es2015/index.html">
<meta property="og:site_name" content="Hans Chan&#39;s Blog">
<meta property="og:description" content="🌲🎅 ~~ 圣诞快乐 ~~ 🎉✨ Rollup之前看到 rollup.js 就觉得很有趣，后来终于有空，把我的小项目 silly-datetime 改成了 ES2015 然后用 Rollup 转成 CommonJS 和 UMD 两个版本分别给 npm 和 Bower 使用。">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2018-12-12T13:06:56.798Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Tree-shaking ES2015">
<meta name="twitter:description" content="🌲🎅 ~~ 圣诞快乐 ~~ 🎉✨ Rollup之前看到 rollup.js 就觉得很有趣，后来终于有空，把我的小项目 silly-datetime 改成了 ES2015 然后用 Rollup 转成 CommonJS 和 UMD 两个版本分别给 npm 和 Bower 使用。">
  
  
    <link rel="icon" href="favicon.ico">
  
  
 <link href='https://fonts.googleapis.com/css?family=Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
 <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>


  <link rel="stylesheet" href="/blog/css/style.css">
  <link rel="stylesheet" href="/blog/font-awesome/css/font-awesome.min.css">
  

<!-- Hotjar Tracking Code for csbun.github.io/blog/ -->
<script>
(function(h,o,t,j,a,r){
  h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
  h._hjSettings={hjid:483587,hjsv:5};
  a=o.getElementsByTagName('head')[0];
  r=o.createElement('script');r.async=1;
  r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
  a.appendChild(r);
})(window,document,'//static.hotjar.com/c/hotjar-','.js?sv=');
</script>
<!-- End Hotjar Tracking Code -->

<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-69725995-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  
<meta name="google-site-verification" content="w7Jze6jotMvxHSzsNqwEukg5f2L6VNFgRcPZBwBGln8" />


  
  <!-- Google Adsense -->
  <script data-ad-client="ca-pub-6414613701003177" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</head>
<body>
  <div id="container">
    <header id="header">
  <div id="header-main" class="header-inner">
    <div class="outer">
      <a href="/blog/" id="logo"><i class="logo" style="background-image: url(/blog/css/images/logo.png)"></i><span class="site-title">Hans Chan&#39;s Blog</span></a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/blog/.">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
          <a class="main-nav-link" href="/blog/tags">Tags</a>
        
      </nav>
      
        <nav id="sub-nav">
          <div class="profile" id="profile-nav">
            <a id="profile-anchor" href="javascript:;"><img class="avatar" src="https://www.gravatar.com/avatar/dc4674b8f674322328c02339cf8da615"><i class="fa fa-caret-down"></i></a>
          </div>
        </nav>
      
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"> </button><input type="hidden" name="sitesearch" value="http://csbun.github.io/blog"></form>
      </div>
    </div>
  </div>
  <div id="main-nav-mobile" class="header-sub header-inner">
    <table class="menu outer">
      <tr>
        
          <td><a class="main-nav-link" href="/blog/.">Home</a></td>
        
          <td><a class="main-nav-link" href="/blog/archives">Archives</a></td>
        
          <td><a class="main-nav-link" href="/blog/tags">Tags</a></td>
        
        <td>
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://csbun.github.io/blog"></form>
        </td>
      </tr>
    </table>
  </div>
</header>

    <div class="outer">
      
        <aside id="profile">
  <div class="inner profile-inner">
    <div class="base-info profile-block">
      <img id="avatar" src="https://www.gravatar.com/avatar/dc4674b8f674322328c02339cf8da615?s=256">
      <h2 id="name">叉起来就可以烧</h2>
      <h3 id="title">傻逼切图仔</h3>
      <span id="location"><i class="fa fa-map-marker"></i>广州 · Guangzhou, China</span>
      <a id="follow" href="https://github.com/csbun/">FOLLOW</a>
    </div>
    <div class="article-info profile-block">
      <div class="article-info-block">
        40
        <span>posts</span>
      </div>
      <div class="article-info-block">
        66
        <span>tags</span>
      </div>
    </div>
    
    <div class="contact-info profile-block">
      <table class="contact-list">
        <tr>
          
          <td><a href="https://github.com/csbun" target="_blank" title="github"><i class="fa fa-github"></i></a></td>
          
          <td><a href="/blog/atom.xml" target="_blank" title="rss"><i class="fa fa-rss"></i></a></td>
          
        </tr>
      </table>
    </div>
    
    
  </div>
</aside>

      
      <section id="main"><article id="post-tree-shaking-es2015" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      
	
    <div class="article-banner">
		  <img src="/blog/gallery/taiwan/DSC03388.jpg">
    </div>
	


    
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Tree-shaking ES2015
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/blog/2015/12/tree-shaking-es2015/">
      <time datetime="2015-12-25T13:27:23.000Z" itemprop="datePublished">2015-12-25</time>
    </a>
  </div>


          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>🌲🎅 ~~ 圣诞快乐 ~~ 🎉✨</p>
<h2><span id="rollup">Rollup</span></h2><p>之前看到 <a href="http://rollupjs.org/" target="_blank" rel="noopener">rollup.js</a> 就觉得很有趣，后来终于有空，把我的小项目 <a href="https://github.com/csbun/silly-datetime" target="_blank" rel="noopener">silly-datetime</a> 改成了 ES2015 然后用 Rollup 转成 CommonJS 和 UMD 两个版本分别给 <a href="https://www.npmjs.com/" target="_blank" rel="noopener">npm</a> 和 <a href="http://bower.io/" target="_blank" rel="noopener">Bower</a> 使用。</p>
<a id="more"></a>
<p>简单贴一下使用方法：在项目根目录下创建一个 <em><a href="https://github.com/csbun/silly-datetime/blob/master/rollup.js" target="_blank" rel="noopener">rollup.js</a></em> 文件，调用 Rollup 的 API，内容如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> rollup = <span class="built_in">require</span>( <span class="string">'rollup'</span> );</span><br><span class="line"><span class="keyword">var</span> babel = <span class="built_in">require</span>(<span class="string">'rollup-plugin-babel'</span>);</span><br><span class="line"></span><br><span class="line">rollup.rollup(&#123;</span><br><span class="line">  <span class="comment">// 入口文件</span></span><br><span class="line">  entry: <span class="string">'src/index.js'</span>,</span><br><span class="line">  plugins: [</span><br><span class="line">    babel()</span><br><span class="line">  ]</span><br><span class="line">&#125;).then( <span class="function"><span class="keyword">function</span> (<span class="params"> bundle </span>) </span>&#123;</span><br><span class="line">  <span class="comment">// CommonJS</span></span><br><span class="line">  bundle.write(&#123;</span><br><span class="line">    format: <span class="string">'cjs'</span>,</span><br><span class="line">    dest: <span class="string">'dest/index.js'</span></span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// UMD</span></span><br><span class="line">  bundle.write(&#123;</span><br><span class="line">    format: <span class="string">'umd'</span>,</span><br><span class="line">    moduleName: <span class="string">'SillyDatetime'</span>,</span><br><span class="line">    dest: <span class="string">'dest/index.umd.js'</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>命令行运行这个文件 <code>node rollup.js</code> 即可生成 <code>dest/index.js</code> 和 <code>dest/index.umd.js</code>。如果希望方便改组件被别的项目调用，就需进行一些配置声明，包括 <em>package.json</em></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"main"</span>: <span class="string">"dest/index.js"</span>,</span><br><span class="line">  <span class="attr">"jsnext:main"</span>: <span class="string">"src/index.js"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和 <em>bower.json</em>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"main"</span>: <span class="string">"dest/index.umd.js"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然而这并不是 Rollup 最强大功能的体现，因为这看不出 Tree-shaking。</p>
<h2><span id="tree-shaking">Tree-shaking</span></h2><blockquote>
<p>eliminate unused library code</p>
</blockquote>
<p>我们可以看到 <a href="https://github.com/csbun/silly-datetime" target="_blank" rel="noopener">silly-datetime</a> 提供了 <code>format</code>、<code>fromNow</code> 和 <code>locate</code> 3 个方法，然而大部分时间我们只需要用到其中的一个，如果将这么一个完整的文件 bundle 起来，将有很多无用的代码。</p>
<p>下面，我们将创建这么一个示例说明情况，首先我们新建一个项目，引用上述的 <a href="https://github.com/csbun/silly-datetime" target="_blank" rel="noopener">silly-datetime</a>:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm init</span><br><span class="line">npm i silly-datetime --save</span><br><span class="line">touch index.js</span><br></pre></td></tr></table></figure>
<p>然后我们修改 <em>index.js</em> ：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; format &#125; <span class="keyword">from</span> <span class="string">'silly-datetime'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> getStr = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> format(<span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> formatedDate = getStr();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`now is <span class="subst">$&#123;formatedDate&#125;</span>`</span>);</span><br></pre></td></tr></table></figure>
<h3><span id="browserify">Browserify</span></h3><p>我们先试试 Browserify，但在这之前我们需要添加一下 babel 插件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i babelify babel-preset-es2015 --save-dev</span><br></pre></td></tr></table></figure>
<p>并配置一下 <em>package.json</em></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"browserify"</span>: &#123;</span><br><span class="line">    <span class="attr">"transform"</span>: [</span><br><span class="line">      [ <span class="string">"babelify"</span>, &#123; <span class="attr">"presets"</span>: [ <span class="string">"es2015"</span> ] &#125; ]</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行 <code>browserify index.js &gt; dest/bundle.browserify.js</code> 后我们可以看到 bundle 文件用的是之前已经用 rollup 生成的 <code>node_modules/silly-datetime/dest/index.js</code>。于是我们将源码复制出来</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp node_modules/silly-datetime/src/index.js lib/silly-datetime.es2015.js</span><br></pre></td></tr></table></figure>
<p>并改一下 <em>index.js</em>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; format &#125; <span class="keyword">from</span> <span class="string">'./lib/silly-datetime.es2015.js'</span>;</span><br></pre></td></tr></table></figure>
<p>再来一次如何？看到 bundle 文件已经将 ES2015 转成了 CommonJS 的 ES5:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#123;<span class="number">1</span>:[<span class="function"><span class="keyword">function</span>(<span class="params">require,module,exports</span>)</span>&#123;</span><br><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _datetimeEs = <span class="built_in">require</span>(<span class="string">'./lib/silly-datetime.es2015.js'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> getStr = <span class="function"><span class="keyword">function</span> <span class="title">getStr</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="number">0</span>, _datetimeEs.format)(<span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> formatedDate = getStr();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'now is '</span> + formatedDate);</span><br><span class="line"></span><br><span class="line">&#125;,&#123;<span class="string">"./lib/silly-datetime.es2015.js"</span>:<span class="number">2</span>&#125;],<span class="number">2</span>:[<span class="function"><span class="keyword">function</span>(<span class="params">require,module,exports</span>)</span>&#123;</span><br><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"><span class="comment">/* 注意这里 */</span></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(exports, <span class="string">"__esModule"</span>, &#123;</span><br><span class="line">  value: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br><span class="line">exports.format = format;</span><br><span class="line">exports.locate = locate;</span><br><span class="line">exports.fromNow = fromNow;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;]&#125;</span><br></pre></td></tr></table></figure>
<p>明显这里的 <code>locate</code> 和 <code>fromNow</code> 是不会被消灭的，即使使用了 <a href="https://github.com/mishoo/UglifyJS" target="_blank" rel="noopener">UglifyJS</a>。另外，细心的同学会发现这段代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">0</span>, _datetimeEs.format)(<span class="keyword">new</span> <span class="built_in">Date</span>());</span><br></pre></td></tr></table></figure>
<p>为什么会这样？看一下 <a href="http://rauschma.de/" target="_blank" rel="noopener">Dr. Axel Rauschmayer</a> 的 <a href="http://www.2ality.com/2015/12/references.html" target="_blank" rel="noopener">Why is (0,obj.prop)() not a method call?</a>。</p>
<h3><span id="rollup">Rollup</span></h3><p>我们看看 Rollup 的表现，一样要添加 babel 插件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i rollup-plugin-babel babel-preset-es2015-rollup --save-dev</span><br></pre></td></tr></table></figure>
<p>并配置一下 <em>rollup.config.js</em>（详见 <a href="https://github.com/rollup/rollup/wiki/Command-Line-Interface" target="_blank" rel="noopener">Command-Line-Interface</a>）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> babel <span class="keyword">from</span> <span class="string">'rollup-plugin-babel'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  entry: <span class="string">'index.js'</span>,</span><br><span class="line">  dest: <span class="string">'dest/bundle.rollup.js'</span>,</span><br><span class="line">  format: <span class="string">'umd'</span>,</span><br><span class="line">  plugins: [ babel() ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>和 <em>.babelrc</em>（详见 <a href="https://github.com/rollup/rollup-plugin-babel" target="_blank" rel="noopener">rollup-plugin-babel</a>）：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"presets"</span>: [ <span class="string">"es2015-rollup"</span> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个时候执行 <code>rollup -c rollup.config.js</code> 我们能看到生成的代码量非常的少：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">global, factory</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">typeof</span> exports === <span class="string">'object'</span> &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">module</span> !== <span class="string">'undefined'</span> ? factory() :</span><br><span class="line">  <span class="keyword">typeof</span> define === <span class="string">'function'</span> &amp;&amp; define.amd ? define(factory) :</span><br><span class="line">  factory();</span><br><span class="line">&#125;(<span class="keyword">this</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="string">'use strict'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getDateObject</span>(<span class="params">datetime</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">format</span>(<span class="params">datetime, formatStr</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ... 这里使用了 getDateObject()</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// import &#123; format &#125; from 'silly-datetime';</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> getStr = <span class="function"><span class="keyword">function</span> <span class="title">getStr</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> format(<span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> formatedDate = getStr();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'now is '</span> + formatedDate);</span><br><span class="line"></span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>
<p>可以看出，完全没有多余的代码，而且甚至模块都没有了，看不到任何的 <code>require</code> 定义，<code>import</code> 的内容直接 inline 到主文档中了。这回我就好奇了，如果依赖关系再复杂一点，还会是怎样呢？于是我造了一个稍微复杂一点的 <a href="https://github.com/csbun/tree-shaking-demo/tree/master/rollup" target="_blank" rel="noopener">例子</a>，结果还是 <a href="https://github.com/csbun/tree-shaking-demo/blob/master/rollup/bundle.js" target="_blank" rel="noopener">inline 到一起了</a>！</p>
<p>但是，上面这两个例子都有一个问题，为嘛我需要将源码复制出来？难道不能直接 import ？</p>
<blockquote>
<p>Yes, we can!</p>
</blockquote>
<p>文章最上面我们的组件已经定义了 <code>&quot;jsnext:main&quot;: &quot;src/index.js&quot;</code>，所以在使用 rollup 的这个 <a href="https://github.com/rollup/rollup/wiki/jsnext:main" target="_blank" rel="noopener">语法糖</a> 后，我们就能直接将该组件 import 进来：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; format &#125; <span class="keyword">from</span> <span class="string">'silly-datetime'</span>;</span><br></pre></td></tr></table></figure>
<p>但是这样的 bundle 文件不会包含 npm package 的源码，紧急只是转化成 <code>var format = require(&#39;silly-datetime);</code>，所以我们还需要安装一个插件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev rollup-plugin-npm</span><br></pre></td></tr></table></figure>
<p>加到配置里 <em>rollup.config.js</em> 面去：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> babel <span class="keyword">from</span> <span class="string">'rollup-plugin-babel'</span>;</span><br><span class="line"><span class="keyword">import</span> npm <span class="keyword">from</span> <span class="string">'rollup-plugin-npm'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  entry: <span class="string">'index.js'</span>,</span><br><span class="line">  dest: <span class="string">'dest/bundle.rollup.js'</span>,</span><br><span class="line">  format: <span class="string">'umd'</span>,</span><br><span class="line">  plugins: [</span><br><span class="line">    babel(),</span><br><span class="line">    npm(&#123;</span><br><span class="line">      jsnext: <span class="literal">true</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>出来的 bundle 文件就和上面的效果一样了~</p>
<h3><span id="webpack-2">webpack 2</span></h3><p>终于到这一步了，就是因为看了 Axel 的这篇 <a href="http://www.2ality.com/2015/12/webpack-tree-shaking.html" target="_blank" rel="noopener">Tree-shaking with webpack 2 and Babel 6</a> 才有了这篇文章。</p>
<p><a href="https://webpack.github.io/" target="_blank" rel="noopener">webpack</a> 2 目前还是 beta 版本，但是我们还是可以使用的。按照博士的说法，因为 <a href="https://www.npmjs.com/package/babel-preset-es2015" target="_blank" rel="noopener">babel-preset-es2015</a> <a href="https://github.com/babel/babel/blob/7b369674163e40241ff41e63458c8d98298e942a/packages/babel-preset-es2015/package.json" target="_blank" rel="noopener">包含</a> 了 <a href="https://www.npmjs.com/package/babel-plugin-transform-es2015-modules-commonjs" target="_blank" rel="noopener">babel-plugin-transform-es2015-modules-commonjs</a>，而 commonjs 的打包方式注定不能实现我们的 Tree-shaking 大计，所以我们不能直接使用 babel-preset-es2015，而是直接使用他所包含的除了 commonjs 以外的其他全部依赖 plugin。</p>
<p>这回要安装的东西就多了，如果是 npm2 的就在 <em>package.json</em> 里直接添加 devDependences 好了：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"webpack"</span>: <span class="string">"^2.0.2-beta"</span>,</span><br><span class="line">    <span class="attr">"babel-loader"</span>: <span class="string">"^6.2.0"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-template-literals"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-literals"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-function-name"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-arrow-functions"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-block-scoped-functions"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-classes"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-object-super"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-shorthand-properties"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-computed-properties"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-for-of"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-sticky-regex"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-unicode-regex"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-check-es2015-constants"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-spread"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-parameters"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-destructuring"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-block-scoping"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-typeof-symbol"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-modules-commonjs"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-regenerator"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>npm i</code> 时会说 peer dependency 冲突，请忽略之，因为我们在用 beta 的 webpack。然后写一下我最不喜欢的 <em>webpack.config.js</em>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>); <span class="comment">// webpack 2</span></span><br><span class="line"><span class="keyword">var</span> dir = __dirname;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    entry: path.join(dir, <span class="string">'index.js'</span>),</span><br><span class="line">    output: &#123;</span><br><span class="line">        path: path.join(dir, <span class="string">'dest'</span>),</span><br><span class="line">        filename: <span class="string">'webpack.bundle.js'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="built_in">module</span>: &#123;</span><br><span class="line">        loaders: [&#123;</span><br><span class="line">            loader: <span class="string">'babel-loader'</span>,</span><br><span class="line">            test: dir,</span><br><span class="line">            query: &#123;</span><br><span class="line">                <span class="comment">// presets: ['es2015'],</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// All of the plugins of babel-preset-es2015,</span></span><br><span class="line">                <span class="comment">// minus babel-plugin-transform-es2015-modules-commonjs</span></span><br><span class="line">                plugins: [</span><br><span class="line">                    <span class="string">'transform-es2015-template-literals'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-literals'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-function-name'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-arrow-functions'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-block-scoped-functions'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-classes'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-object-super'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-shorthand-properties'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-computed-properties'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-for-of'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-sticky-regex'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-unicode-regex'</span>,</span><br><span class="line">                    <span class="string">'check-es2015-constants'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-spread'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-parameters'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-destructuring'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-block-scoping'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-typeof-symbol'</span>,</span><br><span class="line">                    [<span class="string">'transform-regenerator'</span>, &#123; <span class="attr">async</span>: <span class="literal">false</span>, <span class="attr">asyncGenerators</span>: <span class="literal">false</span> &#125;],</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;]</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="comment">// Avoid publishing files when compilation fails</span></span><br><span class="line">        <span class="keyword">new</span> webpack.NoErrorsPlugin()</span><br><span class="line">    ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>因为 webpack 也不认识 <code>jsnext:main</code>，我们还是需要直接 import ES2015 的源码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; format &#125; <span class="keyword">from</span> <span class="string">'./lib/silly-datetime.es2015.js'</span>;</span><br></pre></td></tr></table></figure>
<p>运行 <code>webpack</code> 看看 <em>dest/webpack.bundle.js</em>（我稍微删减并格式化了一下代码）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/******/</span> (<span class="function"><span class="keyword">function</span>(<span class="params">modules</span>) </span>&#123; <span class="comment">// webpackBootstrap</span></span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line"><span class="comment">/******/</span> &#125;)([</span><br><span class="line"><span class="comment">/* 0 */</span></span><br><span class="line"><span class="comment">/***/</span> <span class="function"><span class="keyword">function</span>(<span class="params">module, exports, __webpack_require__</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* harmony export */</span> exports[<span class="string">"format"</span>] = format;</span><br><span class="line">  <span class="comment">/* unused harmony export locate */</span>;</span><br><span class="line">  <span class="comment">/* unused harmony export fromNow */</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getDateObject</span>(<span class="params">datetime</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">format</span>(<span class="params">datetime, formatStr</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ... 这里使用了 getDateObject()</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">locate</span>(<span class="params">arg</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">fromNow</span>(<span class="params">datetime</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***/</span> &#125;,</span><br><span class="line"><span class="comment">/* 1 */</span></span><br><span class="line"><span class="comment">/***/</span> <span class="function"><span class="keyword">function</span>(<span class="params">module, exports, __webpack_require__</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* harmony import */</span> <span class="keyword">var</span> __WEBPACK_IMPORTED_MODULE_0__lib_silly_datetime_es2015_js__ = __webpack_require__(<span class="number">0</span>);</span><br><span class="line"><span class="meta">  'use strict'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> getStr = <span class="function"><span class="keyword">function</span> <span class="title">getStr</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="comment">/* harmony import */</span> __WEBPACK_IMPORTED_MODULE_0__lib_silly_datetime_es2015_js__[<span class="string">"format"</span>](<span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> formatedDate = getStr();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'now is '</span> + formatedDate);</span><br><span class="line"></span><br><span class="line"><span class="comment">/***/</span> &#125;</span><br><span class="line"><span class="comment">/******/</span> ]);</span><br></pre></td></tr></table></figure>
<p>从第 7 至 9 行可以看到， <code>locate</code> 和 <code>fromNow</code> 并没有被 export，虽然下方还能看到这两个方法的声明，但是只要经过 UglifyJs，这两个方法必然 <a href="http://www.2ality.com/2015/12/webpack-tree-shaking.html#how_webpack_2_eliminates_unused_exports" target="_blank" rel="noopener">会被消除</a>：</p>
<blockquote>
<h5><span id="how-webpack-2-eliminates-unused-exports">How webpack 2 eliminates unused exports</span></h5><p>webpack 2, a new version that is in beta, eliminates unused exports in two steps:</p>
</blockquote>
<blockquote>
<ul>
<li>First, all ES6 module files are combined into a single bundle file. In that file, exports that were not imported anywhere are not exported, anymore.</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>Second, the bundle is minified, while eliminating dead code. Therefore, entities that are neither exported nor used inside their modules do not appear in the minified bundle. Without the first step, dead code elimination would never remove exports (registering an export keeps it alive).</li>
</ul>
</blockquote>
<p>可以运行 <code>webpack --optimize-minimize</code> 看到执行效果：</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">Hash:</span> b8357dea1720f84e6a76</span><br><span class="line"><span class="symbol">Version:</span> webpack <span class="number">2.0</span>.<span class="number">2</span>-beta</span><br><span class="line"><span class="symbol">Time:</span> <span class="number">9812</span>ms</span><br><span class="line">            Asset       Size  Chunks             Chunk Names</span><br><span class="line">webpack.bundle.js  <span class="number">935</span> bytes       <span class="number">0</span>  [emitted]  main</span><br><span class="line">    + <span class="number">2</span> hidden modules</span><br><span class="line"></span><br><span class="line">WARNING in webpack.bundle.js from UglifyJs</span><br><span class="line">Dropping unused function locate [./<span class="class"><span class="keyword">lib</span>/<span class="title">silly</span>-<span class="title">datetime</span>.<span class="title">es2015</span>.<span class="title">js</span>:84,16]</span></span><br><span class="line">Dropping unused function fromNow [./<span class="class"><span class="keyword">lib</span>/<span class="title">silly</span>-<span class="title">datetime</span>.<span class="title">es2015</span>.<span class="title">js</span>:120,16]</span></span><br><span class="line">Dropping unused variable LOCALE_EN [./<span class="class"><span class="keyword">lib</span>/<span class="title">silly</span>-<span class="title">datetime</span>.<span class="title">es2015</span>.<span class="title">js</span>:55,6]</span></span><br><span class="line">Dropping unused variable LOCALE_ZH_CN [./<span class="class"><span class="keyword">lib</span>/<span class="title">silly</span>-<span class="title">datetime</span>.<span class="title">es2015</span>.<span class="title">js</span>:66,6]</span></span><br><span class="line">Dropping unused variable _curentLocale [./<span class="class"><span class="keyword">lib</span>/<span class="title">silly</span>-<span class="title">datetime</span>.<span class="title">es2015</span>.<span class="title">js</span>:77,4]</span></span><br><span class="line">Dropping unused variable DET_STD [./<span class="class"><span class="keyword">lib</span>/<span class="title">silly</span>-<span class="title">datetime</span></span></span><br></pre></td></tr></table></figure>
<p>文件体积由原来的 5.68 kB 下降到了 935 bytes（当然这里也有 UglifyJs 的功劳）。</p>
<h3><span id="再回到-browserify">再回到 Browserify</span></h3><p>受上面的启发，在 Browserify 里面也能这样麽？我把 <em>package.json</em> 配置成这样：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"browserify"</span>: &#123;</span><br><span class="line">    <span class="attr">"transform"</span>: [</span><br><span class="line">      [ <span class="string">"babelify"</span>, &#123;</span><br><span class="line">        <span class="attr">"plugins"</span>: [</span><br><span class="line">          <span class="string">"transform-es2015-template-literals"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-literals"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-function-name"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-arrow-functions"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-block-scoped-functions"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-classes"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-object-super"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-shorthand-properties"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-computed-properties"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-for-of"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-sticky-regex"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-unicode-regex"</span>,</span><br><span class="line">          <span class="string">"check-es2015-constants"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-spread"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-parameters"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-destructuring"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-block-scoping"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-typeof-symbol"</span>,</span><br><span class="line">          [<span class="string">"transform-regenerator"</span>, &#123; <span class="attr">"async"</span>: <span class="literal">false</span>, <span class="attr">"asyncGenerators"</span>: <span class="literal">false</span> &#125;]</span><br><span class="line">        ]</span><br><span class="line">      &#125; ]</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再运行 <code>browserify index.js &gt; dest/bundle.browserify.js</code>，结果以失败告终…<br>没有 commonjs，browserify 应该还是干不来的，如果有成功的童鞋麻烦告诉我怎么破。</p>
<h2><span id="碎碎念">碎碎念</span></h2><p>本文特别是 webpack 一节，参(chao)考(xi) <a href="http://www.2ality.com/2015/12/webpack-tree-shaking.html" target="_blank" rel="noopener">Tree-shaking with webpack 2 and Babel 6</a>。上面大部分源码可以在我的 GitHub 上面 <a href="https://github.com/csbun/tree-shaking-demo" target="_blank" rel="noopener">找到</a>。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://csbun.github.io/blog/2015/12/tree-shaking-es2015/" data-id="ckclwh8uk001n8plw53nes0dm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Browserify/">Browserify</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/ES2015/">ES2015</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Rollup/">Rollup</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/webpack/">webpack</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/blog/2016/01/modules/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Modules in CommonJS and ES2015
        
      </div>
    </a>
  
  
    <a href="/blog/2015/12/starting-react-native-with-android/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">在 Android 上开始使用 React Native</div>
    </a>
  
</nav>


  
</article>


  <section id="comments"></section>

</section>
      
        <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">tag cloud</h3>
    <div class="widget tagcloud">
      <a href="/blog/tags/Ajax/" style="font-size: 10px;">Ajax</a> <a href="/blog/tags/Android/" style="font-size: 10px;">Android</a> <a href="/blog/tags/Angular/" style="font-size: 20px;">Angular</a> <a href="/blog/tags/Browserify/" style="font-size: 13.33px;">Browserify</a> <a href="/blog/tags/Chrome/" style="font-size: 10px;">Chrome</a> <a href="/blog/tags/CommonJS/" style="font-size: 13.33px;">CommonJS</a> <a href="/blog/tags/DOM/" style="font-size: 10px;">DOM</a> <a href="/blog/tags/Docker/" style="font-size: 16.67px;">Docker</a> <a href="/blog/tags/ES2015/" style="font-size: 13.33px;">ES2015</a> <a href="/blog/tags/Filter/" style="font-size: 10px;">Filter</a> <a href="/blog/tags/Flux/" style="font-size: 13.33px;">Flux</a> <a href="/blog/tags/Fluxxor/" style="font-size: 10px;">Fluxxor</a> <a href="/blog/tags/Headless/" style="font-size: 10px;">Headless</a> <a href="/blog/tags/JSON/" style="font-size: 10px;">JSON</a> <a href="/blog/tags/Java/" style="font-size: 10px;">Java</a> <a href="/blog/tags/Karma/" style="font-size: 10px;">Karma</a> <a href="/blog/tags/Meteor/" style="font-size: 10px;">Meteor</a> <a href="/blog/tags/Mutation-Observer/" style="font-size: 10px;">Mutation Observer</a> <a href="/blog/tags/NW-js/" style="font-size: 10px;">NW.js</a> <a href="/blog/tags/Native/" style="font-size: 10px;">Native</a> <a href="/blog/tags/Node/" style="font-size: 16.67px;">Node</a> <a href="/blog/tags/PWA/" style="font-size: 10px;">PWA</a> <a href="/blog/tags/Preact/" style="font-size: 13.33px;">Preact</a> <a href="/blog/tags/Puppeteer/" style="font-size: 10px;">Puppeteer</a> <a href="/blog/tags/React/" style="font-size: 20px;">React</a> <a href="/blog/tags/RequireJS/" style="font-size: 10px;">RequireJS</a> <a href="/blog/tags/Rollup/" style="font-size: 10px;">Rollup</a> <a href="/blog/tags/Selenium/" style="font-size: 13.33px;">Selenium</a> <a href="/blog/tags/ServiceWorker/" style="font-size: 13.33px;">ServiceWorker</a> <a href="/blog/tags/Stateful/" style="font-size: 10px;">Stateful</a> <a href="/blog/tags/Storybook/" style="font-size: 10px;">Storybook</a> <a href="/blog/tags/Vue/" style="font-size: 10px;">Vue</a> <a href="/blog/tags/Workbox/" style="font-size: 10px;">Workbox</a> <a href="/blog/tags/async/" style="font-size: 13.33px;">async</a> <a href="/blog/tags/ci/" style="font-size: 16.67px;">ci</a> <a href="/blog/tags/contentEditable/" style="font-size: 10px;">contentEditable</a> <a href="/blog/tags/coverage/" style="font-size: 10px;">coverage</a> <a href="/blog/tags/debug/" style="font-size: 10px;">debug</a> <a href="/blog/tags/deserialization/" style="font-size: 10px;">deserialization</a> <a href="/blog/tags/desktop/" style="font-size: 10px;">desktop</a> <a href="/blog/tags/events/" style="font-size: 10px;">events</a> <a href="/blog/tags/generator/" style="font-size: 10px;">generator</a> <a href="/blog/tags/google/" style="font-size: 10px;">google</a> <a href="/blog/tags/install/" style="font-size: 10px;">install</a> <a href="/blog/tags/koa/" style="font-size: 10px;">koa</a> <a href="/blog/tags/less/" style="font-size: 10px;">less</a> <a href="/blog/tags/log/" style="font-size: 10px;">log</a> <a href="/blog/tags/logo/" style="font-size: 10px;">logo</a> <a href="/blog/tags/nightmare/" style="font-size: 10px;">nightmare</a> <a href="/blog/tags/npm/" style="font-size: 10px;">npm</a> <a href="/blog/tags/performance/" style="font-size: 10px;">performance</a> <a href="/blog/tags/permissions/" style="font-size: 10px;">permissions</a> <a href="/blog/tags/publish/" style="font-size: 10px;">publish</a> <a href="/blog/tags/requestAnimationFrame/" style="font-size: 10px;">requestAnimationFrame</a> <a href="/blog/tags/requestIdleCallback/" style="font-size: 10px;">requestIdleCallback</a> <a href="/blog/tags/serialization/" style="font-size: 10px;">serialization</a> <a href="/blog/tags/ssr/" style="font-size: 10px;">ssr</a> <a href="/blog/tags/test/" style="font-size: 20px;">test</a> <a href="/blog/tags/ui/" style="font-size: 10px;">ui</a> <a href="/blog/tags/vue/" style="font-size: 10px;">vue</a> <a href="/blog/tags/webkit/" style="font-size: 10px;">webkit</a> <a href="/blog/tags/webpack/" style="font-size: 13.33px;">webpack</a> <a href="/blog/tags/weex/" style="font-size: 10px;">weex</a> <a href="/blog/tags/美食/" style="font-size: 13.33px;">美食</a> <a href="/blog/tags/风土人情/" style="font-size: 10px;">风土人情</a> <a href="/blog/tags/风景/" style="font-size: 10px;">风景</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/01/">January 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/09/">September 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/08/">August 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/06/">June 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/03/">March 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/11/">November 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/09/">September 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/08/">August 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/04/">April 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/01/">January 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2015/12/">December 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2015/11/">November 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2015/09/">September 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2015/07/">July 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2015/06/">June 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2015/05/">May 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2015/04/">April 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2015/03/">March 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2015/02/">February 2015</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2014/12/">December 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2014/09/">September 2014</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">recents</h3>
    <div class="widget">
      <ul id="recent-post" class="">
        
          <li>
            
            <div class="item-thumbnail">
              <a href="/blog/2018/02/workbox/" class="thumbnail">
  
    <span style="background-image:url(/blog/gallery/taiwan/DSC04075.JPG)" alt="Workbox 入门" class="thumbnail-image"></span>
  
</a>
            </div>
            
            <div class="item-inner">
              <p class="item-category"></p>
              <p class="item-title"><a href="/blog/2018/02/workbox/" class="title">Workbox 入门</a></p>
              <p class="item-date"><time datetime="2018-02-27T09:38:34.000Z" itemprop="datePublished">2018-02-27</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-thumbnail">
              <a href="/blog/2018/01/preact-code-h/" class="thumbnail">
  
    <span style="background-image:url(/blog/gallery/taiwan/P51001-124945.jpg)" alt="Preact 源码解析 —— h/createElement" class="thumbnail-image"></span>
  
</a>
            </div>
            
            <div class="item-inner">
              <p class="item-category"></p>
              <p class="item-title"><a href="/blog/2018/01/preact-code-h/" class="title">Preact 源码解析 —— h/createElement</a></p>
              <p class="item-date"><time datetime="2018-01-25T12:04:25.000Z" itemprop="datePublished">2018-01-25</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-thumbnail">
              <a href="/blog/2017/09/puppeteer/" class="thumbnail">
  
    <span style="background-image:url(https://github.com/csbun/thal/raw/master/media/desertious.jpg
)" alt="译文：Puppeteer 与 Chrome Headless —— 从入门到爬虫" class="thumbnail-image"></span>
  
</a>
            </div>
            
            <div class="item-inner">
              <p class="item-category"></p>
              <p class="item-title"><a href="/blog/2017/09/puppeteer/" class="title">译文：Puppeteer 与 Chrome Headless —— 从入门到爬虫</a></p>
              <p class="item-date"><time datetime="2017-08-31T16:14:09.000Z" itemprop="datePublished">2017-09-01</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-thumbnail">
              <a href="/blog/2017/08/npm-scripts/" class="thumbnail">
  
    <span style="background-image:url(/blog/gallery/sri-lanka/P60417-160040.jpg)" alt="npm scripts 之 publish 和 install" class="thumbnail-image"></span>
  
</a>
            </div>
            
            <div class="item-inner">
              <p class="item-category"></p>
              <p class="item-title"><a href="/blog/2017/08/npm-scripts/" class="title">npm scripts 之 publish 和 install</a></p>
              <p class="item-date"><time datetime="2017-08-24T10:18:32.000Z" itemprop="datePublished">2017-08-24</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-thumbnail">
              <a href="/blog/2017/06/weex-challenger/" class="thumbnail">
  
    <span style="background-image:url(/blog/gallery/sri-lanka/P60412-162831.jpg)" alt="我试了一下 weex" class="thumbnail-image"></span>
  
</a>
            </div>
            
            <div class="item-inner">
              <p class="item-category"></p>
              <p class="item-title"><a href="/blog/2017/06/weex-challenger/" class="title">我试了一下 weex</a></p>
              <p class="item-date"><time datetime="2017-06-15T12:03:59.000Z" itemprop="datePublished">2017-06-15</time></p>
            </div>
          </li>
        
      </ul>
    </div>
  </div>

  
  <!-- Top -->
  <div id="toTop" class="fa fa-chevron-up"></div>
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <!-- Buy Me a Coffee -->
    <div style="margin: 10px;">
      <style>.bmc-button img{width: 27px !important;margin-bottom: 1px !important;box-shadow: none !important;border: none !important;vertical-align: middle !important;}.bmc-button{line-height: 36px !important;height:37px !important;text-decoration: none !important;display:inline-flex !important;color:#ffffff !important;background-color:#FF813F !important;border-radius: 3px !important;border: 1px solid transparent !important;padding: 0px 9px !important;font-size: 17px !important;letter-spacing:-0.08px !important;box-shadow: 0px 1px 2px rgba(190, 190, 190, 0.5) !important;-webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;margin: 0 auto !important;font-family:'Lato', sans-serif !important;-webkit-box-sizing: border-box !important;box-sizing: border-box !important;-o-transition: 0.3s all linear !important;-webkit-transition: 0.3s all linear !important;-moz-transition: 0.3s all linear !important;-ms-transition: 0.3s all linear !important;transition: 0.3s all linear !important;}.bmc-button:hover, .bmc-button:active, .bmc-button:focus {-webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;text-decoration: none !important;box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;opacity: 0.85 !important;color:#ffffff !important;}</style>
      <link href="https://fonts.googleapis.com/css?family=Lato&subset=latin,latin-ext" rel="stylesheet">
      <a class="bmc-button" target="_blank" href="https://www.buymeacoffee.com/csbun">
        <img src="https://www.buymeacoffee.com/assets/img/BMC-btn-logo.svg" alt="Buy me a coffee"><span style="margin-left:5px">Buy me a coffee</span>
      </a>
    </div>
    <div id="footer-info" class="inner">
      &copy; 2014 - 2020 叉起来就可以烧<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
    </div>
  </div>
</footer>
    

<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script type="text/javascript">
  (function() {
    const gitalk = new Gitalk({
      clientID: '445f3ebe09ddd1d6a1eb',
      clientSecret: '677a9844625ec22c3e39dcea819678794bb84d71',
      repo: 'blog',
      owner: 'csbun',
      admin: ['csbun'],
      id: location.pathname,      // Ensure uniqueness and length less than 50
      // createIssueManually: true,
      distractionFreeMode: false,  // Facebook-like distraction free mode
    });
    gitalk.render('comments')
  })();
</script>



 <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>




  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>

    <script src="//unpkg.com/algolia-search-idd@0.1.0/dest/index.min.js"></script>
<script type="text/javascript">
(function () {
  const algoliaConfig = document.querySelector('meta[property="algolia:search"]').dataset;
  $('.search-form')
    .attr('autocomplete', 'off')
    // .on('submit', function(e) {
    //   e.preventDefault();
    // });
  window.algoliaSearchIDD({
    el: '.search-form-input',
    applicationID: algoliaConfig.applicationId,
    apiKey: algoliaConfig.apiKey,
    indexName: algoliaConfig.indexName,
  });
})()
</script>
  </div>
</body>
</html>
