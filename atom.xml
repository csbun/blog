<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Hans Chan&#39;s Blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://csbun.github.io/blog/"/>
  <updated>2020-11-03T11:52:46.477Z</updated>
  <id>http://csbun.github.io/blog/</id>
  
  <author>
    <name>叉起来就可以烧</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Workbox 入门</title>
    <link href="http://csbun.github.io/blog/2018/02/workbox/"/>
    <id>http://csbun.github.io/blog/2018/02/workbox/</id>
    <published>2018-02-27T09:38:34.000Z</published>
    <updated>2020-11-03T11:52:46.477Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://developers.google.com/web/tools/workbox/" target="_blank" rel="noopener">Workbox</a> · JavaScript Libraries for adding offline support to web apps.</p><p>一个为网页应用添加离线支持的 JavaScript 库。</p><blockquote><p>本文内容基于 <a href="mailto:Workbox@3.0.0" target="_blank" rel="noopener">Workbox@3.0.0</a></p></blockquote><a id="more"></a><h2><span id="快速开始">快速开始</span></h2><p>Workbox 作为 SW 模块使用，提供了两个最主要的接口：</p><ul><li><a href="https://developers.google.com/web/tools/workbox/reference-docs/latest/workbox.routing#registerRoute" target="_blank" rel="noopener">🔗</a> <code>workbox.routing.registerRoute</code>，接受两个参数，第一个参数 capture 是正则表达式或 Express 风格的路由字符串，声明需要匹配那些请求，第二个参数用于告诉 Workbox 对前面拦截到的请求做何处理。</li><li><a href="https://developers.google.com/web/tools/workbox/reference-docs/latest/workbox.strategies" target="_blank" rel="noopener">🔗</a> <code>workbox.strategies.xxx</code>，用在 registerRoute 的第二个参数，表明使用何种缓存策略。</li></ul><p>最简单的例子：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">importScripts(<span class="string">'https://storage.googleapis.com/workbox-cdn/releases/3.0.0/workbox-sw.js'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// JS 请求: 网络优先</span></span><br><span class="line">workbox.routing.registerRoute(</span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">'.*\.js'</span>),</span><br><span class="line">  workbox.strategies.networkFirst(&#123;</span><br><span class="line">    cacheName: <span class="string">'workbox:js'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>同样的，我们可以继续添加其他的一些缓存策略来应对 css、图片文件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CSS 请求: 缓存优先，同时后台更新后下次打开页面才会被页面使用</span></span><br><span class="line">workbox.routing.registerRoute(</span><br><span class="line">  <span class="comment">// Cache CSS files</span></span><br><span class="line">  /.*\.css/,</span><br><span class="line">  <span class="comment">// Use cache but update in the background ASAP</span></span><br><span class="line">  workbox.strategies.staleWhileRevalidate(&#123;</span><br><span class="line">    <span class="comment">// Use a custom cache name</span></span><br><span class="line">    cacheName: <span class="string">'workbox:css'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 图片请求: 缓存优先</span></span><br><span class="line">workbox.routing.registerRoute(</span><br><span class="line">  <span class="comment">// Cache image files</span></span><br><span class="line">  /.*\.(?:png|jpg|jpeg|svg|gif)/,</span><br><span class="line">  <span class="comment">// Use the cache if it's available</span></span><br><span class="line">  workbox.strategies.cacheFirst(&#123;</span><br><span class="line">    <span class="comment">// Use a custom cache name</span></span><br><span class="line">    cacheName: <span class="string">'workbox:image'</span>,</span><br><span class="line">    plugins: [</span><br><span class="line">      <span class="keyword">new</span> workbox.expiration.Plugin(&#123;</span><br><span class="line">        <span class="comment">// Cache only 20 images</span></span><br><span class="line">        maxEntries: <span class="number">20</span>,</span><br><span class="line">        <span class="comment">// Cache for a maximum of a week</span></span><br><span class="line">        maxAgeSeconds: <span class="number">7</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">    ],</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>对于这样一个简单的页面：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"./css/style.css"</span>&gt;</span><br><span class="line">&lt;<span class="regexp">/head&gt;</span></span><br><span class="line"><span class="regexp">&lt;body&gt;</span></span><br><span class="line"><span class="regexp">  &lt;h1&gt;Workbox Get Started&lt;/</span>h1&gt;</span><br><span class="line">  &lt;img src=<span class="string">"./images/google.local.png"</span> alt=<span class="string">"同域的文件"</span>&gt;</span><br><span class="line">  &lt;script src=<span class="string">"./js/index.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;<span class="regexp">/body&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>html&gt;</span><br></pre></td></tr></table></figure><h3><span id="1">#1</span></h3><p>我们可以看看第一次访问时的效果：<br><img src="/2018/02/workbox/gs1.png" title="Web 第一次访问时的效果"></p><p>和平常的访问没有任何区别，只是多了 sw.js 及其依赖（workbox 等）的请求，并在 <code>Application &gt; Service Workers</code> 中可以看到 sw.js 已经被注册（但其中的 fetch 事件无法在这次访问就被捕获）。</p><h3><span id="2">#2</span></h3><p>于是我们刷新页面看看效果：<br><img src="/2018/02/workbox/gs2.png" title="Web 第二次访问时的效果"></p><ul><li>全部的 css、png、js 文件均被 ServiceWorker 拦截（图中 from ServiceWorker 可以看出）</li><li>workbox-core 在拦截后重新发起了 fetch 请求并返回页面，fetch 后服务端返回 304 依然可以使用浏览器本地缓存策略</li><li>上述命中规则的请求都被缓存到 Cache Storage 中</li></ul><blockquote><p>为了方便看到效果，我设置服务端 Cache Control 失效（<code>max-age=0</code>），使得每次请求都能到达服务端</p></blockquote><img src="/2018/02/workbox/gs3.png" title="Web Cache Storage"><h3><span id="3">#3</span></h3><p>我们更新一下 css、 js 和 png 的内容，然后重新访问页面：</p><img src="/2018/02/workbox/gs4.png" title="Web 第三次访问时的效果"><ul><li>由于 png 是 Cache First，所以直接从 ServiceWorker 的 Cache 返回，没有真正的网络请求发出</li><li>由于 js 是 Network First，所以会产生 fetch，且运行成功（底部 Console 有输出内容）</li><li>css 虽然同样 fetch 了新的内容，但页面并没有生效，用的还是上一次的 Cache（但新的文件内容已经放到 Cache Storage 中）</li></ul><h3><span id="4">#4</span></h3><p>不再做任何修改，刷新页面：</p><img src="/2018/02/workbox/gs5.png" title="Web 第四次访问时的效果"><ul><li>新的 css 生效（<code>staleWhileRevalidate</code>）</li><li>css、js 请求返回为 304，使用浏览器缓存</li></ul><h2><span id="离线应用">离线应用</span></h2><p>要做到能够完全离线，我们还必须让主文档也能被缓存下来，例如我们还是使用 <code>networkFirst</code> 来处理主文档：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主文档: 网络优先</span></span><br><span class="line">workbox.routing.registerRoute(</span><br><span class="line">  /index\.html/,</span><br><span class="line">  workbox.strategies.networkFirst(&#123;</span><br><span class="line">    cacheName: <span class="string">'workbox:html'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>缓存成功后，即便断网，页面依旧可以访问及使用：</p><img src="/2018/02/workbox/ol1.png" title="Web 完全离线"><p>具体 <a href="https://csbun.github.io/workbox-examples/workbox-get-started/index.html">Demo</a> 和 <a href="https://github.com/csbun/workbox-examples/tree/master/workbox-get-started" target="_blank" rel="noopener">原码</a>。</p><h2><span id="跨域请求">跨域请求</span></h2><p>在大多数的应用场景中，我们通常会将静态资源放到 CDN 中，这就涉及到跨域问题。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>不同域的文件<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"https://developers.google.com/web/tools/workbox/images/Workbox-Logo-Grey.svg"</span> <span class="attr">alt</span>=<span class="string">"不同域的文件"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>不同域的文件 且 <span class="tag">&lt;<span class="name">code</span>&gt;</span>access-control-allow-origin: *<span class="tag">&lt;/<span class="name">code</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"https://unpkg.com/resize-image@0.0.4/example/google.png"</span> <span class="attr">alt</span>=<span class="string">"不同域的文件 且 allow cross origin"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 不同域的js 且 access-control-allow-origin: * --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://unpkg.com/jquery@3.3.1/dist/jquery.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>经测试，Workbox 可以用 <code>networkFirst</code> 和 <code>staleWhileRevalidate</code> 两种策略 Cache 跨域资源，而 <code>cacheFirst</code> 则完全不行。按 <a href="https://developers.google.com/web/tools/workbox/guides/handle-third-party-requests#workbox_caches_opaque_response_sometimes" target="_blank" rel="noopener">官网的解释</a>，Fetch 跨域的请求是无法知道该请求是否成功，因此 <code>cacheFirst</code> 则有可能缓存下了失败的请求，并从此以后都会接管页面的这个请求导致页面错误。而 <code>networkFirst</code> 和 <code>staleWhileRevalidate</code> 是有更新机制的，即使一次错误下次也许就修复了呢。</p><blockquote><p><code>cacheFirst</code> 例子中即使开启 <code>Offline</code> 也能浏览到页面是因为 html 是同域的，而跨域的静态资源有浏览器缓存。如果同时开启 <code>Disabel cache</code> 就无法看到相关图片等静态资源了。</p></blockquote><p>如果真的执意要使用 <code>cacheFirst</code> 缓存跨域资源，则可以使用 <a href="https://developers.google.com/web/tools/workbox/reference-docs/latest/workbox.cacheableResponse.Plugin" target="_blank" rel="noopener">cacheableResponse.Plugin</a>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Force Caching of Opaque Responses</span></span><br><span class="line">workbox.routing.registerRoute(</span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">'https://developers\.google\.com/'</span>),</span><br><span class="line">  workbox.strategies.cacheFirst(&#123;</span><br><span class="line">    cacheName: <span class="string">`<span class="subst">$&#123;CACHE_NAME&#125;</span>:cache-first`</span>,</span><br><span class="line">    plugins: [</span><br><span class="line">      <span class="comment">// Force Cache</span></span><br><span class="line">      <span class="keyword">new</span> workbox.cacheableResponse.Plugin(&#123;</span><br><span class="line">        statuses: [<span class="number">0</span>, <span class="number">200</span>], <span class="comment">// One or more status codes that a Response can have and be considered cacheable.</span></span><br><span class="line">      &#125;),</span><br><span class="line">    ]</span><br><span class="line">  &#125;),</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>此时能看到 <code>https://developers.google.com/</code> 域名下的资源也被缓存了：</p><img src="/2018/02/workbox/co1.png" title="强制跨域 CacheFirst"><p>具体的 <a href="https://csbun.github.io/workbox-examples/workbox-cross-origin/index.html">Demo</a> 和 <a href="https://github.com/csbun/workbox-examples/tree/master/workbox-cross-origin" target="_blank" rel="noopener">源码</a></p><h2><span id="cli-工具">CLI 工具</span></h2><p>细心的小朋友一定发现了，上面的 <code>routing</code> 需要第三次访问才能真正从 Cache 中将缓存返回（或者支持离线），有没有办法将这个时间提前到第二次呢？这里，我们直接用 CLI 工具来解决这个问题。</p><p>当作为命令行工具时，Workbox 有 3 个主要的命令：</p><ul><li><code>workbox wizard</code> 生成配置文件 <em>workbox-config.js</em>；</li><li><code>workbox generateSW</code> 生成 prefetch 的 ServiceWorker JS 文件（依赖 <em>workbox-config.js</em>）；</li><li><code>workbox injectManifest</code> 将 prefetch 代码注入到指定的 JS 文件（依赖 <em>workbox-config.js</em>）；</li></ul><h3><span id="generatesw">generateSW</span></h3><p>首先修改配置文件 <em>workbox-config.js</em> 如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="string">"globDirectory"</span>: <span class="string">"./"</span>,        <span class="comment">// 匹配根目录</span></span><br><span class="line">  <span class="string">"globPatterns"</span>: [             <span class="comment">// 匹配的文件</span></span><br><span class="line">    <span class="string">"**/*.&#123;css,png,html,js&#125;"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"globIgnores"</span>: [              <span class="comment">// 忽略的文件</span></span><br><span class="line">    <span class="string">"build/**"</span>,</span><br><span class="line">    <span class="string">"workbox-config.js"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"swDest"</span>: <span class="string">"build.sw.js"</span>       <span class="comment">// 目标输出</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>运行 <code>workbox generateSW</code> 我们即可在 <em>build.sw.js</em> 中看到类似的内容：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">importScripts(<span class="string">"https://storage.googleapis.com/workbox-cdn/releases/3.0.0-beta.1/workbox-sw.js"</span>);</span><br><span class="line"></span><br><span class="line">self.__precacheManifest = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"css/style.css"</span>,</span><br><span class="line">    <span class="string">"revision"</span>: <span class="string">"835ba5c376a3f48dba17d3a9dc152fc3"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"js/index.js"</span>,</span><br><span class="line">    <span class="string">"revision"</span>: <span class="string">"589daa65882023b238e57abbb6caa643"</span></span><br><span class="line">  &#125;</span><br><span class="line">].concat(self.__precacheManifest || []);</span><br><span class="line">workbox.precaching.suppressWarnings();</span><br><span class="line">workbox.precaching.precacheAndRoute(self.__precacheManifest, &#123;&#125;);</span><br></pre></td></tr></table></figure><p>从方法名我们可以猜测出，将 <code>__precacheManifest</code> 列表中的文件（即配置中 <code>globPatterns</code> 匹配的文件）预加载下来，下次拦截到即从 Cache 中返回。详情可以查看 <a href="https://developers.google.com/web/tools/workbox/reference-docs/v3.0.0-alpha.5/workbox.precaching" target="_blank" rel="noopener">precaching 接口文档</a>。</p><h3><span id="injectmanifest">injectManifest</span></h3><p>但是，很多时候，我们已经有一段 ServiceWorker 的逻辑，希望添加相关的 precaching 代码但不希望增加更多的 sw 文件。（另一方面，可能你的业务是在国内跑的，你的用户是访问不了 googleapis.com 的 CDN 文件，generateSW 生成的 importScripts 就没什么用了。）于是我需要在 <strong>原本的 sw 文件(<em>sw.tpl.js</em>)</strong> 中添加如下代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Workbox injectManifest</span></span><br><span class="line">importScripts(<span class="string">"https://storage.googleapis.com/workbox-cdn/releases/3.0.0-beta.1/workbox-sw.js"</span>);</span><br><span class="line">workbox.precaching.precacheAndRoute([]);</span><br><span class="line"><span class="comment">// Workbox injectManifest End</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 其他自定义 sw 内容</span></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>并修改 <em>workbox-config.js</em> (或通过 <code>workbox wizard --injectManifest</code> 生成)：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="string">"globDirectory"</span>: <span class="string">"./"</span>,</span><br><span class="line">  <span class="string">"globPatterns"</span>: [</span><br><span class="line">    <span class="string">"**/*.&#123;css,png,html,js&#125;"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"globIgnores"</span>: [</span><br><span class="line">    <span class="string">"build/**"</span>,</span><br><span class="line">    <span class="string">"workbox-config.js"</span>,</span><br><span class="line">    <span class="string">"js/sw.tpl.js"</span>              <span class="comment">// “原本的 sw 文件(sw.tpl.js)”</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"swDest"</span>: <span class="string">"build.sw.js"</span>,</span><br><span class="line">  <span class="comment">// 添加下面这行，指向 “原本的 sw 文件(sw.tpl.js)”</span></span><br><span class="line">  <span class="string">"swSrc"</span>: <span class="string">"./js/sw.tpl.js"</span>     <span class="comment">// 输入源</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>最后通过运行 <code>workbox injectManifest</code> 我们即可在 <em>build.sw.js</em> 中看到类似的内容：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Workbox injectManifest</span></span><br><span class="line">importScripts(<span class="string">"https://storage.googleapis.com/workbox-cdn/releases/3.0.0-beta.1/workbox-sw.js"</span>);</span><br><span class="line">workbox.precaching.precacheAndRoute([</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"css/style.css"</span>,</span><br><span class="line">    <span class="string">"revision"</span>: <span class="string">"835ba5c376a3f48dba17d3a9dc152fc3"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"js/sw.tpl.js"</span>,</span><br><span class="line">    <span class="string">"revision"</span>: <span class="string">"acc39fc40b04d67b8403e7347d32f43b"</span></span><br><span class="line">  &#125;</span><br><span class="line">]);</span><br><span class="line"><span class="comment">// Workbox injectManifest End</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 其他自定义 sw 内容</span></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>再次进入页面看看效果，第一次访问，已经将全部资源 cache 下来了：</p><img src="/2018/02/workbox/cli1.png" title="第一次访问全部进行 Cache"><p>第二次访问，资源已经全部从 Service Worker 中返回，做到完全离线：</p><img src="/2018/02/workbox/cli2.png" title="第二次访问 Web 完全离线"><p>具体 <a href="https://csbun.github.io/workbox-examples/workbox-using-cli/index.html">Demo</a> 和 <a href="https://github.com/csbun/workbox-examples/tree/master/workbox-using-cli" target="_blank" rel="noopener">原码</a>。</p><h2><span id="配合-webpack-使用">配合 Webpack 使用</span></h2><p>很多时候，项目是通过 webpack 构建的，于是我们期望在构建过程中，可以将所用到的静态资源进行预加载。如下有个简单的例子：</p><figure class="highlight javascript"><figcaption><span>index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 业务代码</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'../css/style.css'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> elImg = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">elImg.src = <span class="built_in">require</span>(<span class="string">'../images/icon-48.png'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.body.appendChild(elImg);</span><br></pre></td></tr></table></figure><p>因此我们至少有 3 个静态资源：</p><ul><li><em>index.js</em> （上述的 js 业务代码）</li><li><em>style.css</em>使用 （<code>mini-css-extract-plugin</code>）</li><li><em>icon-48.png</em> （使用 <code>file-loader</code>）</li></ul><p>于是我们在 <em>webpack.config.js</em> 中添加 <code>workbox-webpack-plugin</code>，这里我们不再需要 <em>workbox-config.js</em> 了：</p><figure class="highlight javascript"><figcaption><span>webpack.config.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> workboxPlugin = <span class="built_in">require</span>(<span class="string">'workbox-webpack-plugin'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">new</span> workboxPlugin.GenerateSW(&#123;</span><br><span class="line">      swDest: <span class="string">'build.sw.js'</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>在输出目录，我们可以看到除了原有的静态资源之外，增加了两个文件：</p><ul><li><em>build.sw.js</em>，我们指定的 Service Worker 文件</li></ul><figure class="highlight javascript"><figcaption><span>build.sw.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">importScripts(<span class="string">"https://storage.googleapis.com/workbox-cdn/releases/3.0.0/workbox-sw.js"</span>);</span><br><span class="line"></span><br><span class="line">importScripts(</span><br><span class="line">  <span class="string">"precache-manifest.d82f19f6bd4f26897690a1e0456d5844.js"</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">self.__precacheManifest = [].concat(self.__precacheManifest || []);</span><br><span class="line">workbox.precaching.suppressWarnings();</span><br><span class="line">workbox.precaching.precacheAndRoute(self.__precacheManifest, &#123;&#125;);</span><br></pre></td></tr></table></figure><ul><li><em>precache-manifest.hash.js</em>，上述 sw.js 引用的资源列表文件</li></ul><figure class="highlight javascript"><figcaption><span>precache-manifest.hash.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">self.__precacheManifest = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"revision"</span>: <span class="string">"1cedcdd1e2143f97cfaf"</span>,</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"main.1cedc.css"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"revision"</span>: <span class="string">"17c19a267f8873556a2ae3981095789d"</span>,</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"index.html"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"revision"</span>: <span class="string">"1cedcdd1e2143f97cfaf"</span>,</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"index.1cedc.js"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"7186d37d76d392b0e8ad935d7829f6fb.png"</span></span><br><span class="line">  &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure><p>其实这个动作其实和 CLI 的 <code>workbox generateSW</code> 非常相似，<code>workboxPlugin</code> 也有另一个 API 为 <code>workboxPlugin.InjectManifest({ swSrc, swDest })</code>，与命令行的 <code>workbox injectManifest</code> 对应，这里不再累述，更多细节可以看 <a href="https://developers.google.com/web/tools/workbox/guides/codelabs/webpack" target="_blank" rel="noopener">官方介绍</a>。</p><h3><span id="使用本地-workbox-swjs">使用本地 workbox-sw.js</span></h3><p>回到之前说到的 Google CND 的问题，我们的确期望 <em>workbox-sw.js</em> 部署在自己的服务器会更好，看看 <a href="https://developers.google.com/web/tools/workbox/modules/workbox-webpack-plugin#configuration" target="_blank" rel="noopener">配置文档</a> 还真能这么搞：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> workboxPlugin.GenerateSW(&#123;</span><br><span class="line">  swDest: <span class="string">'build.sw.js'</span>,</span><br><span class="line">  <span class="comment">// workbox-sw.js 部署本地服务器</span></span><br><span class="line">  importWorkboxFrom: <span class="string">'local'</span>,</span><br><span class="line">  <span class="comment">// （预加载）忽略某些文件</span></span><br><span class="line">  exclude: [</span><br><span class="line">    /index\.html$/,</span><br><span class="line">  ],</span><br><span class="line">&#125;),</span><br></pre></td></tr></table></figure><p>结果会是，<code>dist</code> 输出会变成这样：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">dist</span><br><span class="line">├── <span class="number">7186</span>d37d76d392b0e8ad935d7829f6fb.png</span><br><span class="line">├── build<span class="selector-class">.sw</span><span class="selector-class">.js</span></span><br><span class="line">├── index.<span class="number">1</span>cedc.js</span><br><span class="line">├── index.html</span><br><span class="line">├── main.<span class="number">1</span>cedc.css</span><br><span class="line">├── precache-manifest.<span class="number">12198</span>be40483126171d738fb87e6043e.js</span><br><span class="line">└── workbox-v3.<span class="number">0.0</span></span><br><span class="line">    ├── ...</span><br><span class="line">    ├── workbox-sw.js</span><br><span class="line">    └── workbox-sw<span class="selector-class">.js</span><span class="selector-class">.map</span></span><br></pre></td></tr></table></figure><p>目录下会增加一个 <em>workbox-v3.0.0</em> 文件夹，<em>build.sw.js</em> 将应用其中的文件。</p><h3><span id="动态更新">动态更新</span></h3><p>配合最开始提及的缓存策略，一切都可以通过插件配置生成：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> workboxPlugin.GenerateSW(&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// 动态更新缓存</span></span><br><span class="line">  runtimeCaching: [&#123;</span><br><span class="line">    urlPattern: <span class="regexp">/index\.html/</span>,</span><br><span class="line">    handler: <span class="string">'networkFirst'</span>,</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    urlPattern: <span class="regexp">/\.(js|css|png|jpg|gif)/</span>,</span><br><span class="line">    handler: <span class="string">'staleWhileRevalidate'</span>,</span><br><span class="line">  &#125;],</span><br><span class="line">&#125;),</span><br></pre></td></tr></table></figure><p>生成的如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">importScripts(<span class="string">"workbox-v3.0.0/workbox-sw.js"</span>);</span><br><span class="line">workbox.setConfig(&#123;<span class="attr">modulePathPrefix</span>: <span class="string">"workbox-v3.0.0"</span>&#125;);</span><br><span class="line"></span><br><span class="line">importScripts(</span><br><span class="line">  <span class="string">"precache-manifest.12198be40483126171d738fb87e6043e.js"</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">self.__precacheManifest = [].concat(self.__precacheManifest || []);</span><br><span class="line">workbox.precaching.suppressWarnings();</span><br><span class="line">workbox.precaching.precacheAndRoute(self.__precacheManifest, &#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 增加了以下内容</span></span><br><span class="line">workbox.routing.registerRoute(<span class="regexp">/index\.html/</span>, workbox.strategies.networkFirst(), <span class="string">'GET'</span>);</span><br><span class="line">workbox.routing.registerRoute(<span class="regexp">/\.(js|css|png|jpg|gif)/</span>, workbox.strategies.staleWhileRevalidate(), <span class="string">'GET'</span>);</span><br></pre></td></tr></table></figure><p>访问页面看看效果，第一次访问，资源全部预加载完毕。</p><img src="/2018/02/workbox/wp1.png" title="第一次访问进行 Cache"><p>第二次访问，被标识为 <code>exclude</code> 的 <code>index.html</code> 也被缓存到 <code>workbox-runtime</code> 的 Cache Storage 下面（这里这么做只是为了功能测试），其他资源按 <code>staleWhileRevalidate</code> 的规则直接从 Cache 返回。</p><img src="/2018/02/workbox/wp2.png" title="第二次访问"><p>之后离线都能访问了。具体 <a href="https://csbun.github.io/workbox-examples/workbox-using-webpack/dist/index.html">Demo</a> 和 <a href="https://github.com/csbun/workbox-examples/tree/master/workbox-using-webpack" target="_blank" rel="noopener">原码</a>。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://developers.google.com/web/tools/workbox/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Workbox&lt;/a&gt; · JavaScript Libraries for adding offline support to web apps.&lt;/p&gt;
&lt;p&gt;一个为网页应用添加离线支持的 JavaScript 库。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;本文内容基于 &lt;a href=&quot;mailto:Workbox@3.0.0&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Workbox@3.0.0&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="ServiceWorker" scheme="http://csbun.github.io/blog/tags/ServiceWorker/"/>
    
      <category term="Workbox" scheme="http://csbun.github.io/blog/tags/Workbox/"/>
    
      <category term="PWA" scheme="http://csbun.github.io/blog/tags/PWA/"/>
    
  </entry>
  
  <entry>
    <title>Preact 源码解析 —— h/createElement</title>
    <link href="http://csbun.github.io/blog/2018/01/preact-code-h/"/>
    <id>http://csbun.github.io/blog/2018/01/preact-code-h/</id>
    <published>2018-01-25T12:04:25.000Z</published>
    <updated>2020-11-03T11:52:46.476Z</updated>
    
    <content type="html"><![CDATA[<p>Preact 中的 <a href="https://github.com/developit/preact/blob/master/src/h.js" target="_blank" rel="noopener"><code>h</code> 方法</a>，相当于 React 中的 <code>createElement</code>，在 JSX 中用于生产 VNode 的方法。</p><a id="more"></a><h2><span id="tldr">TL;DR;</span></h2><p>请直接看最后，<a href="#带注释的源码">带注释的源码</a>。</p><h2><span id="什么是-jsx">什么是 JSX</span></h2><p>按照源码指示的<a href="https://jasonformat.com/wtf-is-jsx/" target="_blank" rel="noopener">这篇文章</a>，这有一个最简单的例子：</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** @jsx h */</span></span><br><span class="line"><span class="keyword">let</span> foo = <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"foo"</span>&gt;</span>Hello!<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br></pre></td></tr></table></figure><p>Babel 等工具可以将其转化为</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = h(<span class="string">'div'</span>, &#123;<span class="attr">id</span>:<span class="string">"foo"</span>&#125;, <span class="string">'Hello!'</span>);</span><br></pre></td></tr></table></figure><p>至于为什么叫 <code>h</code>，是因为这个 idea 最初来自 <a href="https://github.com/hyperhype/hyperscript" target="_blank" rel="noopener">hyperscript</a> (“hyper<del>text</del>“ + “<del>java</del>script”)。</p><h2><span id="什么是-vnode">什么是 VNode</span></h2><p>字面解析，VNode = “V<del>irtual</del>“ + “Node”，虚拟 DOM 节点，大概会是以下这么一个结构：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  nodeName: <span class="string">"div"</span>,</span><br><span class="line">  attributes: &#123;</span><br><span class="line">    <span class="string">"id"</span>: <span class="string">"foo"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  children: [<span class="string">"Hello!"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看起来很简单嘛，3行代码实现 <code>h</code> 方法：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">h</span>(<span class="params">nodeName, attributes, ...args</span>) </span>&#123;  </span><br><span class="line">      <span class="keyword">let</span> children = args.length ? [].concat(...args) : <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">return</span> &#123; nodeName, attributes, children &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是，实时当然没有那么简单。</p><h2><span id="源码解析">源码解析</span></h2><p>光看代码有点难解释，我们先来一个尽可能复杂的简单例子：</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** @jsx h */</span></span><br><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">'preact'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getItem</span>(<span class="params">text, idx</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;</span>`<span class="attr">p</span>$&#123;<span class="attr">idx</span>&#125;`&#125;&gt;</span>&#123;text&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Section</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; children, ...rest &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">section</span> &#123;<span class="attr">...rest</span>&#125;&gt;</span>&#123;children&#125;<span class="tag">&lt;/<span class="name">section</span>&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> node = <span class="xml"><span class="tag">&lt;<span class="name">Section</span> <span class="attr">id</span>=<span class="string">"root"</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">color:</span> '<span class="attr">red</span>' &#125;&#125;&gt;</span></span></span><br><span class="line">  &lt;ul id="list"&gt;</span><br><span class="line">    &#123; [ 'Hello', 'World' ].map(getItem) &#125;</span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line">  &lt;div id="text"&gt;</span><br><span class="line">    number: &#123;18&#125;;</span><br><span class="line">    string: &#123;'str'&#125;;</span><br><span class="line">    boolean: &#123;true&#125;;</span><br><span class="line">    &#123;/* comment */&#125;</span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">Section</span>&gt;</span></span>;</span><br></pre></td></tr></table></figure><p>通过 Babel 即可转换为 js 内容：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> _preact = <span class="built_in">require</span>(<span class="string">'preact'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getItem</span>(<span class="params">text, idx</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> h(</span><br><span class="line">    <span class="string">'li'</span>,</span><br><span class="line">    &#123; <span class="attr">key</span>: <span class="string">'p'</span> + idx &#125;,</span><br><span class="line">    text</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> Section = <span class="function"><span class="keyword">function</span> (<span class="params">_Component</span>) </span>&#123;</span><br><span class="line">  _inherits(Section, _Component);</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Section</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">/* 这里简化了部分代码 */</span></span><br><span class="line">  &#125;</span><br><span class="line">  _createClass(Section, [<span class="comment">/* 这里简化了部分代码 */</span>]);</span><br><span class="line">  <span class="keyword">return</span> Section;</span><br><span class="line">&#125;(_preact.Component);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> node = h(</span><br><span class="line">  Section,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="string">'root'</span>, <span class="attr">style</span>: &#123; <span class="attr">color</span>: <span class="string">'red'</span> &#125; &#125;,</span><br><span class="line">  h(</span><br><span class="line">    <span class="string">'ul'</span>,</span><br><span class="line">    &#123; <span class="attr">id</span>: <span class="string">'list'</span> &#125;,</span><br><span class="line">    [<span class="string">'Hello'</span>, <span class="string">'World'</span>].map(getItem)</span><br><span class="line">  ),</span><br><span class="line">  h(</span><br><span class="line">    <span class="string">'div'</span>,</span><br><span class="line">    &#123; <span class="attr">id</span>: <span class="string">'text'</span> &#125;,</span><br><span class="line">    <span class="string">'number: '</span>,</span><br><span class="line">    <span class="number">18</span>,</span><br><span class="line">    <span class="string">'; string: '</span>,</span><br><span class="line">    <span class="string">'str'</span>,</span><br><span class="line">    <span class="string">'; boolean: '</span>,</span><br><span class="line">    <span class="literal">true</span>,</span><br><span class="line">    <span class="string">';'</span></span><br><span class="line">  )</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>为了更加直观，我们可以将 <code>Section</code> 和 <code>.map(getItem)</code> 的代码执行结果获取出来，得到：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Section = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="comment">/* ... */</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> node = h(</span><br><span class="line">  Section,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="string">'root'</span>, <span class="attr">style</span>: &#123; <span class="attr">color</span>: <span class="string">'red'</span> &#125; &#125;,</span><br><span class="line">  h(</span><br><span class="line">    <span class="string">'ul'</span>,</span><br><span class="line">    &#123; <span class="attr">id</span>: <span class="string">'list'</span> &#125;,</span><br><span class="line">    [ h(<span class="string">'li'</span>, &#123; <span class="attr">key</span>: <span class="string">'p0'</span> &#125;, <span class="string">'Hello'</span>), h(<span class="string">'li'</span>, &#123; <span class="attr">key</span>: <span class="string">'p1'</span> &#125;, <span class="string">'World'</span>) ]</span><br><span class="line">  ),</span><br><span class="line">  h(</span><br><span class="line">    <span class="string">'div'</span>,</span><br><span class="line">    &#123; <span class="attr">id</span>: <span class="string">'text'</span> &#125;,</span><br><span class="line">    <span class="string">'number: '</span>,</span><br><span class="line">    <span class="number">18</span>,</span><br><span class="line">    <span class="string">'; string: '</span>,</span><br><span class="line">    <span class="string">'str'</span>,</span><br><span class="line">    <span class="string">'; boolean: '</span>,</span><br><span class="line">    <span class="literal">true</span>,</span><br><span class="line">    <span class="string">';'</span></span><br><span class="line">  )</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>下面我们将看看，这里面的 5 个 <code>h()</code> 或做些什么。为了避免源码解析中有任何差异，我这里参照的是 <a href="mailto:Preact@8.2.7" target="_blank" rel="noopener">Preact@8.2.7</a> 的<a href="https://github.com/developit/preact/blob/17cc8deddd3d4e592685dfa42e832f6e8d2cb795/src/h.js" target="_blank" rel="noopener">代码</a>：</p><h3><span id="单个-child-的简单-vnode">单个 Child 的简单 VNode</span></h3><p>我们首先处理两个最简单的 <code>&lt;li&gt;</code>： <code>h(&#39;li&#39;, { key: &#39;p0&#39; }, &#39;Hello&#39;)</code>。首先，可以看到 <a href="https://github.com/developit/preact/blob/17cc8deddd3d4e592685dfa42e832f6e8d2cb795/src/h.js#L39" target="_blank" rel="noopener">L39</a> 到 <a href="https://github.com/developit/preact/blob/17cc8deddd3d4e592685dfa42e832f6e8d2cb795/src/h.js#L45" target="_blank" rel="noopener">L45</a>，将第三个及以后的参数都作为 children 推入 stack，如果有 attributes.children，也推入 stack，并删除这个属性。于是，我们将得到：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stack = [ <span class="string">'Hello'</span> ];</span><br></pre></td></tr></table></figure><p>接下来开始通过 <code>while (stack.length)</code> 遍历这个数组，但实际上自有 <code>&#39;Hello&#39;</code> 这一个 <code>child</code>，且 <a href="https://github.com/developit/preact/blob/17cc8deddd3d4e592685dfa42e832f6e8d2cb795/src/h.js#L53" target="_blank" rel="noopener">L53</a> 到 <a href="https://github.com/developit/preact/blob/17cc8deddd3d4e592685dfa42e832f6e8d2cb795/src/h.js#L57" target="_blank" rel="noopener">L57</a> 判断 <code>simple</code> 为 <code>true</code>，所以我们在 <a href="https://github.com/developit/preact/blob/17cc8deddd3d4e592685dfa42e832f6e8d2cb795/src/h.js#L63" target="_blank" rel="noopener">L63</a> 得到：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">children = [ <span class="string">'Hello'</span> ];</span><br></pre></td></tr></table></figure><p>因此由 <a href="https://github.com/developit/preact/blob/17cc8deddd3d4e592685dfa42e832f6e8d2cb795/src/h.js#L73" target="_blank" rel="noopener">L73</a> 到 <a href="https://github.com/developit/preact/blob/17cc8deddd3d4e592685dfa42e832f6e8d2cb795/src/h.js#L77" target="_blank" rel="noopener">L77</a> 得到这个 VNode，更直观地，我们用一个 JSON 来记录：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  nodeName: <span class="string">'li'</span>,</span><br><span class="line">  children: [ <span class="string">'Hello'</span> ],</span><br><span class="line">  attributes: &#123; <span class="attr">key</span>: <span class="string">'p0'</span> &#125;,</span><br><span class="line">  key: <span class="string">'p0'</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="simple-child-优化">Simple Child 优化</span></h3><p>再看看 <code>h(&#39;div&#39;, { id: &#39;text&#39; }, ... }</code> 这部分，和上面的 <code>li</code> 差不多，(<code>{/* comment */}</code> 部分已经在 Babel 中被去除)，注意全部内容已经反序：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">stack = [</span><br><span class="line">  <span class="string">';'</span></span><br><span class="line">  <span class="literal">true</span>,</span><br><span class="line">  <span class="string">'; boolean: '</span>,</span><br><span class="line">  <span class="string">'str'</span>,</span><br><span class="line">  <span class="string">'; string: '</span>,</span><br><span class="line">  <span class="number">18</span>,</span><br><span class="line">  <span class="string">'number: '</span>,</span><br><span class="line">];</span><br></pre></td></tr></table></figure><p>而因为 <a href="https://github.com/developit/preact/blob/17cc8deddd3d4e592685dfa42e832f6e8d2cb795/src/h.js#L53" target="_blank" rel="noopener">L53</a> 到 <a href="https://github.com/developit/preact/blob/17cc8deddd3d4e592685dfa42e832f6e8d2cb795/src/h.js#L57" target="_blank" rel="noopener">L57</a> 判断 <code>simple</code> 一直为 <code>true</code>（因为 L51 和 L54，boolean 后面的 <code>true</code> 被转换成了 ‘’），所以 child 一直在 我们在 <a href="https://github.com/developit/preact/blob/17cc8deddd3d4e592685dfa42e832f6e8d2cb795/src/h.js#L60" target="_blank" rel="noopener">L60</a> 进行字符串拼接，最终得到：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  nodeName: <span class="string">'div'</span>,</span><br><span class="line">  children: [ <span class="string">'number: 18; string: str; boolean: ;'</span> ],</span><br><span class="line">  attributes: &#123; <span class="attr">id</span>: <span class="string">'text'</span> &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="数组-child-的优化">数组 Child 的优化</span></h3><p>回到刚刚构建好的两个 <code>&lt;li&gt;</code>，现在可以看看 <code>&lt;ul&gt;</code>，伪代码表示：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">h(</span><br><span class="line">  <span class="string">'ul'</span>,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="string">'list'</span> &#125;,</span><br><span class="line">  [ VNode(<span class="string">'p0'</span>), VNode(<span class="string">'p1'</span>) ] <span class="comment">// 这里是一个数组，不是两个分开的参数</span></span><br><span class="line">),</span><br></pre></td></tr></table></figure><p>在 <code>while</code> 之前得到的是：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stack = [ [ VNode(<span class="string">'p0'</span>), VNode(<span class="string">'p1'</span>) ] ];</span><br></pre></td></tr></table></figure><p>如果还是原本的套路，最终 children 也将会是一个“数组套数组”的结构，于是可以看到 <a href="https://github.com/developit/preact/blob/17cc8deddd3d4e592685dfa42e832f6e8d2cb795/src/h.js#L48" target="_blank" rel="noopener">L48</a> 将数组的内容再次拆开 push 进 stack。于是可以得到一个更好看的结果：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  nodeName: <span class="string">'ul'</span>,</span><br><span class="line">  children: [ VNode(<span class="string">'p0'</span>), VNode(<span class="string">'p1'</span>) ],</span><br><span class="line">  attributes: &#123; <span class="attr">id</span>: <span class="string">'list'</span> &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="自定义-component">自定义 Component</span></h3><p>最后一个 <code>h</code> 是最外层的 <code>&lt;Section&gt;</code>，这里有一个最大的差异在于， <code>nodeName = Section</code> 已经不是一个类似 <code>div</code> 一般的字符串，而是一个 <code>Component</code>，即为一个 <code>function</code>，在 <a href="https://github.com/developit/preact/blob/17cc8deddd3d4e592685dfa42e832f6e8d2cb795/src/h.js#L53" target="_blank" rel="noopener">L53</a> 中可以看到这类的 nodeName 是 <strong>不 simple</strong> 的，于是直接会把说有 child push 进 children 里面。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  nodeName: Section, <span class="comment">// Section is a function</span></span><br><span class="line">  children: [ VNode(<span class="string">'ul#list'</span>), VNode(<span class="string">'div#text'</span>) ],</span><br><span class="line">  attributes: &#123; <span class="attr">id</span>: <span class="string">'root'</span>, <span class="attr">style</span>: &#123; <span class="attr">color</span>: <span class="string">'red'</span> &#125; &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意，因为 <strong>不 simple</strong>，即使 stack 里有连串的 string 或 number，也不会做拼接：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">h(</span><br><span class="line">  Section,</span><br><span class="line">  <span class="literal">null</span>,</span><br><span class="line">  <span class="string">'string: '</span>,</span><br><span class="line">  <span class="string">'str'</span>,</span><br><span class="line">  <span class="string">';'</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">// =&gt;</span></span><br><span class="line">&#123;</span><br><span class="line">  nodeName: Section, <span class="comment">// Section is a function</span></span><br><span class="line">  children: [ <span class="string">'string: '</span>, <span class="string">'str'</span>, <span class="string">';'</span> ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="最终结果">最终结果</span></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  nodeName: Section, <span class="comment">// Section is a function</span></span><br><span class="line">  attributes: &#123; <span class="attr">id</span>: <span class="string">'root'</span>, <span class="attr">style</span>: &#123; <span class="attr">color</span>: <span class="string">'red'</span> &#125; &#125;,</span><br><span class="line">  children: [&#123;</span><br><span class="line">    nodeName: <span class="string">'ul'</span>,</span><br><span class="line">    attributes: &#123; <span class="attr">id</span>: <span class="string">'list'</span> &#125;,</span><br><span class="line">    children: [&#123;</span><br><span class="line">      nodeName: <span class="string">'li'</span>,</span><br><span class="line">      key: <span class="string">'p0'</span>,</span><br><span class="line">      attributes: &#123; <span class="attr">key</span>: <span class="string">'p0'</span> &#125;,</span><br><span class="line">      children: [ <span class="string">'Hello'</span> ],</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      nodeName: <span class="string">'li'</span>,</span><br><span class="line">      key: <span class="string">'p1'</span>,</span><br><span class="line">      attributes: &#123; <span class="attr">key</span>: <span class="string">'p1'</span> &#125;,</span><br><span class="line">      children: [ <span class="string">'World'</span> ],</span><br><span class="line">    &#125;],</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    nodeName: <span class="string">'div'</span>,</span><br><span class="line">    children: [ <span class="string">'number: 18; string: str; boolean: ;'</span> ],</span><br><span class="line">    attributes: &#123; <span class="attr">id</span>: <span class="string">'text'</span> &#125;,</span><br><span class="line">  &#125;],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="带注释的源码">带注释的源码</span></h2><p>最后将上面的全部内容写成注释，放到源码中：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; VNode &#125; <span class="keyword">from</span> <span class="string">'./vnode'</span>;</span><br><span class="line"><span class="keyword">import</span> options <span class="keyword">from</span> <span class="string">'./options'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 问题点：为了防止公共变量污染，放到 h 方法里面会不会更好？还是说是性能考虑？</span></span><br><span class="line"><span class="keyword">const</span> stack = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> EMPTY_CHILDREN = [];</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * JSX/hyperscript reviver.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">h</span>(<span class="params">nodeName, attributes</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 问题点：children=EMPTY_CHILDREN 为何不直接在这里直接初始化 children=[]</span></span><br><span class="line">  <span class="comment">// 那下面也可以减少一次判断 `else if (children===EMPTY_CHILDREN)`</span></span><br><span class="line">  <span class="keyword">let</span> children=EMPTY_CHILDREN, lastSimple, child, simple, i;</span><br><span class="line">  <span class="comment">// 首先将 children 反序推入 stack</span></span><br><span class="line">  <span class="keyword">for</span> (i=<span class="built_in">arguments</span>.length; i-- &gt; <span class="number">2</span>; ) &#123;</span><br><span class="line">    stack.push(<span class="built_in">arguments</span>[i]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 如果有 attributes.children，也推入 stack，并删除这个属性</span></span><br><span class="line">  <span class="keyword">if</span> (attributes &amp;&amp; attributes.children!=<span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!stack.length) stack.push(attributes.children);</span><br><span class="line">    <span class="keyword">delete</span> attributes.children;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 循环遍历 stack/children</span></span><br><span class="line">  <span class="keyword">while</span> (stack.length) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((child = stack.pop()) &amp;&amp; child.pop!==<span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="comment">// 如果 child 本身也是个数组（也可能来自上面的 attributes.children），那也将其反序 push 到 stack 中（之后在 while 又会被 pop 出来）</span></span><br><span class="line">      <span class="keyword">for</span> (i=child.length; i--; ) stack.push(child[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// boolean 值转为 null？</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> child===<span class="string">'boolean'</span>) child = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 当 nodeName 不是函数（自定义的 Component），且 child 是 null、number、string 时视为 simple，且全部转为 string</span></span><br><span class="line">      <span class="keyword">if</span> ((simple = <span class="keyword">typeof</span> nodeName!==<span class="string">'function'</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (child==<span class="literal">null</span>) child = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> child===<span class="string">'number'</span>) child = <span class="built_in">String</span>(child);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> child!==<span class="string">'string'</span>) simple = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (simple &amp;&amp; lastSimple) &#123;</span><br><span class="line">        <span class="comment">// 如果连续两个 child 都是 simple 的，那自接将当期 child 字符串拼接到上一个后面</span></span><br><span class="line">        children[children.length<span class="number">-1</span>] += child;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (children===EMPTY_CHILDREN) &#123;</span><br><span class="line">        <span class="comment">// 第一个 child</span></span><br><span class="line">        children = [child];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 其他不 simple 的 child</span></span><br><span class="line">        children.push(child);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      lastSimple = simple;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建 VNode</span></span><br><span class="line">  <span class="keyword">let</span> p = <span class="keyword">new</span> VNode();</span><br><span class="line">  p.nodeName = nodeName;</span><br><span class="line">  p.children = children;</span><br><span class="line">  p.attributes = attributes==<span class="literal">null</span> ? <span class="literal">undefined</span> : attributes;</span><br><span class="line">  p.key = attributes==<span class="literal">null</span> ? <span class="literal">undefined</span> : attributes.key;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if a "vnode hook" is defined, pass every created VNode to it</span></span><br><span class="line">  <span class="keyword">if</span> (options.vnode!==<span class="literal">undefined</span>) options.vnode(p);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Preact 中的 &lt;a href=&quot;https://github.com/developit/preact/blob/master/src/h.js&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;code&gt;h&lt;/code&gt; 方法&lt;/a&gt;，相当于 React 中的 &lt;code&gt;createElement&lt;/code&gt;，在 JSX 中用于生产 VNode 的方法。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Preact" scheme="http://csbun.github.io/blog/tags/Preact/"/>
    
  </entry>
  
  <entry>
    <title>译文：Puppeteer 与 Chrome Headless —— 从入门到爬虫</title>
    <link href="http://csbun.github.io/blog/2017/09/puppeteer/"/>
    <id>http://csbun.github.io/blog/2017/09/puppeteer/</id>
    <published>2017-08-31T16:14:09.000Z</published>
    <updated>2020-11-03T11:52:46.476Z</updated>
    
    <content type="html"><![CDATA[<p><strong>这里是 <a href="https://github.com/emadehsan/thal" target="_blank" rel="noopener">GitHub 英文原文</a></strong> / <strong><a href="https://medium.com/@e_mad_ehsan/getting-started-with-puppeteer-and-chrome-headless-for-web-scrapping-6bf5979dee3e" target="_blank" rel="noopener">Medium 英文原文</a></strong></p><p><img src="https://github.com/csbun/thal/raw/master/media/desertious.jpg" alt="A Desert in painters perception"></p><p><a href="https://github.com/GoogleChrome/puppeteer" target="_blank" rel="noopener"><code>Puppeteer</code></a> 是 Google Chrome 团队官方的无界面（Headless）Chrome 工具。正因为这个官方声明，许多业内自动化测试库都已经停止维护，包括 <strong><a href="http://phantomjs.org/" target="_blank" rel="noopener">PhantomJS</a></strong>。<strong><a href="https://addons.mozilla.org/en-US/firefox/addon/selenium-ide/" target="_blank" rel="noopener">Selenium IDE for Firefox</a></strong> 项目也因为缺乏维护者而终止。</p><blockquote><p>译者注：关于 PhantomJS 和 Selenium IDE for Firefox 停止维护并没有找到相关的公告，但这两个项目的确已经都超过 2 年没有发布新版本了。但另一个今年 5 月才开启的项目 <a href="https://github.com/graphcool/chromeless" target="_blank" rel="noopener">Chromeless</a> 目前在 Github 上已经超过 1w star，目前还非常活跃。</p></blockquote><p>Chrome 作为浏览器市场的领头羊，<strong>Chrome Headless</strong> 必将成为 web 应用 <strong>自动化测试</strong> 的行业标杆。所以我整合了这份如何利用 <strong>Chrome Headless</strong> 做 <code>网页爬虫</code> 的入门指南。</p><a id="more"></a><h2><span id="tldr">TL;DR</span></h2><p>本文我们将使用 <code>Chrome Headless</code>, <code>Puppeteer</code>, <code>Node</code> 和 <code>MongoDB</code>，爬取 GitHub，登录并提取和保存用户的邮箱。不用担心 GitHub 的频率限制，本文会基于 Chrome Headless 和 Node 给你相应的策略。同时，请时刻关注 <code>Puppeteer</code> 的<a href="https://github.com/GoogleChrome/puppeteer/blob/master/docs/api.md" target="_blank" rel="noopener">文档</a>，因为该项目仍然处于开发中，API 并不是很稳定。</p><h2><span id="开始">开始</span></h2><p>开始之前，我们需要安装以下工具。点击他们的官网然后安装吧。</p><ul><li><a href="https://nodejs.org" target="_blank" rel="noopener">Node 8.+</a></li><li><a href="http://mongodb.com" target="_blank" rel="noopener">MongoDB</a></li></ul><blockquote><p>译者注：Puppeteer 要求使用 Node v6.4.0，但因为文中大量使用 <code>async/await</code>，需要 Node v7.6.0 或以上。</p></blockquote><h2><span id="初始化项目">初始化项目</span></h2><p>项目都是以创建文件夹开始。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir thal</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> thal</span></span><br></pre></td></tr></table></figure><p>初始化 NPM，填入一些必要的信息。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm init</span></span><br></pre></td></tr></table></figure><p>安装 <code>Puppeteer</code>。由于 <code>Puppeteer</code> 并不是稳定的版本而且每天都在更新，所以如果你想要最新的功能可以直接通过 GitHub 的<a href="https://github.com/GoogleChrome/puppeteer" target="_blank" rel="noopener">仓库</a>安装。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm i --save puppeteer</span></span><br></pre></td></tr></table></figure></p><p>Puppeteer 包含了自己的 chrome / chromium 用以确保可以无界面地工作。因此每当你安装/更新 puppeteer 的时候，他都会下载指定的 chrome 版本。</p><h2><span id="编码">编码</span></h2><p>我们将从页面截图开始，这是他们的文档中的代码。</p><h3><span id="页面截图">页面截图</span></h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch();</span><br><span class="line">  <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> page.goto(<span class="string">'https://github.com'</span>);</span><br><span class="line">  <span class="keyword">await</span> page.screenshot(&#123;<span class="attr">path</span>: <span class="string">'screenshots/github.png'</span>&#125;);</span><br><span class="line"></span><br><span class="line">  browser.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run();</span><br></pre></td></tr></table></figure><p>如果您第一次使用 <code>Node</code> 7 或 8，那你可能不太熟悉 <code>async</code> 和 <code>await</code> 关键字。简单地说，一个 <code>async</code> 函数返回一个 Promise，当 Promise 完成时会返回你所定义的内容。当你需要像同步函数那样调用时，需要使用 <code>await</code>。</p><p>保存上面的代码为 <code>index.js</code> 文件到项目目录里。并运行</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">node</span> <span class="title">index</span>.js</span><br></pre></td></tr></table></figure><p>这样截图就会被保存到 <code>screenshots/</code> 目录下。</p><p><img src="https://github.com/csbun/thal/raw/master/screenshots/github.png" alt="GitHub"></p><h3><span id="登录-github">登录 GitHub</span></h3><p>如果你在 GitHub 上搜索 <em>john</em>，然后点击 Users 标签，你将看到一个带有姓名信息的用户列表。</p><p><img src="https://github.com/csbun/thal/raw/master/media/all-johns.png" alt="Johns"></p><p>有些用户设置了他们的邮箱是公开可见的，但有些用户没有。但你一个邮箱都看不到的原因是没有登录。下面，让我们利用 <a href="https://github.com/GoogleChrome/puppeteer/blob/master/docs/api.md" target="_blank" rel="noopener">Puppeteer 文档</a> 来登录吧~</p><blockquote><p>译者注：上图是登录后看到的效果</p></blockquote><p>在项目根目录添加一个 <code>creds.js</code> 文件。我强烈建议用一个没什么卵用的邮箱来注册一个新 GitHub 账号，不然 GitHub 可能会封掉你的常用账号。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  username: <span class="string">'&lt;GITHUB_USERNAME&gt;'</span>,</span><br><span class="line">  password: <span class="string">'&lt;GITHUB_PASSWORD&gt;'</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>同时添加一个 <code>.gitignore</code> 文件，输入以下内容：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node_modules/</span><br><span class="line">creds.js</span><br></pre></td></tr></table></figure><h4><span id="以非无界面non-headless模式启动">以非无界面（non headless）模式启动</span></h4><p>在调用 Puppeteer 的 <code>launch</code> 方法的时候传入参数对象中带有 <code>headless: false</code>，即可启动其 GUI 界面，进行可视化调试。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch(&#123;</span><br><span class="line">  headless: <span class="literal">false</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>跳转到登录页</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> page.goto(<span class="string">'https://github.com/login'</span>);</span><br></pre></td></tr></table></figure><p>在浏览器中打开 <a href="https://github.com/login" target="_blank" rel="noopener">https://github.com/login</a>。右击 <strong>Username or email address</strong> 下方的输入框（译者注：并选择 <strong>Inspect</strong>）。在开发者工具中，右击被高亮的代码选择 <code>Copy</code> &gt; <code>Copy selector</code>。</p><p><img src="https://github.com/csbun/thal/raw/master/media/copy-selector.png" alt="Copy dom element selector"></p><p>把复制出来的值放到以下常量中</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> USERNAME_SELECTOR = <span class="string">'#login_field'</span>; <span class="comment">// "#login_field" 就是被复制出来的值</span></span><br></pre></td></tr></table></figure><p>重复上面的步骤，吧 <strong>Password</strong> 输入框和 <strong>Sign in</strong> 按钮的值也填好，将得到下面内容：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dom element selectors</span></span><br><span class="line"><span class="keyword">const</span> USERNAME_SELECTOR = <span class="string">'#login_field'</span>;</span><br><span class="line"><span class="keyword">const</span> PASSWORD_SELECTOR = <span class="string">'#password'</span>;</span><br><span class="line"><span class="keyword">const</span> BUTTON_SELECTOR = <span class="string">'#login &gt; form &gt; div.auth-form-body.mt-3 &gt; input.btn.btn-primary.btn-block'</span>;</span><br></pre></td></tr></table></figure><h4><span id="登录">登录</span></h4><p>Puppeteer 提供了 <code>click</code> 方法用来点击 DOM 元素和 <code>type</code> 方法来输入内容。下面我们将填写验证信息并点击登录然后坐等跳转。</p><p>首先，需要引入 <code>creds.js</code> 文件。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> CREDS = <span class="built_in">require</span>(<span class="string">'./creds'</span>);</span><br></pre></td></tr></table></figure><p>然后</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> page.click(USERNAME_SELECTOR);</span><br><span class="line"><span class="keyword">await</span> page.type(CREDS.username);</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> page.click(PASSWORD_SELECTOR);</span><br><span class="line"><span class="keyword">await</span> page.type(CREDS.password);</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> page.click(BUTTON_SELECTOR);</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> page.waitForNavigation();</span><br></pre></td></tr></table></figure><h3><span id="搜索-github">搜索 GitHub</span></h3><p>现在，我们已经登录啦！我们可以点击搜索框，填写并在结果页面点击用户标签。但有一个简单的方法：搜索请求通常是 GET 请求，所有内容都是通过 URL 发送的。所以，在搜索框内手动输入 <code>john</code>，然后点击用户标签并复制地址栏上的网址。这将是</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> searchUrl = <span class="string">'https://github.com/search?q=john&amp;type=Users&amp;utf8=%E2%9C%93'</span>;</span><br></pre></td></tr></table></figure><p>做一丢丢调整</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> userToSearch = <span class="string">'john'</span>;</span><br><span class="line"><span class="keyword">const</span> searchUrl = <span class="string">'https://github.com/search?q='</span> + userToSearch + <span class="string">'&amp;type=Users&amp;utf8=%E2%9C%93'</span>;</span><br></pre></td></tr></table></figure><p>让我们跳转到这个页面，看是不是真的搜索到了？</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> page.goto(searchUrl);</span><br><span class="line"><span class="keyword">await</span> page.waitFor(<span class="number">2</span>*<span class="number">1000</span>);</span><br></pre></td></tr></table></figure><h3><span id="提取邮箱地址">提取邮箱地址</span></h3><blockquote><p>译者注：本小节没有直译，因为译者没有使用作者的方案</p></blockquote><p>我们的目的是搜刮用户的 <code>username</code> 和 <code>email</code>。我们可以在 Chrome 的开发者工具中看到，每个单独的用户信息都是在一个 class 为 <code>user-list-item</code> 的 <code>&lt;div&gt;</code> 内。</p><p>一种提取元素内容的方法是 <code>Page</code> or <code>ElementHandle</code> 的 <code>evaluate</code> 方法，因为它作用于浏览器运行的上下文环境内。当我们跳转到搜索结果页的时候，使用 <code>page.evaluate</code> 方法可以将所有用户信息的 div 获取出来。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> USER_LIST_INFO_SELECTOR = <span class="string">'.user-list-item'</span>;</span><br><span class="line"><span class="keyword">const</span> users = <span class="keyword">await</span> page.evaluate(<span class="function">(<span class="params">sel</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> $els = <span class="built_in">document</span>.querySelectorAll(sel);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;, USER_LIST_INFO_SELECTOR);</span><br></pre></td></tr></table></figure><p>遍历上面的 <code>$els</code>，继续使用选择器提取出其中的信息。当然，这里的选择器相当于用户信息的 div 的，不是像之前那样直接复制出来的，稍微有一点 css 知识应该能很容易读懂。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> USER_LIST_INFO_SELECTOR = <span class="string">'.user-list-item'</span>;</span><br><span class="line"><span class="keyword">const</span> USER_LIST_USERNAME_SELECTOR = <span class="string">'.user-list-info&gt;a:nth-child(1)'</span>;</span><br><span class="line"><span class="keyword">const</span> USER_LIST_EMAIL_SELECTOR = <span class="string">'.user-list-info&gt;.user-list-meta .muted-link'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> users = <span class="keyword">await</span> page.evaluate(<span class="function">(<span class="params">sInfo, sName, sEmail</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Array</span>.prototype.slice.apply(<span class="built_in">document</span>.querySelectorAll(sInfo))</span><br><span class="line">    .map(<span class="function"><span class="params">$userListItem</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 用户名</span></span><br><span class="line">      <span class="keyword">const</span> username = $userListItem.querySelector(sName).innerText;</span><br><span class="line">      <span class="comment">// 邮箱</span></span><br><span class="line">      <span class="keyword">const</span> $email = $userListItem.querySelector(sEmail);</span><br><span class="line">      <span class="keyword">const</span> email = $email ? $email.innerText : <span class="literal">undefined</span>;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        username,</span><br><span class="line">        email,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 不是所有用户都显示邮箱</span></span><br><span class="line">    .filter(<span class="function"><span class="params">u</span> =&gt;</span> !!u.email);</span><br><span class="line">&#125;, USER_LIST_INFO_SELECTOR, USER_LIST_USERNAME_SELECTOR, USER_LIST_EMAIL_SELECTOR);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(users);</span><br></pre></td></tr></table></figure><p>现在，当你运行 <code>node index.js</code>，你讲看到 Chrome 跳出来自动执行上述操作后，在命令行打出 <code>username</code> 与其相关的 <code>email</code>。</p><h3><span id="遍历全部页面">遍历全部页面</span></h3><p>首先我们需要评估搜索结果最后一页的页码。在搜索结果页的顶部，你可以看到当我在翻译这篇文章时有 <strong>70,134 users</strong>。</p><p><strong>有趣的现象: 如果你对比上面的截图，你会发现这两天已经有 371 个新的 <em>john</em> 同学加入 GitHub。</strong></p><p><img src="https://github.com/csbun/thal/raw/master/media/num-results-new.png" alt="Number of search items"></p><p>从开发者工具复制人数的选择器。我们将在 <code>run</code> 外面写一个新的函数，用来获取页面数。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getNumPages</span>(<span class="params">page</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> NUM_USER_SELECTOR = <span class="string">'#js-pjax-container &gt; div.container &gt; div &gt; div.column.three-fourths.codesearch-results.pr-6 &gt; div.d-flex.flex-justify-between.border-bottom.pb-3 &gt; h3'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> inner = <span class="keyword">await</span> page.evaluate(<span class="function">(<span class="params">sel</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">document</span>.querySelector(sel).innerHTML;</span><br><span class="line">  &#125;, NUM_USER_SELECTOR);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 格式是: "69,803 users"</span></span><br><span class="line">  inner = inner.replace(<span class="string">','</span>, <span class="string">''</span>).replace(<span class="string">' users'</span>, <span class="string">''</span>);</span><br><span class="line">  <span class="keyword">const</span> numUsers = <span class="built_in">parseInt</span>(inner);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'numUsers: '</span>, numUsers);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * GitHub 每页显示 10 个结果</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">const</span> numPages = <span class="built_in">Math</span>.ceil(numUsers / <span class="number">10</span>);</span><br><span class="line">  <span class="keyword">return</span> numPages;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在搜索结果页底部，如果你把鼠标悬浮在页码按钮上面，可以看到是一个指向下一页的链接。如：第二页的链接是 <code>https://github.com/search?p=2&amp;q=john&amp;type=Users&amp;utf8=%E2%9C%93</code>。注意到 <code>p=2</code> 是一个 URL 的 query 参数，这将帮助我们跳转到指定的页面。</p><p>在添加了遍历页码的代码在上面爬取内容的方法之后，代码变成了这样：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> numPages = <span class="keyword">await</span> getNumPages(page);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Numpages: '</span>, numPages);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> h = <span class="number">1</span>; h &lt;= numPages; h++) &#123;</span><br><span class="line">  <span class="comment">// 跳转到指定页码</span></span><br><span class="line">  <span class="keyword">await</span> page.goto(<span class="string">`<span class="subst">$&#123;searchUrl&#125;</span>&amp;p=<span class="subst">$&#123;h&#125;</span>`</span>);</span><br><span class="line">  <span class="comment">// 执行爬取</span></span><br><span class="line">  <span class="keyword">const</span> users = <span class="keyword">await</span> page.evaluate(<span class="function">(<span class="params">sInfo, sName, sEmail</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Array</span>.prototype.slice.apply(<span class="built_in">document</span>.querySelectorAll(sInfo))</span><br><span class="line">      .map(<span class="function"><span class="params">$userListItem</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 用户名</span></span><br><span class="line">        <span class="keyword">const</span> username = $userListItem.querySelector(sName).innerText;</span><br><span class="line">        <span class="comment">// 邮箱</span></span><br><span class="line">        <span class="keyword">const</span> $email = $userListItem.querySelector(sEmail);</span><br><span class="line">        <span class="keyword">const</span> email = $email ? $email.innerText : <span class="literal">undefined</span>;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          username,</span><br><span class="line">          email,</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="comment">// 不是所有用户都显示邮箱</span></span><br><span class="line">      .filter(<span class="function"><span class="params">u</span> =&gt;</span> !!u.email);</span><br><span class="line">  &#125;, USER_LIST_INFO_SELECTOR, USER_LIST_USERNAME_SELECTOR, USER_LIST_EMAIL_SELECTOR);</span><br><span class="line"></span><br><span class="line">  users.map(<span class="function">(<span class="params">&#123;username, email&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 保存用户信息</span></span><br><span class="line">    <span class="built_in">console</span>.log(username, <span class="string">'-&gt;'</span>, email);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="保存到-mongodb">保存到 MongoDB</span></h3><p>到这里 <code>Puppeteer</code> 的部分已经结束了。下面我们将使用 <code>mongoose</code> 存储上面的信息到 <code>MongoDB</code>。它是个 <a href="https://en.wikipedia.org/wiki/Object-relational_mapping" target="_blank" rel="noopener">ORM</a>，确切说是个便于从数据库进行信息存储和检索的库。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm i --save mongoose</span></span><br></pre></td></tr></table></figure><p>MongoDB 是一个 Schema-less 的 NoSQL 数据库，但我们可以使用 Mongoose 使其遵循一些原则。首先我们需要创建一个 <code>Model</code>，他代表 MongoDB 中的 <code>Collection</code>。创建一个 <code>models</code> 文件夹，然后在里面创建一个 <code>user.js</code> 文件，并加入以下 collection 的构造函数代码。之后无论我们塞什么东西进 <code>User</code>，他都会遵循这个结构。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> userSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">    username: <span class="built_in">String</span>,</span><br><span class="line">    email: <span class="built_in">String</span>,</span><br><span class="line">    dateCrawled: <span class="built_in">Date</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = mongoose.model(<span class="string">'User'</span>, userSchema);</span><br></pre></td></tr></table></figure><p>现在我们可以开始往数据库塞数据了。由于我们不希望数据库中存在重复的 email，所以我们只新增那些以前从没出现过的邮箱，否则我们只更新数据。为此，我们需要使用 mongoose 的 <code>Model.findOneAndUpdate</code> 方法。</p><p>回到 <code>index.js</code>，引用所需的依赖：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="keyword">const</span> User = <span class="built_in">require</span>(<span class="string">'./models/user'</span>);</span><br></pre></td></tr></table></figure><p>然后我们再创建一个新的方法，用于 <strong>upsert</strong> (更新 update 或 新增 insert) 用户实例。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upsertUser</span>(<span class="params">userObj</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> DB_URL = <span class="string">'mongodb://localhost/thal'</span>;</span><br><span class="line">  <span class="keyword">if</span> (mongoose.connection.readyState == <span class="number">0</span>) &#123;</span><br><span class="line">    mongoose.connect(DB_URL);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if this email exists, update the entry, don't insert</span></span><br><span class="line">  <span class="comment">// 如果邮箱存在，就更新实例，不新增</span></span><br><span class="line">  <span class="keyword">const</span> conditions = &#123;</span><br><span class="line">    email: userObj.email</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> options = &#123;</span><br><span class="line">    upsert: <span class="literal">true</span>,</span><br><span class="line">    <span class="keyword">new</span>: <span class="literal">true</span>,</span><br><span class="line">    setDefaultsOnInsert: <span class="literal">true</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  User.findOneAndUpdate(conditions, userObj, options, (err, result) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">throw</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>启动 MongoDB 服务。用下面的代码替换掉之前的注释内容 <code>// TODO: 保存用户信息</code>。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upsertUser(&#123;</span><br><span class="line">  username: username,</span><br><span class="line">  email: email,</span><br><span class="line">  dateCrawled: <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>想要检查是否真的保存了这些用户，可以到 mongo 里面执行下列脚本：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mongo</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> use thal</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> db.users.find().pretty()</span></span><br></pre></td></tr></table></figure><p>你会看到有多个用户在已经添加在里面，那你就成功了哦~</p><blockquote><p>译者注：使用 <code>db.users.find().pretty().length()</code> 可以查看爬取了多少条</p></blockquote><h2><span id="最后">最后</span></h2><p>Chrome Headless 和 Puppeteer 开启了网页爬虫和自动化测试的新纪元，而且 Chrome Headless 还支持 WebGL！你可以把你的爬虫脚本发布到云端，然后就可以坐享其成。当然，发布到服务器之前请记得去掉 <code>headless: false</code> 配置。</p><ul><li>在爬取的时候，你可能会被 GitHub 的频率控制阻止。</li></ul><p><img src="https://github.com/csbun/thal/raw/master/media/whoa.png" alt="Whoa"></p><ul><li>另外，我发现你无法跳到 100 页之后。</li></ul><blockquote><p>译者注：我爬了100页并没有被阻止。从 101 页开始就变成了 404 页面，或许通过页面下方的页码进行遍历会更合理</p></blockquote><h2><span id="结语">结语</span></h2><p>广阔无垠的沙漠见证着 <code>穿越</code> 这些巨大的沙滩的人们的斗争和牺牲。 <a href="https://en.wikipedia.org/wiki/Thal_Desert" target="_blank" rel="noopener"><strong>Thal</strong></a> 是巴基斯坦的一个跨越多个地区的沙漠，包括我的家乡 Bhakkar。与今天在 <code>互联网</code> 上搜索数据的情况类似。这就是为什么我将这个 repo 命名为 <code>Thal</code>。如果你喜欢它，那请与他人分享。如果您有任何建议，请在这里发表评论或直接与原作者联络[@e_mad_ehsan]（<a href="https://twitter.com/e_mad_ehsan）。他很乐意听到你的消息。" target="_blank" rel="noopener">https://twitter.com/e_mad_ehsan）。他很乐意听到你的消息。</a></p><blockquote><p>译者注：中文版也欢迎直接提 <a href="https://github.com/csbun/thal/issues" target="_blank" rel="noopener">issue</a> 讨论 或 PR</p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;这里是 &lt;a href=&quot;https://github.com/emadehsan/thal&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;GitHub 英文原文&lt;/a&gt;&lt;/strong&gt; / &lt;strong&gt;&lt;a href=&quot;https://medium.com/@e_mad_ehsan/getting-started-with-puppeteer-and-chrome-headless-for-web-scrapping-6bf5979dee3e&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Medium 英文原文&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/csbun/thal/raw/master/media/desertious.jpg&quot; alt=&quot;A Desert in painters perception&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/GoogleChrome/puppeteer&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;code&gt;Puppeteer&lt;/code&gt;&lt;/a&gt; 是 Google Chrome 团队官方的无界面（Headless）Chrome 工具。正因为这个官方声明，许多业内自动化测试库都已经停止维护，包括 &lt;strong&gt;&lt;a href=&quot;http://phantomjs.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;PhantomJS&lt;/a&gt;&lt;/strong&gt;。&lt;strong&gt;&lt;a href=&quot;https://addons.mozilla.org/en-US/firefox/addon/selenium-ide/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Selenium IDE for Firefox&lt;/a&gt;&lt;/strong&gt; 项目也因为缺乏维护者而终止。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;译者注：关于 PhantomJS 和 Selenium IDE for Firefox 停止维护并没有找到相关的公告，但这两个项目的确已经都超过 2 年没有发布新版本了。但另一个今年 5 月才开启的项目 &lt;a href=&quot;https://github.com/graphcool/chromeless&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Chromeless&lt;/a&gt; 目前在 Github 上已经超过 1w star，目前还非常活跃。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Chrome 作为浏览器市场的领头羊，&lt;strong&gt;Chrome Headless&lt;/strong&gt; 必将成为 web 应用 &lt;strong&gt;自动化测试&lt;/strong&gt; 的行业标杆。所以我整合了这份如何利用 &lt;strong&gt;Chrome Headless&lt;/strong&gt; 做 &lt;code&gt;网页爬虫&lt;/code&gt; 的入门指南。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Puppeteer" scheme="http://csbun.github.io/blog/tags/Puppeteer/"/>
    
      <category term="Chrome" scheme="http://csbun.github.io/blog/tags/Chrome/"/>
    
      <category term="Headless" scheme="http://csbun.github.io/blog/tags/Headless/"/>
    
  </entry>
  
  <entry>
    <title>npm scripts 之 publish 和 install</title>
    <link href="http://csbun.github.io/blog/2017/08/npm-scripts/"/>
    <id>http://csbun.github.io/blog/2017/08/npm-scripts/</id>
    <published>2017-08-24T10:18:32.000Z</published>
    <updated>2020-11-03T11:52:46.474Z</updated>
    
    <content type="html"><![CDATA[<p>npm <a href="https://docs.npmjs.com/misc/scripts" target="_blank" rel="noopener">自身提供</a>了一些 script，并且有一些特定的规则，最近用到了几个，在这里记录一下，下文提到的代码仓库在 <a href="https://github.com/csbun/npm-scripts-example" target="_blank" rel="noopener">这里</a> 可以看到。</p><a id="more"></a><h2><span id="publish">publish</span></h2><p>通常，我们使用 <code>npm publish</code> 会把所在 package 的当前版本发布到 npm 上。但如果我们还希望有更多的操作，就可能需要用到下面这些：</p><ul><li>prepublish: 在打包和发布 <strong>之前</strong> 执行，同时在本地运行不含任何参数的 <code>npm install</code> 时执行（见下文）。</li><li>prepare: 同样在打包和发布 <strong>之前</strong> 执行，同时在本地运行不含任何参数的 <code>npm install</code> 时执行（见下文）。它的执行时机在 <code>prepublish</code> 之后，在 <code>prepublishOnly</code> 之前。</li><li>prepublishOnly: 在打包和发布 <strong>之前</strong> 执行。 <strong>仅</strong> 在运行 <code>npm publish</code> 前执行。</li><li>prepack: 在 tar 文件被打包好 <strong>之前</strong> 执行（在运行 <code>npm pack</code>，<code>npm publish</code> 和安装 git 依赖时）。</li><li>postpack: 在 tar 文件被打包好并移动到最终目录 <strong>之后</strong> 执行。</li><li>publish、postpublish: 在 package 发布 <strong>之后</strong>。</li></ul><p>说是这么说，但真正使用 <code>npm publish</code> 的时候，到底会执行那些 script？我们拿一个叫 <code>npm-scripts-example</code> 的例子来试一下</p><figure class="highlight"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"npm-scripts-example"</span>,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"prepublish"</span>: <span class="string">"# Run BEFORE the package is packed and published, as well as on local npm install without any arguments."</span>,</span><br><span class="line">    <span class="attr">"prepare"</span>: <span class="string">"# Run both BEFORE the package is packed and published, and on local npm install without any arguments (See below). This is run AFTER prepublish, but BEFORE prepublishOnly."</span>,</span><br><span class="line">    <span class="attr">"prepublishOnly"</span>: <span class="string">"# Run BEFORE the package is prepared and packed, ONLY on npm publish."</span>,</span><br><span class="line">    <span class="attr">"prepack"</span>: <span class="string">"# Run BEFORE a tarball is packed (on npm pack, npm publish, and when installing git dependencies)."</span>,</span><br><span class="line">    <span class="attr">"postpack"</span>: <span class="string">"# Run AFTER the tarball has been generated and moved to its final destination."</span>,</span><br><span class="line">    <span class="attr">"publish"</span>: <span class="string">"# Run AFTER the package is published."</span>,</span><br><span class="line">    <span class="attr">"postpublish"</span>: <span class="string">"# Run AFTER the package is published."</span>,</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 npm@3（3.10.8）环境运行 <code>npm publish</code> 结果如下：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; npm-scripts-example@0.0.4 prepublish /path/to/npm-scripts-example</span><br><span class="line">&gt; <span class="comment"># Run BEFORE the package is packed and published, as well as on local npm install without any arguments.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传到 npm 的进度条出现在这里</span></span><br><span class="line"></span><br><span class="line">+ npm-scripts-example@0.0.4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; npm-scripts-example@0.0.4 publish .</span><br><span class="line">&gt; <span class="comment"># Run AFTER the package is published.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; npm-scripts-example@0.0.4 postpublish .</span><br><span class="line">&gt; <span class="comment"># Run AFTER the package is published.</span></span><br></pre></td></tr></table></figure><p>即</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># npm@3</span><br><span class="line">prepublish -&gt; [上传至 npm] -&gt; publish -&gt; postpublish</span><br></pre></td></tr></table></figure><p>在 npm@5（5.3.0）环境运行 <code>npm publish</code> 结果如下：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">npm WARN prepublish-on-install As of npm@5, `prepublish` scripts are deprecated.</span><br><span class="line">npm WARN prepublish-on-install Use `prepare` <span class="keyword">for</span> build steps and `prepublishOnly` <span class="keyword">for</span> upload-only.</span><br><span class="line">npm WARN prepublish-on-install See the deprecation note <span class="keyword">in</span> `npm <span class="built_in">help</span> scripts` <span class="keyword">for</span> more information.</span><br><span class="line"></span><br><span class="line">&gt; npm-scripts-example@0.0.5 prepublish .</span><br><span class="line">&gt; <span class="comment"># Run BEFORE the package is packed and published, as well as on local npm install without any arguments.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; npm-scripts-example@0.0.5 prepare .</span><br><span class="line">&gt; <span class="comment"># Run both BEFORE the package is packed and published, and on local npm install without any arguments (See below). This is run AFTER prepublish, but BEFORE prepublishOnly.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; npm-scripts-example@0.0.5 prepublishOnly .</span><br><span class="line">&gt; <span class="comment"># Run BEFORE the package is prepared and packed, ONLY on npm publish.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; npm-scripts-example@0.0.5 prepack .</span><br><span class="line">&gt; <span class="comment"># Run BEFORE a tarball is packed (on npm pack, npm publish, and when installing git dependencies).</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; npm-scripts-example@0.0.5 postpack .</span><br><span class="line">&gt; <span class="comment"># Run AFTER the tarball has been generated and moved to its final destination.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传到 npm 的进度条出现在这里</span></span><br><span class="line"></span><br><span class="line">&gt; npm-scripts-example@0.0.5 publish .</span><br><span class="line">&gt; <span class="comment"># Run AFTER the package is published.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; npm-scripts-example@0.0.5 postpublish .</span><br><span class="line">&gt; <span class="comment"># Run AFTER the package is published.</span></span><br><span class="line"></span><br><span class="line">+ npm-scripts-example@0.0.5</span><br></pre></td></tr></table></figure><p>即</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># npm@5</span><br><span class="line">prepublish -&gt; prepare -&gt; prepublishOnly -&gt; prepack -&gt; postpack -&gt; [上传至 npm] -&gt; publish -&gt; postpublish</span><br></pre></td></tr></table></figure><p>可以看到想在 npm@3 环境下 publish 之前干点什么（例如做个自动压缩之类的），只能用 <code>prepublish</code>，然而在 npm@5 就要被舍弃了吖。如果可以限制该 package 的开发者都是 npm@5 环境，那么，直接改成 <code>prepare</code> 是没有问题的，而是否能改成 <code>prepublishOnly</code>，<strong>还</strong> 取决于这个脚本，是不是要在 package 开发者本地运行 <code>install</code> 之后执行。</p><h2><span id="install">install</span></h2><p>前面提到 <code>prepublish</code> 和 <code>prepare</code> 会 “同时在本地运行不含任何参数的 <code>npm install</code> 时执行”。于是我们再改动一下上面的例子，加上 install 相关的 scripts：</p><figure class="highlight"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    "preinstall": "# Run BEFORE the package is installed.",</span><br><span class="line">    "install": "# Run AFTER the package is installed.",</span><br><span class="line">    "postinstall": "# Run AFTER the package is installed.",</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">  &#125;,</span><br><span class="line">  "dependencies": &#123;</span><br><span class="line">    "lodash": "^4.17.4"</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="local-npm-install-without-any-arguments">Local npm install without any arguments</span></h3><p>在当前 package 中运行 <code>npm install</code>， npm@3 环境结果如下：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fetch node modules 的进度条出现在这里</span></span><br><span class="line"></span><br><span class="line">&gt; npm-scripts-example@0.0.5 preinstall /path/to/npm-scripts-example</span><br><span class="line">&gt; <span class="comment"># Run BEFORE the package is installed.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># extract node modules 的进度条出现在这里</span></span><br><span class="line"></span><br><span class="line">&gt; npm-scripts-example@0.0.5 install /path/to/npm-scripts-example</span><br><span class="line">&gt; <span class="comment"># Run AFTER the package is installed.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; npm-scripts-example@0.0.5 postinstall /path/to/npm-scripts-example</span><br><span class="line">&gt; <span class="comment"># Run AFTER the package is installed.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; npm-scripts-example@0.0.5 prepublish /path/to/npm-scripts-example</span><br><span class="line">&gt; <span class="comment"># Run BEFORE the package is packed and published, as well as on local npm install without any arguments.</span></span><br><span class="line"></span><br><span class="line">npm-scripts-example@0.0.5 /path/to/npm-scripts-example</span><br><span class="line">└── lodash@4.17.4</span><br></pre></td></tr></table></figure><p>注意到，除了预料中的 <code>preinstall</code>，<code>install</code> 和 <code>postinstall</code>，在最后还执行了 <code>prepublish</code>。</p><p>即</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># npm@3</span><br><span class="line">[fetch] -&gt; preinstall -&gt; [extract] -&gt; install -&gt; postinstall -&gt; prepublish</span><br></pre></td></tr></table></figure><p>按惯例我们继续试试 npm@5 的结果：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fetch node modules 的进度条出现在这里</span></span><br><span class="line"></span><br><span class="line">&gt; npm-scripts-example@0.0.5 preinstall /path/to/npm-scripts-example</span><br><span class="line">&gt; <span class="comment"># Run BEFORE the package is installed.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># extract node modules 的进度条出现在这里</span></span><br><span class="line"></span><br><span class="line">&gt; npm-scripts-example@0.0.5 install /path/to/npm-scripts-example</span><br><span class="line">&gt; <span class="comment"># Run AFTER the package is installed.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; npm-scripts-example@0.0.5 postinstall /path/to/npm-scripts-example</span><br><span class="line">&gt; <span class="comment"># Run AFTER the package is installed.</span></span><br><span class="line"></span><br><span class="line">npm WARN prepublish-on-install As of npm@5, `prepublish` scripts are deprecated.</span><br><span class="line">npm WARN prepublish-on-install Use `prepare` <span class="keyword">for</span> build steps and `prepublishOnly` <span class="keyword">for</span> upload-only.</span><br><span class="line">npm WARN prepublish-on-install See the deprecation note <span class="keyword">in</span> `npm <span class="built_in">help</span> scripts` <span class="keyword">for</span> more information.</span><br><span class="line"></span><br><span class="line">&gt; npm-scripts-example@0.0.5 prepublish /path/to/npm-scripts-example</span><br><span class="line">&gt; <span class="comment"># Run BEFORE the package is packed and published, as well as on local npm install without any arguments.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; npm-scripts-example@0.0.5 prepare /path/to/npm-scripts-example</span><br><span class="line">&gt; <span class="comment"># Run both BEFORE the package is packed and published, and on local npm install without any arguments (See below). This is run AFTER prepublish, but BEFORE prepublishOnly.</span></span><br><span class="line"></span><br><span class="line">added 1 package <span class="keyword">in</span> 2.348s</span><br></pre></td></tr></table></figure><p>即</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># npm@3</span><br><span class="line">[fetch] -&gt; preinstall -&gt; [extract] -&gt; install -&gt; postinstall -&gt; prepublish -&gt; prepare</span><br></pre></td></tr></table></figure><p>几乎没有任何区别，只是和 publish 一样警告了一下以后不要用 prepublish 了。</p><h3><span id="local-npm-install-with-arguments">Local npm install with arguments</span></h3><p>那么，如果是带有参数的 <code>npm install</code> 呢？我们试试 <code>npm install lodash</code> 看看？</p><p>结果便是，无论 npm@3 还是 npm@5 都只是默默吧 lodash 安装下来，并不会执行任何 script。</p><h3><span id="install-package">Install package</span></h3><p>最后，我们试试在其他地方安装这个 package 的情况：</p><p>在 npm@3 和 npm@5 环境下，若 npm-scripts-example 被首次安装，则无论是否 <code>npm install</code> 是否带参数（即使用 <code>npm install</code> 或 <code>npm install npm-scripts-example</code>），结果均是：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt; npm-scripts-example@0.0.5 preinstall /path/to/project/node_modules/.staging/npm-scripts-example-62ae822f</span><br><span class="line">&gt; <span class="comment"># Run BEFORE the package is installed.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; npm-scripts-example@0.0.5 install /path/to/project/node_modules/npm-scripts-example</span><br><span class="line">&gt; <span class="comment"># Run AFTER the package is installed.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; npm-scripts-example@0.0.5 postinstall /path/to/project/node_modules/npm-scripts-example</span><br><span class="line">&gt; <span class="comment"># Run AFTER the package is installed.</span></span><br><span class="line"></span><br><span class="line">npm-scripts-example-main@0.0.1 /path/to/project</span><br><span class="line">└── npm-scripts-example@0.0.5</span><br></pre></td></tr></table></figure><p>即</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[fetch] -&gt; preinstall -&gt; [extract] -&gt; install -&gt; postinstall</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;npm &lt;a href=&quot;https://docs.npmjs.com/misc/scripts&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;自身提供&lt;/a&gt;了一些 script，并且有一些特定的规则，最近用到了几个，在这里记录一下，下文提到的代码仓库在 &lt;a href=&quot;https://github.com/csbun/npm-scripts-example&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;这里&lt;/a&gt; 可以看到。&lt;/p&gt;
    
    </summary>
    
    
      <category term="npm" scheme="http://csbun.github.io/blog/tags/npm/"/>
    
      <category term="publish" scheme="http://csbun.github.io/blog/tags/publish/"/>
    
      <category term="install" scheme="http://csbun.github.io/blog/tags/install/"/>
    
  </entry>
  
  <entry>
    <title>我试了一下 weex</title>
    <link href="http://csbun.github.io/blog/2017/06/weex-challenger/"/>
    <id>http://csbun.github.io/blog/2017/06/weex-challenger/</id>
    <published>2017-06-15T12:03:59.000Z</published>
    <updated>2020-11-03T11:52:46.472Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="致读者">致读者</span></h2><p>weex 有风险，入门需谨慎。</p><a id="more"></a><h2><span id="入门">入门</span></h2><h3><span id="hello-world">Hello World</span></h3><p>什么都不装，先到 <a href="http://dotwe.org/vue" target="_blank" rel="noopener">dotWe</a> 中看看效果：</p><img src="/2017/06/weex-challenger/dotWe.png" title="dotWe"><p>这是一段 vue 的代码，一个图标和一行文字：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;wrapper&quot;&gt;</span><br><span class="line">    &lt;image :src=&quot;logoUrl&quot; class=&quot;logo&quot;&gt;&lt;/image&gt;</span><br><span class="line">    &lt;text class=&quot;title&quot;&gt;Hello &#123;&#123;target&#125;&#125;&lt;/text&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">  .wrapper &#123; align-items: center; margin-top: 120px; &#125;</span><br><span class="line">  .title &#123; font-size: 48px; &#125;</span><br><span class="line">  .logo &#123; width: 360px; height: 82px; &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">  export default &#123;</span><br><span class="line">    data: &#123;</span><br><span class="line">      logoUrl: &apos;https://alibaba.github.io/weex/img/weex_logo_blue@3x.png&apos;,</span><br><span class="line">      target: &apos;World&apos;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>将其贴在左侧代码区，点击 <code>RUN</code> 即可在 preview 区看到 Web 实现的效果。如果要看 Native 版，则可以下载 <a href="https://weex.incubator.apache.org/cn/playground.html" target="_blank" rel="noopener">Weex Playground</a>，安装到手机中后扫描右侧的 QRCode 即可。</p><p>dotWe 只能运行一个 vue 文件，做单个组件的测试还是可以的，在实际业务应用的时候明显是不够，因此我们需要一个完整的工程项目。</p><h3><span id="初始化">初始化</span></h3><p>在已经有 Node 的前提下，安装配套工具并初始化项目：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">npm install -g weex-toolkit</span><br><span class="line">weex init weex-challenger</span><br><span class="line"><span class="built_in">cd</span> weex-challenger</span><br><span class="line">npm i</span><br></pre></td></tr></table></figure><p>注：我这里使用的版本是 weex-toolkit(1.0.5)</p><h3><span id="运行">运行</span></h3><h4><span id="web">Web</span></h4><p>开两个命令行分别运行：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run dev</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run serve</span><br></pre></td></tr></table></figure><p>看到 <code>serving /Users/hans/workspace/weex-challenger on port 8080</code> 即可打开 <a href="http://127.0.0.1:8080/" target="_blank" rel="noopener">http://127.0.0.1:8080/</a>。然而很不幸页面是空白的，因为还有一个 <a href="https://github.com/weexteam/weex-toolkit/commit/5793aa32d120ff2b8b629f7b860862d7a31dfc6a" target="_blank" rel="noopener">commit</a> 没有发布。所以我们只要同样改一下 <em>weex.html</em> 的 15 行 <code>weex-vue-render</code> 的路径即可：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./node_modules/weex-vue-render/dist/index.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>👈 左边的预览窗口就会出现 weex 的 LOGO。完整代码请看 <a href="https://github.com/csbun/weex-challenger/tree/v0.1.0" target="_blank" rel="noopener">这里</a>。</p><img src="/2017/06/weex-challenger/preview.png" title="Web 预览效果"><h4><span id="native">Native</span></h4><p>同样使用 <a href="https://weex.incubator.apache.org/cn/playground.html" target="_blank" rel="noopener">Weex Playground</a> 扫描上面 <a href="http://127.0.0.1:8080/" target="_blank" rel="noopener">http://127.0.0.1:8080/</a> 中的的二维码，即会在 Native App 中打开一个新的 Page 显示上面相同的界面。</p><h3><span id="单页面应用">单页面应用</span></h3><p>SPA 的应该是一个很常见的需求，我们现在就在默认的初始化项目上使用 Vue 全家桶实现一个简单的单页面应用。</p><h4><span id="vue-router">vue-router</span></h4><p>假设我们的场景是有 Foo，Bar 两个 Tab，点击分别进入两个不同的页面。首先我们要有一个入口组件承载 <em>app.vue</em>：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div @androidback=&quot;back&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;nav&quot;&gt;</span><br><span class="line">      &lt;text class=&quot;nav-i&quot; @click=&quot;jumpFoo&quot;&gt;Foo&lt;/text&gt;</span><br><span class="line">      &lt;text class=&quot;nav-i&quot; @click=&quot;jumpBar&quot;&gt;Bar&lt;/text&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;router-view style=&quot;flex:1&quot;&gt;&lt;/router-view&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">  export default &#123;</span><br><span class="line">    methods: &#123;</span><br><span class="line">      back: function() &#123;</span><br><span class="line">        this.$router.back();</span><br><span class="line">      &#125;,</span><br><span class="line">      jumpFoo: function() &#123;</span><br><span class="line">        this.$router.push(&apos;/foo&apos;);</span><br><span class="line">      &#125;,</span><br><span class="line">      jumpBar: function() &#123;</span><br><span class="line">        this.$router.push(&apos;/bar/0&apos;);</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>其中 <code>jumpFoo</code> 和 <code>jumpBar</code> 是使用 <a href="https://weex.incubator.apache.org/cn/references/vue/difference-of-vuex.html#编程式导航" target="_blank" rel="noopener">Weex 官方限制</a> 的 <a href="https://router.vuejs.org/zh-cn/essentials/navigation.html" target="_blank" rel="noopener">编程式导航</a> 的方式来实现页面跳转。</p><p>在 <em>router.js</em> 文件中，我们给 <code>FooView</code> 和 <code>BarView</code> 绑定对应的路径 <code>/foo</code> 和 <code>/bar</code>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Router <span class="keyword">from</span> <span class="string">'vue-router'</span>;</span><br><span class="line"><span class="keyword">import</span> FooView <span class="keyword">from</span> <span class="string">'./foo.vue'</span>;</span><br><span class="line"><span class="keyword">import</span> BarView <span class="keyword">from</span> <span class="string">'./bar.vue'</span>;</span><br><span class="line"></span><br><span class="line">Vue.use(Router);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> Router(&#123;</span><br><span class="line">  routes: [</span><br><span class="line">    &#123; <span class="attr">path</span>: <span class="string">'/foo'</span>, <span class="attr">component</span>: FooView &#125;,</span><br><span class="line">    &#123; <span class="attr">path</span>: <span class="string">'/bar/:id'</span>, <span class="attr">component</span>: BarView &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>最后在入口文件 <em>app.js</em> 中绑定 <code>App</code> 和 <code>router</code>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./src/app.vue'</span>;</span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">'./src/router'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> Vue(Vue.util.extend(&#123; <span class="attr">el</span>: <span class="string">'#root'</span>, router &#125;, App));</span><br><span class="line"></span><br><span class="line">router.push(<span class="string">'/foo'</span>);</span><br></pre></td></tr></table></figure><p>完整的代码示例请看 <a href="https://github.com/csbun/weex-challenger/tree/v0.2.0" target="_blank" rel="noopener">这里</a>，更新的内容看这个 <a href="https://github.com/csbun/weex-challenger/commit/8e7f0443a0336f30cdc33ee9fc3bc4ae1b079a1b" target="_blank" rel="noopener">commit</a>。</p><h2><span id="发布">发布</span></h2><p>因为玩过 <a href="https://facebook.github.io/react-native/" target="_blank" rel="noopener">React Native</a>，打包成一个应用本是一件不复杂的事情，然而在 weex 中就没那么规范了。</p><p><a href="https://www.npmjs.com/package/weex-toolkit" target="_blank" rel="noopener">weex-toolkit</a> 虽然已经集成了 <a href="https://www.npmjs.com/package/weexpack" target="_blank" rel="noopener">weexpack</a> 的功能，但二者初始化出来的项目完全不同。也就是 <code>weex-toolkit init</code> != <code>weexpack create</code>，以致于后面的 <code>weexpack platform</code> 也无法继续。暂时没空折腾了。。。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;致读者&quot;&gt;&lt;a href=&quot;#致读者&quot; class=&quot;headerlink&quot; title=&quot;致读者&quot;&gt;&lt;/a&gt;致读者&lt;/h2&gt;&lt;p&gt;weex 有风险，入门需谨慎。&lt;/p&gt;
    
    </summary>
    
    
      <category term="weex" scheme="http://csbun.github.io/blog/tags/weex/"/>
    
      <category term="vue" scheme="http://csbun.github.io/blog/tags/vue/"/>
    
  </entry>
  
  <entry>
    <title>Using Storybook with Preact</title>
    <link href="http://csbun.github.io/blog/2017/03/preact-storybook/"/>
    <id>http://csbun.github.io/blog/2017/03/preact-storybook/</id>
    <published>2017-03-16T10:07:04.000Z</published>
    <updated>2020-11-03T11:52:46.472Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="tldr">TL;DR;</span></h2><p>Clone this <a href="https://github.com/csbun/preact-storybook-example" target="_blank" rel="noopener">repo</a> and start！</p><p>克隆这个 <a href="https://github.com/csbun/preact-storybook-example" target="_blank" rel="noopener">项目</a> 然后启动即可！</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone git@github<span class="selector-class">.com</span>:csbun/preact-storybook-example.git</span><br><span class="line">cd preact-storybook-example</span><br><span class="line"></span><br><span class="line">npm i</span><br><span class="line">npm run storybook</span><br></pre></td></tr></table></figure><a id="more"></a><h2><span id="install-dependences-安装依赖">Install Dependences 安装依赖</span></h2><p><a href="https://getstorybook.io/" target="_blank" rel="noopener">Storybook</a> is aim for <a href="https://github.com/storybooks/react-storybook" target="_blank" rel="noopener">React</a> and <a href="https://github.com/storybooks/react-native-storybook" target="_blank" rel="noopener">React Native</a>. <a href="https://github.com/storybooks/getstorybook" target="_blank" rel="noopener">getstorybook</a> is unable to use in a Preact project. With <a href="https://github.com/developit/preact-compat" target="_blank" rel="noopener">preact-compat</a>, we can do this manually.</p><p><a href="https://getstorybook.io/" target="_blank" rel="noopener">Storybook</a> 目前是为 <a href="https://github.com/storybooks/react-storybook" target="_blank" rel="noopener">React</a> 和 <a href="https://github.com/storybooks/react-native-storybook" target="_blank" rel="noopener">React Native</a> 而设计的。<a href="https://github.com/storybooks/getstorybook" target="_blank" rel="noopener">getstorybook</a> 目前无法在 Preact 项目中使用。但有了 <a href="https://github.com/developit/preact-compat" target="_blank" rel="noopener">preact-compat</a>，理论上我们应该是可以手动完成这个任务的。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -D @kadira/storybook preact-compat</span><br></pre></td></tr></table></figure><p>Some peerDependences warning about react may blow up here, ignore it.</p><blockquote><p>You may have preact installed before.</p></blockquote><p>这里可能会出现一些关于 react 的 peerDependences 警告，忽略之。</p><h2><span id="config-配置">Config 配置</span></h2><h3><span id="storybook-configuration">Storybook Configuration</span></h3><p>Using CLI <code>getstorybook</code> will create config file <em>.storybook/config.js</em>, so we have to do it by ourself.</p><p>我们需要手动创建本应该是使用命令行 <code>getstorybook</code> 创建的配置文件 <em>.storybook/config.js</em>。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir .storybook</span><br><span class="line">touch .storybook/config.js</span><br></pre></td></tr></table></figure><p>Fill it with the following code:</p><p>并填入以下内容：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; configure &#125; <span class="keyword">from</span> <span class="string">'@kadira/storybook'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadStories</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">'../stories'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">configure(loadStories, <span class="built_in">module</span>);</span><br></pre></td></tr></table></figure><h3><span id="webpack-configuration-for-preact">Webpack Configuration (for Preact)</span></h3><p>Storybook use webpack for bundling, what make us easy to use preact-compat. Create another file <em>.storybook/webpack.config.js</em>:</p><p>Storybook 使用 webpack 打包，所以我们可以很容易添加 preact-compat 的配置进去。 创建一个 <em>.storybook/webpack.config.js</em> 文件：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  name: <span class="string">'client'</span>,</span><br><span class="line">  target: <span class="string">'web'</span>,</span><br><span class="line">  resolve: &#123;</span><br><span class="line">    extensions: [<span class="string">''</span>, <span class="string">'.js'</span>, <span class="string">'jsx'</span>],</span><br><span class="line">    alias: &#123;</span><br><span class="line">      <span class="string">'react'</span>: <span class="string">'preact-compat'</span>,</span><br><span class="line">      <span class="string">'react-dom'</span>: <span class="string">'preact-compat'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  devtool: <span class="string">'source-map'</span>,</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    loaders: [&#123;</span><br><span class="line">      test: <span class="regexp">/\.jsx?$/</span>,</span><br><span class="line">      loader: <span class="string">'babel'</span>,</span><br><span class="line">      exclude: <span class="regexp">/node_modules/</span>,</span><br><span class="line">    &#125;],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>And we need <em>.babelrc</em> for preact jsx file.</p><blockquote><p>You may have babel and plugins installed.<br><code>npm i -D babel babel-preset-es2015 babel-plugin-transform-react-jsx</code></p></blockquote><p>同时我们需要为我们的 preact jsx 文件准备一个 <em>.babelrc</em> 配置文件。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"presets"</span>: [ <span class="string">"es2015"</span> ],</span><br><span class="line">  <span class="attr">"plugins"</span>: [</span><br><span class="line">    [ <span class="string">"transform-react-jsx"</span>, &#123; <span class="attr">"pragma"</span>: <span class="string">"h"</span> &#125;]</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="writing-stories-编写-stories">Writing Stories 编写 Stories</span></h2><p>Let’s see <code>require(&#39;../stories&#39;)</code> in <em>.storybook/config.js</em>, line 4. That’s where we write our “stories”. Create a <em>stories/index.js</em> file as an entry, just like CLI <code>getstorybook</code> do:</p><p>我们可以在 <em>.storybook/config.js</em> 第4行看到 <code>require(&#39;../stories&#39;)</code> 引入了 stories。因此我们需要创建入口文件 <em>stories/index.js</em> ：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; h &#125; <span class="keyword">from</span> <span class="string">'preact'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; storiesOf, action &#125; <span class="keyword">from</span> <span class="string">'@kadira/storybook'</span>;</span><br><span class="line"><span class="keyword">import</span> Button <span class="keyword">from</span> <span class="string">'./Button'</span>; <span class="comment">// preact component</span></span><br><span class="line"></span><br><span class="line">storiesOf(<span class="string">'Button'</span>, <span class="built_in">module</span>)</span><br><span class="line">  .add(<span class="string">'case 1'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">Button</span> <span class="attr">text</span>=<span class="string">"CASE-1"</span> <span class="attr">onPress</span>=<span class="string">&#123;action(</span>'<span class="attr">case-1</span>')&#125; /&gt;</span>);</span></span><br><span class="line"><span class="xml">  &#125;)</span></span><br><span class="line"><span class="xml">  .add('case 2', () =&gt; &#123;</span></span><br><span class="line">    return (&lt;Button text="CASE-2" onPress=&#123;action('case-2')&#125; /&gt;);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><h2><span id="launch-启动">Launch 启动</span></h2><p>Add storybook script into <em>package.json</em>:<br>在 <em>package.json</em> 中添加 storybook 的启动脚本：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"preact-storybook-example"</span>,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"storybook"</span>: <span class="string">"start-storybook -p 6006"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Then we can run <code>npm run storybook</code> to start using storybook by visiting <a href="http://localhost:6006/" target="_blank" rel="noopener">http://localhost:6006/</a>.</p><p>然后运行 <code>npm run storybook</code> 就可以启动 storybook，然后访问 <a href="http://localhost:6006/" target="_blank" rel="noopener">http://localhost:6006/</a> 开发。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;TL-DR&quot;&gt;&lt;a href=&quot;#TL-DR&quot; class=&quot;headerlink&quot; title=&quot;TL;DR;&quot;&gt;&lt;/a&gt;TL;DR;&lt;/h2&gt;&lt;p&gt;Clone this &lt;a href=&quot;https://github.com/csbun/preact-storybook-example&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;repo&lt;/a&gt; and start！&lt;/p&gt;
&lt;p&gt;克隆这个 &lt;a href=&quot;https://github.com/csbun/preact-storybook-example&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;项目&lt;/a&gt; 然后启动即可！&lt;/p&gt;
&lt;figure class=&quot;highlight stylus&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;git clone git@github&lt;span class=&quot;selector-class&quot;&gt;.com&lt;/span&gt;:csbun/preact-storybook-example.git&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cd preact-storybook-example&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;npm i&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;npm run storybook&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Storybook" scheme="http://csbun.github.io/blog/tags/Storybook/"/>
    
      <category term="Preact" scheme="http://csbun.github.io/blog/tags/Preact/"/>
    
  </entry>
  
  <entry>
    <title>Java 中使用 Gson 反序列化 JSON 数据</title>
    <link href="http://csbun.github.io/blog/2016/11/gson-deserialization/"/>
    <id>http://csbun.github.io/blog/2016/11/gson-deserialization/</id>
    <published>2016-11-27T10:52:14.000Z</published>
    <updated>2020-11-03T11:52:46.472Z</updated>
    
    <content type="html"><![CDATA[<p>好长时间没写 Java，发现序列化、反序列化一个 JSON 数据真不是个容易的事情（主要还是年纪大了，记不住）。于是记录一下使用 <a href="https://github.com/google/gson" target="_blank" rel="noopener">Gson</a> 反序列化的方法。文中涉及的代码都可以在这个 <a href="https://github.com/csbun/gson-deserialization-example" target="_blank" rel="noopener">gson-deserialization-example</a> 中找到。</p><blockquote><p>作者本身不懂 Java，本着不负责的态度写下这些内容，大牛勿喷，想抄代码的菜鸟请珍重。<br>本文基于转换期间没有异常情况讨论，实际情况请珍重。</p></blockquote><h2><span id="初始化">初始化</span></h2><p>我们先创建一个简单的 <em>TestMain.java</em> 文件，用来运行我们后续的测试方法。</p><figure class="highlight java"><figcaption><span>TestMain.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestMain</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</span><br><span class="line">    <span class="comment">// 运行测试方法</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><a id="more"></a><p>通过 <code>javac TestMain.java</code> 会生成 <em>TestMain.class</em> 文件，之后就能通过 <code>java TestMain</code> 运行 <em>class</em> 文件。</p><p>在当前的例子中我们 google 的 <a href="https://github.com/google/gson" target="_blank" rel="noopener">Gson</a>( <a href="http://search.maven.org/#artifactdetails%7Ccom.google.code.gson%7Cgson%7C2.8.0%7C" target="_blank" rel="noopener">maven 地址</a>) 库来做序列化和反序列化。简单起见，我们直接下载 jar 包，放到 <em>lib</em> 目录下。</p><blockquote><p>因为我们使用了 gson.jar 所以命令会变成这样：<br><code>javac -classpath lib/gson-2.8.0.jar TestMain.java</code><br><code>java -classpath .:lib/gson-2.8.0.jar TestMain</code></p></blockquote><h2><span id="jsonparser">JsonParser</span></h2><h3><span id="object">Object</span></h3><p>假设我们有这样一个简单的 JSON 数据：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/* Sample JSON */</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"Hans Chan"</span>,</span><br><span class="line">  <span class="attr">"age"</span>: <span class="number">18</span>,</span><br><span class="line">  <span class="attr">"tags"</span>: [&#123;</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"text"</span>: <span class="string">"JavaScript"</span></span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"text"</span>: <span class="string">"Java"</span></span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用 <code>JsonParser</code> 足够的简单：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JsonParser jsonParser = <span class="keyword">new</span> JsonParser();</span><br><span class="line">JsonElement userJsonElement = jsonParser.parse(json);</span><br></pre></td></tr></table></figure><p>所有东西都是 <strong>抽象</strong> 的 <code>JsonElement</code>(<a href="https://static.javadoc.io/com.google.code.gson/gson/2.6.2/com/google/gson/JsonElement.html" target="_blank" rel="noopener">api</a>)，如果要获取具体的内容，就得转换成 <code>JsonObject</code> 或 <code>JsonArray</code> 等类型，获取方式也非常直观 <code>.get(&quot;key&quot;)</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">JsonObject userJsonObject = userJsonElement.getAsJsonObject();</span><br><span class="line">String name = userJsonObject.get(<span class="string">"name"</span>).getAsString();</span><br><span class="line"><span class="keyword">int</span> age = userJsonObject.get(<span class="string">"age"</span>).getAsInt();</span><br><span class="line">JsonArray userTagsJsonArray = userJsonObject.get(<span class="string">"tags"</span>).getAsJsonArray();</span><br></pre></td></tr></table></figure><h3><span id="array">Array</span></h3><p>同样的场景，如果输入的 <code>json</code> 字符串不是 <code>{}</code> 而是 <code>[]</code>，也可以通过上述方法获取：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String json = <span class="string">"[&#123;&#125;,&#123;&#125;]"</span>; <span class="comment">// 每个 &#123;&#125; 都是一个 Sample JSON</span></span><br><span class="line">JsonArray userJsonArray = jsonParser.parse(json).getAsJsonArray(); <span class="comment">// 不是 getAsJsonObject</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; userJsonArray.size(); i++) &#123;</span><br><span class="line">    JsonObject userJsonObject = userJsonArray.get(i).getAsJsonObject();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="serialization">Serialization</span></h3><p><code>JsonElement</code> 的序列化很简单，直接 <code>.toString()</code> 即可。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String json = userJsonObject.toString(); <span class="comment">// JsonObject</span></span><br></pre></td></tr></table></figure><h2><span id="oo">OO</span></h2><p>这下子，写 Java 的哥们就肯定会跳出来说 “这是什么鬼，一点都不 OO”。的确上面的方式很 js，于是我们就要写得像 Java 一点，先来两个 class ：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Tag</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String text;</span><br><span class="line">    <span class="comment">// 此处省略 Getter and Setter</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Tag&gt; tags;</span><br><span class="line">    <span class="comment">// 此处省略 Getter and Setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="object">Object</span></h3><p>大家注意了，我要变形了！（敲黑板）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">User user = gson.fromJson(json, User.class);</span><br></pre></td></tr></table></figure><p>通过 Gson，<code>String</code> 被转换成指定的 <code>User.class</code>，然后我们就可以愉快地操作这个实例了：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Tag&gt; tags = user.getTags();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tags.size(); i++) &#123;</span><br><span class="line">    Tag tag = tags.get(i);</span><br><span class="line">    System.out.println(<span class="string">"tag "</span> + tag.getId() + <span class="string">": "</span> + tag.getText());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="array">Array</span></h3><p>还是同样的例子，如果是 <code>[]</code> 怎么办？我们当然期望是获得一个 <code>List&lt;User&gt;</code> 啦，但没有 <code>List&lt;User&gt;.class</code> 这个东西，怎么破？没关系，Gson 里面还有个 <code>TypeToken</code> 是可以跟你干这事的，我们只需要这样：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// import com.google.common.reflect.TypeToken;</span></span><br><span class="line">TypeToken typeToken = <span class="keyword">new</span> TypeToken&lt;List&lt;User&gt;&gt;() &#123;&#125;;</span><br><span class="line"><span class="comment">// import java.lang.reflect.Type;</span></span><br><span class="line">Type type = typeToken.getType();</span><br><span class="line"></span><br><span class="line">List&lt;User&gt; users = gson.fromJson(json, type);</span><br></pre></td></tr></table></figure><p>还是可以愉快地玩耍的，不是麽 😂</p><h3><span id="serialization">Serialization</span></h3><p>Class 要反序列化就还是要依赖回 Gson 提供的 <code>toJson</code> 方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String json = gson.toJson(user); <span class="comment">// User</span></span><br></pre></td></tr></table></figure><h2><span id="gsonbuilder">GsonBuilder</span></h2><p>很多时候，输入的 json 总有那么一点不尽人意，例如下面这个例子：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"id"</span>: <span class="number">3</span>,</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"Hans Chan"</span>,</span><br><span class="line">  <span class="attr">"registrationTime"</span>: <span class="string">"1999-09-19 18:10:22"</span>,</span><br><span class="line">  <span class="attr">"data"</span>: &#123;</span><br><span class="line">    <span class="attr">"some"</span>: <span class="string">"complex data"</span>,</span><br><span class="line">    <span class="attr">"we"</span>: &#123;</span><br><span class="line">      <span class="attr">"do-NOT"</span>: [<span class="string">"care"</span>, <span class="string">"about"</span>, <span class="string">"what"</span>, <span class="string">"inside"</span>],</span><br><span class="line">      <span class="attr">"BUT"</span>: <span class="string">"needed!"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>id</code> 是我们需要的数据，但序列化出去的时候不想显示</li><li><code>registrationTime</code> 可能不是一个我们想要的格式</li><li><code>data</code> 可能是我们不是很关心结构，但又需要保存里面的内容</li></ul><p>利用 GsonBuilder 和 Annotation 我们就可以实现上面两个功能：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseUser</span> </span>&#123;</span><br><span class="line">    <span class="comment">// import com.google.gson.annotations.Expose;</span></span><br><span class="line">    <span class="meta">@Expose</span>(serialize = <span class="keyword">false</span>, deserialize = <span class="keyword">true</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Expose</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// import com.google.gson.annotations.SerializedName;</span></span><br><span class="line">    <span class="meta">@SerializedName</span>(<span class="string">"registrationTime"</span>)</span><br><span class="line">    <span class="meta">@Expose</span></span><br><span class="line">    <span class="keyword">private</span> Date registration;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getRegistration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> registration;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomBUser</span> <span class="keyword">extends</span> <span class="title">BaseUser</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Expose</span></span><br><span class="line">    <span class="keyword">private</span> JsonElement data;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonElement <span class="title">getData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>registrationTime</code> 的格式我们用 <code>GsonBuilder</code> 声明：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Gson deserializationGson = <span class="keyword">new</span> GsonBuilder()</span><br><span class="line">        <span class="comment">// 不导出实体中没有用 @Expose 注解的属性</span></span><br><span class="line">        .excludeFieldsWithoutExposeAnnotation()</span><br><span class="line">        <span class="comment">// 时间格式</span></span><br><span class="line">        .setDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>)</span><br><span class="line">        .create();</span><br></pre></td></tr></table></figure><p>愉快地玩耍吧：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CustomBUser cbu = deserializationGson.fromJson(json, CustomBUser.class);</span><br><span class="line">System.out.println(<span class="string">"id: "</span> + cbu.getId());</span><br><span class="line">System.out.println(cau.getData());</span><br></pre></td></tr></table></figure><h3><span id="自定义序列化和反序列化">自定义序列化和反序列化</span></h3><p>上面的例子中，<code>data</code> 是直接用一个 <code>JsonElement</code> 来处理的，如果有更加个性化的要求，那就需要自己写序列化和反序列化方法了。这里我们自己实现一个 <code>CustomUserData</code> 类，用来处理 <code>data</code> 数据，直接实现上面相同的功能：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomUserData</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> JsonElement ctx;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomUserData</span><span class="params">(JsonElement ctx)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.ctx = ctx;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.ctx.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomAUser</span> <span class="keyword">extends</span> <span class="title">BaseUser</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Expose</span></span><br><span class="line">    <span class="keyword">private</span> CustomUserData data;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CustomUserData <span class="title">getData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 自定义反序列化方法</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomUserDataDeserializeAdapter</span> <span class="keyword">implements</span> <span class="title">JsonDeserializer</span>&lt;<span class="title">CustomUserData</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CustomUserData <span class="title">deserialize</span><span class="params">(JsonElement json, Type typeOfT, JsonDeserializationContext context)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> JsonParseException </span>&#123;</span><br><span class="line">        <span class="comment">// 这里实现复杂的功能</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CustomUserData(json);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 自定义序列化方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomUserDataSerializeAdapter</span> <span class="keyword">implements</span> <span class="title">JsonSerializer</span>&lt;<span class="title">CustomUserData</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonElement <span class="title">serialize</span><span class="params">(CustomUserData src, Type typeOfSrc, JsonSerializationContext context)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 这里实现复杂的功能</span></span><br><span class="line">        <span class="keyword">return</span> src.ctx;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过 <code>registerTypeAdapter</code> 给 GsonBuilder 注册上面的自定义序列化方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Gson deserializationGson = <span class="keyword">new</span> GsonBuilder()</span><br><span class="line">        .excludeFieldsWithoutExposeAnnotation()</span><br><span class="line">        .setDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>)</span><br><span class="line">        .registerTypeAdapter(CustomUserData.class, <span class="keyword">new</span> CustomUserDataDeserializeAdapter())</span><br><span class="line">        .create();</span><br><span class="line">Gson serializationGson = <span class="keyword">new</span> GsonBuilder()</span><br><span class="line">        .excludeFieldsWithoutExposeAnnotation()</span><br><span class="line">        .setDateFormat(<span class="string">"yyyy/MM/dd HH:mm:ss"</span>)</span><br><span class="line">        .registerTypeAdapter(CustomUserData.class, <span class="keyword">new</span> CustomUserDataSerializeAdapter())</span><br><span class="line">        .setPrettyPrinting()</span><br><span class="line">        .create();</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"---------- CustomAUser ----------"</span>);</span><br><span class="line">CustomAUser cau = deserializationGson.fromJson(json, CustomAUser.class);</span><br><span class="line">System.out.println(<span class="string">"id: "</span> + cau.getId());</span><br><span class="line"><span class="comment">// System.out.println(cau.getRegistration());</span></span><br><span class="line"><span class="comment">// System.out.println(cau.getData()); // .toString()</span></span><br><span class="line">System.out.println(serializationGson.toJson(cau));</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;好长时间没写 Java，发现序列化、反序列化一个 JSON 数据真不是个容易的事情（主要还是年纪大了，记不住）。于是记录一下使用 &lt;a href=&quot;https://github.com/google/gson&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Gson&lt;/a&gt; 反序列化的方法。文中涉及的代码都可以在这个 &lt;a href=&quot;https://github.com/csbun/gson-deserialization-example&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;gson-deserialization-example&lt;/a&gt; 中找到。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;作者本身不懂 Java，本着不负责的态度写下这些内容，大牛勿喷，想抄代码的菜鸟请珍重。&lt;br&gt;本文基于转换期间没有异常情况讨论，实际情况请珍重。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;初始化&quot;&gt;&lt;a href=&quot;#初始化&quot; class=&quot;headerlink&quot; title=&quot;初始化&quot;&gt;&lt;/a&gt;初始化&lt;/h2&gt;&lt;p&gt;我们先创建一个简单的 &lt;em&gt;TestMain.java&lt;/em&gt; 文件，用来运行我们后续的测试方法。&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;figcaption&gt;&lt;span&gt;TestMain.java&lt;/span&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;TestMain&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String args[])&lt;/span&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 运行测试方法&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Java" scheme="http://csbun.github.io/blog/tags/Java/"/>
    
      <category term="JSON" scheme="http://csbun.github.io/blog/tags/JSON/"/>
    
      <category term="serialization" scheme="http://csbun.github.io/blog/tags/serialization/"/>
    
      <category term="deserialization" scheme="http://csbun.github.io/blog/tags/deserialization/"/>
    
  </entry>
  
  <entry>
    <title>我眼中的世界：香港</title>
    <link href="http://csbun.github.io/blog/2016/11/HK-in-my-eyes/"/>
    <id>http://csbun.github.io/blog/2016/11/HK-in-my-eyes/</id>
    <published>2016-11-22T09:56:30.000Z</published>
    <updated>2020-11-03T11:52:46.335Z</updated>
    
    <content type="html"><![CDATA[<p>仔細想想，從旅行的定義來講，去得最多的地方，居然是香港🇭🇰，這個起初我很不喜歡的地方。說到香港，很多人的第壹印象大多會是這樣：</p><img src="/2016/11/HK-in-my-eyes/HongKongIsland/DSC01355.jpg" title="太平山頂"><a id="more"></a><p>或者是像麥兜裏面描繪的這樣：</p><img src="/2016/11/HK-in-my-eyes/other/McDull.jpeg" title="來源: http://www.wxrw123.com/bg/20160911/2792375.html"><p>或者，至少是這樣：</p><img src="/2016/11/HK-in-my-eyes/other/noodle.jpg" title="妳餓唔餓，我落個麺妳食啊"><p>而我印象最深刻的，卻是這樣的：</p><img src="/2016/11/HK-in-my-eyes/LammaIsland/DSC03487.JPG" title="南丫島，索苦灣 或 榕樹灣，不記得了"><p>早上趁沒人的時候走走豉油街、通菜街、洗衣街、缽蘭街，將會非常愜意~</p><img src="/2016/11/HK-in-my-eyes/Kowloon/DSC01221.jpg" title="油尖旺市集"><p>然後找壹家茶餐廳坐下：</p><img src="/2016/11/HK-in-my-eyes/food/DSC01370.jpg" title="奶茶、菠蘿油"><h2><span id="目的地">目的地</span></h2><p>去香港不壹定真的只是買買買，其實離島區或者西貢等郊野公園都有很多風景秀麗的地方。下面簡單介紹我去過的幾個地方，照片應該是最好的表達方式。</p><h3><span id="大澳-tai-o">大澳 (Tai O)</span></h3><p>大嶼山腳下的小漁村，但也因旅遊業的發展而變得略帶商業化。</p><div style="width:66%;margin:0 17%"><br>  <img src="/2016/11/HK-in-my-eyes/TaiO/DSC01404.JPG" title="街道"><br></div><p>不要只停留在村口的那兩條主路，在保證不影響原住民的前提下，邁開狗腿往前走，</p><img src="/2016/11/HK-in-my-eyes/TaiO/DSC01438.JPG" title="贏過兩座獎杯的龍舟"><p>遠離旅行團，不停地走，</p><img src="/2016/11/HK-in-my-eyes/TaiO/DSC01408.jpg" title="吊腳樓，有很多電影都是在這裏拍攝的"><p>直到真的沒法繼續往前為止！</p><img src="/2016/11/HK-in-my-eyes/TaiO/DSC01447.jpg" title="海邊，海水非常幹凈，有漁民捕魚"><h3><span id="南丫島-lamma-island">南丫島 (Lamma Island)</span></h3><p>又壹個離島，渡輪登島之後，有幾家茶餐廳和士多店，物價和市區差不多（香港的普通餐廳物價還是比較理性的，即便是離島，偏遠的地方也不會翻倍的漲價，這壹點在麥經感觸最深），當然也有吃海鮮的高級貨：</p><img src="/2016/11/HK-in-my-eyes/LammaIsland/DSC03513.JPG" title="天虹，很多明星都來吃過"><p>往島的深處走，爬上山可以看到壹個“青年社會實踐基地”：</p><img src="/2016/11/HK-in-my-eyes/LammaIsland/DSC03429.JPG" title="只拍了路牌，沒有走進去"><p>還能看到像這樣的海灣：</p><img src="/2016/11/HK-in-my-eyes/LammaIsland/DSC03439.jpg" title="山上看到的海灣全景"><p>島上有還有好幾個海灘，不大，人也不多。海水非常幹凈，配套洗浴設施、救生員、救生設備都非常完善，重點是，免費的！</p><div style="width:66%;margin:0 17%"><br>  <img src="/2016/11/HK-in-my-eyes/LammaIsland/DSC03425.jpg" title="離碼頭最近的海灘，"><br></div><img src="/2016/11/HK-in-my-eyes/LammaIsland/DSC03448.jpg" title="蘆須城海灘"><h3><span id="麥理浩徑-maclehose-trail">麥理浩徑 (MacLehose Trail)</span></h3><p>壹、二段是麥理浩徑的精華段，是香港遠足的首選線路：</p><img src="/2016/11/HK-in-my-eyes/MacLehoseTrail/map1-2.png" title="壹、二段地圖"><p>第壹段大壩的左邊是水庫，右邊是大海，還有地質公園（抱歉我沒有拍照）。</p><img src="/2016/11/HK-in-my-eyes/MacLehoseTrail/2016-10-02_154724.jpg" title="萬宜水庫，遠處是大壩，大壩那邊是海"><p>即使是國慶假期，因為香港不放假，只有大陸團，人並不多：</p><img src="/2016/11/HK-in-my-eyes/MacLehoseTrail/2016-10-02_170433.jpg" title="壹段終點：浪茄灣"><img src="/2016/11/HK-in-my-eyes/MacLehoseTrail/2016-10-03_172225.jpg" title="大浪灣，要從鹹田灣翻過望魚角才能到達的大灣"><p>但遠足並不是壹件簡單的事情，壹定要有所準備，註意安全！</p><div><div style="width:50%;float:left;"><img src="/2016/11/HK-in-my-eyes/MacLehoseTrail/2016-10-03_121312.jpg" title="負重前行"></div><div style="width:50%;float:left;"><img src="/2016/11/HK-in-my-eyes/MacLehoseTrail/2016-10-03_095448.jpg" title="我當日的裝備"></div><div style="clear:both;"></div></div><h3><span id="塔門島-grass-island">塔門島 (Grass Island)</span></h3><p>香港的東極島，親近大海，親近牛：</p><img src="/2016/11/HK-in-my-eyes/GrassIsland/2016-10-04_155331.jpg" title="東邊的海"><img src="/2016/11/HK-in-my-eyes/GrassIsland/2016-10-05_061456.jpg" title="最佳日出營地"><h2><span id="美食">美食</span></h2><p>還可以吃吃吃啊！</p><h3><span id="我落個麺妳食啊">我落個麺妳食啊</span></h3><p>香港真的有很多麺：撈丁，腸蛋麺，餐蛋麺，魚蛋粗麺……</p><img src="/2016/11/HK-in-my-eyes/food/2016-10-04_101506.jpg" title="腸蛋麺。雖然賣相不好，但是遠足那幾天吃最多就是這貨了"><img src="/2016/11/HK-in-my-eyes/food/DSC01238.jpg" title="撈丁，蘭芳園"><img src="/2016/11/HK-in-my-eyes/food/DSC01497.JPG" title="牛雜粉"><h3><span id="奶茶-菠蘿油">奶茶、菠蘿油</span></h3><img src="/2016/11/HK-in-my-eyes/food/DSC01235.jpg" title="奶茶、牛扒包？，蘭芳園"><h3><span id="燒味">燒味</span></h3><p>叉燒、燒鵝、燒鴨、燒雞、油雞，茶餐廳必備！從太平山頂下來就直奔 <em>再興燒臘</em> 了。</p><img src="/2016/11/HK-in-my-eyes/food/DSC01360.jpg" title="再興燒臘，灣仔軒尼詩道265號地下">]]></content>
    
    <summary type="html">
    
      &lt;p&gt;仔細想想，從旅行的定義來講，去得最多的地方，居然是香港🇭🇰，這個起初我很不喜歡的地方。說到香港，很多人的第壹印象大多會是這樣：&lt;/p&gt;
&lt;img src=&quot;/2016/11/HK-in-my-eyes/HongKongIsland/DSC01355.jpg&quot; title=&quot;太平山頂&quot;&gt;
    
    </summary>
    
      <category term="旅行" scheme="http://csbun.github.io/blog/categories/%E6%97%85%E8%A1%8C/"/>
    
    
      <category term="美食" scheme="http://csbun.github.io/blog/tags/%E7%BE%8E%E9%A3%9F/"/>
    
      <category term="风景" scheme="http://csbun.github.io/blog/tags/%E9%A3%8E%E6%99%AF/"/>
    
  </entry>
  
  <entry>
    <title>删除本地 Docker 镜像</title>
    <link href="http://csbun.github.io/blog/2016/09/docker-remove-image/"/>
    <id>http://csbun.github.io/blog/2016/09/docker-remove-image/</id>
    <published>2016-09-28T02:42:21.000Z</published>
    <updated>2020-11-03T11:52:46.335Z</updated>
    
    <content type="html"><![CDATA[<p>使用 Docker 会遗留一大堆不知道什么鬼的镜像，下面我们想办法干掉他们。</p><h2><span id="tldr">TL;DR</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a | grep <span class="string">'Exited'</span> | awk <span class="string">'&#123;print $1&#125;'</span> | xargs docker stop | xargs docker rm</span><br><span class="line">docker images | grep <span class="string">'&lt;none&gt;'</span> | awk <span class="string">'&#123;print $3&#125;'</span> | xargs docker rmi</span><br></pre></td></tr></table></figure><a id="more"></a><h2><span id="直接删除">直接删除</span></h2><p>启动 Docker（如果没有启动的话），mac 下运行如下命令：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">boot2docker start</span><br></pre></td></tr></table></figure></p><p>然后可以查看现有的本地镜像</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure><p>从如下的输出结果可以看到有很多没有但占据硬盘空间的镜像：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY                         TAG                 IMAGE ID            CREATED             VIRTUAL SIZE</span><br><span class="line">csbun/docker-centos6.6-java7-git   1.0                 4daba39c348a        3 weeks ago         1.183 GB</span><br><span class="line">csbun/docker-centos6.6-java7-git   latest              4daba39c348a        3 weeks ago         1.183 GB</span><br><span class="line">&lt;none&gt;                             &lt;none&gt;              e146cf64f30e        3 weeks ago         1.181 GB</span><br><span class="line">&lt;none&gt;                             &lt;none&gt;              139e0f6180fb        4 weeks ago         534 MB</span><br><span class="line">...</span><br><span class="line">centos                             6.6                 8668efb40032        12 weeks ago        202.6 MB</span><br><span class="line">hello-world                        latest              91c95931e552        17 months ago       910 B</span><br></pre></td></tr></table></figure><p>于是我们可以直接通过上面的 <code>IMAGE ID</code> 删除这个镜像</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi &lt;image-id&gt;</span><br></pre></td></tr></table></figure><p>如无意外，这个镜像嘟嘟嘟就会被干掉。然而很不幸大多数时候都会提示下来错误，表示镜像正在被某个容器 <code>container</code> 使用：</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Error </span>response from daemon: Conflict, cannot delete 91c95931e552 because the container 429166761c13 is using it, use -f to force</span><br></pre></td></tr></table></figure><p>如上，<code>container id</code> 为 <code>429166761c13</code>，知道这个 id 我们就能停止容器，然后重新删除镜像：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">ps</span> -<span class="keyword">a</span> | <span class="keyword">grep</span> <span class="symbol">&lt;container-id&gt;</span></span><br><span class="line">docker <span class="keyword">stop</span> <span class="symbol">&lt;container-id&gt;</span></span><br><span class="line">docker rm <span class="symbol">&lt;container-id&gt;</span></span><br><span class="line">docker rmi <span class="symbol">&lt;image-id&gt;</span></span><br></pre></td></tr></table></figure><h2><span id="批量删除">批量删除</span></h2><p>但是镜像好多怎么办？容器更多怎么办？只能写脚本批量删除了：</p><p>首先我们通过 <code>docker ps -a</code> 找出所有已经退出的容器并用 <code>docker stop</code> 和 <code>docker rm</code> 将其干掉，保证镜像没有被占用：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a | grep <span class="string">'Exited'</span> | awk <span class="string">'&#123;print $1&#125;'</span> | xargs docker stop | xargs docker rm</span><br></pre></td></tr></table></figure><p>然后再尝试删除镜像：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images | grep <span class="string">'&lt;none&gt;'</span> | awk <span class="string">'&#123;print $3&#125;'</span> | xargs docker rmi</span><br></pre></td></tr></table></figure><p>OK，一切都干净了。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;使用 Docker 会遗留一大堆不知道什么鬼的镜像，下面我们想办法干掉他们。&lt;/p&gt;
&lt;h2 id=&quot;TL-DR&quot;&gt;&lt;a href=&quot;#TL-DR&quot; class=&quot;headerlink&quot; title=&quot;TL;DR&quot;&gt;&lt;/a&gt;TL;DR&lt;/h2&gt;&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;docker ps -a | grep &lt;span class=&quot;string&quot;&gt;&#39;Exited&#39;&lt;/span&gt; | awk &lt;span class=&quot;string&quot;&gt;&#39;&amp;#123;print $1&amp;#125;&#39;&lt;/span&gt; | xargs docker stop | xargs docker rm&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker images | grep &lt;span class=&quot;string&quot;&gt;&#39;&amp;lt;none&amp;gt;&#39;&lt;/span&gt; | awk &lt;span class=&quot;string&quot;&gt;&#39;&amp;#123;print $3&amp;#125;&#39;&lt;/span&gt; | xargs docker rmi&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Docker" scheme="http://csbun.github.io/blog/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>GitLab CI Runner with Docker</title>
    <link href="http://csbun.github.io/blog/2016/09/gitlab-ci-runner-with-docker/"/>
    <id>http://csbun.github.io/blog/2016/09/gitlab-ci-runner-with-docker/</id>
    <published>2016-09-04T10:32:07.000Z</published>
    <updated>2020-11-03T11:52:46.335Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="install-ci-runner">Install CI Runner:</span></h2><p>Install a <a href="https://about.gitlab.com/gitlab-ci/" target="_blank" rel="noopener">CI Runner</a> on a machine is quite <a href="https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/#installation" target="_blank" rel="noopener">easy</a>, here is the <a href="https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/blob/master/docs/install/linux-repository.md" target="_blank" rel="noopener">linux-repository</a>:<br>在一台普通机器上安装 <a href="https://about.gitlab.com/gitlab-ci/" target="_blank" rel="noopener">CI Runner</a> 应该是一件<a href="https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/#installation" target="_blank" rel="noopener">很简单的事情</a>，下面是 <a href="https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/blob/master/docs/install/linux-repository.md" target="_blank" rel="noopener">Linux 的安装方法</a>：</p><p>Add GitLab’s official repository via apt-get or yum:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># For Debian/Ubuntu</span></span><br><span class="line">curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-ci-multi-runner/script.deb.sh | sudo bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># For CentOS</span></span><br><span class="line">curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-ci-multi-runner/script.rpm.sh | sudo bash</span><br></pre></td></tr></table></figure><a id="more"></a><p>Install <code>gitlab-ci-multi-runner</code>:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># For Debian/Ubuntu</span></span><br><span class="line">sudo apt-get install gitlab-ci-multi-runner</span><br><span class="line"></span><br><span class="line"><span class="comment"># For CentOS</span></span><br><span class="line">sudo yum install gitlab-ci-multi-runner</span><br></pre></td></tr></table></figure><h2><span id="register-a-specific-runner">Register a Specific Runner</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-ci-multi-runner register</span><br></pre></td></tr></table></figure><p>Answer the following questions after this command:<br>运行上面这段脚本将需要你回答几个问题：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Please enter the gitlab-ci coordinator URL (e.g. https://gitlab.com/ci ):</span><br><span class="line">https://gitlab.com/ci</span><br><span class="line">Please enter the gitlab-ci token for this runner:</span><br><span class="line">xxx</span><br><span class="line">Please enter the gitlab-ci description for this runner:</span><br><span class="line">my-runner</span><br><span class="line">Please enter the gitlab-ci tags for this runner (comma separated):</span><br><span class="line">ci,runner</span><br><span class="line">INFO[0034] fcf5c619 Registering runner... succeeded</span><br><span class="line">Please enter the executor: docker-ssh+machine, docker, docker-ssh, parallels, shell, ssh, virtualbox, docker+machine:</span><br><span class="line">shell</span><br></pre></td></tr></table></figure><p>You can find the answer of the first 2 questions in the <code>Specific runners</code> section, <strong>Runners Page</strong> of your gitlab repo(<strong>Settings</strong> -&gt; <strong>Runners</strong>). We choose <code>shell</code> executor for the first time. Refresh the <strong>Runners Page</strong> you will see <code>my-runner</code> in the <code>Specific runners</code> list.<br>头两个问题的答案就在项目的 <strong>Runners 页面</strong>（<strong>Settings</strong> -&gt; <strong>Runners</strong>）<code>Specific runners</code> 区域。方便验证起见，我们先选择 <code>shell</code> executor。刷新页面就能看的刚刚注册的 <code>my-runner</code> 出现在列表中。</p><p><img src="https://gitlab.com/help/ci/quick_start/img/runners_activated.png" alt="image from https://gitlab.com/help/ci/quick_start/README.md#configuring-a-runner"></p><h2><span id="running-the-specific-runner">Running the Specific Runner</span></h2><p>Click the <code>Disable Shared runners</code> button on the <strong>Runners Page</strong> so we can just use our runner register just now on each build. After commiting <em>.gitlab-ci.yml</em> (the file that is used by GitLab Runner to <a href="http://docs.gitlab.com/ce/ci/yaml/README.html" target="_blank" rel="noopener">manage your project’s build</a>), we will see jobs running in the <strong>Builds Page</strong> (or <strong>Pipelines Page</strong>) on each push.<br>为了每次都运行我们刚刚注册的 runner，需要点击 <strong>Runners 页</strong> 的 <code>Disable Shared runners</code> 按钮，放弃 Gitlab 提供的共享 runner。提交了 <em>.gitlab-ci.yml</em> <a href="http://docs.gitlab.com/ce/ci/yaml/README.html" target="_blank" rel="noopener">构建文件</a> 文件的项目，每次 push 都可以在 <strong>Builds 页面</strong> (or <strong>Pipelines 页面</strong>) 看到进度。</p><h2><span id="docker-executor">Docker Executor</span></h2><p>If you want to use Docker runner, <a href="https://docs.docker.com/engine/installation/" target="_blank" rel="noopener">install</a> and start it before using the multi runner:<br><a href="https://docs.docker.com/engine/installation/" target="_blank" rel="noopener">安装</a> Docker，用作 runner。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install</span></span><br><span class="line">curl -sSL https://get.docker.com/ | sh</span><br><span class="line"><span class="comment"># UPDATE: 2017-07-25: install docker for CentOS6：</span></span><br><span class="line"><span class="comment"># rpm -iUvh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</span></span><br><span class="line"><span class="comment"># yum update -y</span></span><br><span class="line"><span class="comment"># yum -y install docker-io</span></span><br><span class="line"><span class="comment"># UPDATE: END</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># start the Docker daemon on CentOS</span></span><br><span class="line">sudo service docker start</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># start the Docker daemon on Mac</span></span><br><span class="line">boot2docker start</span><br></pre></td></tr></table></figure><p>Now we can register a specific docker runner:<br>现在就能注册一个 docker runner：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-ci-multi-runner register</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Please enter the executor: docker-ssh+machine, docker, docker-ssh, parallels, shell, ssh, virtualbox, docker+machine:</span><br><span class="line">docker</span><br><span class="line">Please enter the default Docker image (eg. ruby:2.1):</span><br><span class="line">centos:7</span><br></pre></td></tr></table></figure><p>Here we use a simple <a href="https://hub.docker.com/_/centos/" target="_blank" rel="noopener">centos7 docker image</a>. Now we have a pure environment at each build.<br>这里我们选了一个 <a href="https://hub.docker.com/_/centos/" target="_blank" rel="noopener">centos7 的 Docker 镜像</a>，这样我们每次构建都有一个“纯净”的环境。</p><h3><span id="create-docker-image">Create Docker Image</span></h3><p>Centos7 might too simple to do complex build with special requirements. We can <a href="https://docs.docker.com/engine/getstarted/step_four/" target="_blank" rel="noopener">build our own image</a> by <a href="https://docs.docker.com/engine/reference/builder/" target="_blank" rel="noopener">creating</a> a <em>Dockerfile</em>, Base <code>FROM</code> centos and installed with java7 using <code>RUN</code> command.<br>当我们需要复杂的构建环境时，Centos7 明显是不够用的。所以我们可以<a href="https://docs.docker.com/engine/getstarted/step_four/" target="_blank" rel="noopener">自己做一个镜像</a>，只需<a href="https://docs.docker.com/engine/reference/builder/" target="_blank" rel="noopener">创建</a>一个 <em>Dockerfile</em> 文件，声明基于（<code>FROM</code>）centos，且通过 <code>RUN</code> 命令安装 java7。</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> Hans Chan &lt;icsbun@gmail.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># yum install dependences</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install -y java-1.7.0-openjdk \</span></span><br><span class="line"><span class="bash">                   java-1.7.0-openjdk-devel</span></span><br></pre></td></tr></table></figure><p><a href="http://csbun.github.io/blog/2015/06/docker-with-node/#build-and-push">Build</a> it on your machine:<br>在你的机器上<a href="http://csbun.github.io/blog/2015/06/docker-with-node/#build-and-push">构建</a>这个镜像：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t &lt;docker-user-name&gt;/&lt;docker-image-name&gt; .</span><br></pre></td></tr></table></figure><p>Run it on your machine:<br>在你的机器上运行这个镜像：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># login bash</span></span><br><span class="line">docker run -i -t &lt;docker-user-name&gt;/&lt;docker-image-name&gt; /bin/bash</span><br><span class="line"><span class="comment"># check the java version</span></span><br><span class="line">java -version</span><br></pre></td></tr></table></figure><p>Push it to <a href="https://hub.docker.com/" target="_blank" rel="noopener">Docker Hub</a> if you <a href="https://docs.docker.com/engine/getstarted/step_five/" target="_blank" rel="noopener">have an account</a>:<br>如果你有一个 <a href="https://hub.docker.com/" target="_blank" rel="noopener">Docker Hub</a> <a href="https://docs.docker.com/engine/getstarted/step_five/" target="_blank" rel="noopener">账户</a>，你就能把你的镜像推送到公网上了：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push &lt;docker-user-name&gt;/&lt;docker-image-name&gt;</span><br></pre></td></tr></table></figure><p>Here is a <a href="https://hub.docker.com/r/csbun/docker-centos6.6-java7-git/" target="_blank" rel="noopener">full example</a> base on Centos6.6, which contains java7 and git CLI.<br>这里我写了一个<a href="https://hub.docker.com/r/csbun/docker-centos6.6-java7-git/" target="_blank" rel="noopener">相对完整的示例</a>，包含了 java7 和 git 命令行等。</p><h3><span id="config-specific-runner">Config Specific Runner</span></h3><p><a href="https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/blob/master/docs/configuration/advanced-configuration.md" target="_blank" rel="noopener">GitLab Runner configuration</a> uses the TOML format.<br>The file to be edited can be found in: <em>/etc/gitlab-runner/config.toml</em> (on *nix systems as root). Change the <code>image</code> parameter in [runners.docker] section to <code>&lt;docker-user-name&gt;/&lt;docker-image-name&gt;</code> created by yourself, restart runner an have fun!<br><a href="https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/blob/master/docs/configuration/advanced-configuration.md" target="_blank" rel="noopener">GitLab Runner 配置</a> 使用 TOML 格式的文件，放在 <em>/etc/gitlab-runner/config.toml</em> （root 权限运行的 *nix 系统）。把 [runners.docker] 段落中的 <code>image</code> 参数改成刚刚创建的 <code>&lt;docker-user-name&gt;/&lt;docker-image-name&gt;</code> 镜像，重启 runner 即可：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-ci-multi-runner restart</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Install-CI-Runner&quot;&gt;&lt;a href=&quot;#Install-CI-Runner&quot; class=&quot;headerlink&quot; title=&quot;Install CI Runner:&quot;&gt;&lt;/a&gt;Install CI Runner:&lt;/h2&gt;&lt;p&gt;Install a &lt;a href=&quot;https://about.gitlab.com/gitlab-ci/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;CI Runner&lt;/a&gt; on a machine is quite &lt;a href=&quot;https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/#installation&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;easy&lt;/a&gt;, here is the &lt;a href=&quot;https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/blob/master/docs/install/linux-repository.md&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;linux-repository&lt;/a&gt;:&lt;br&gt;在一台普通机器上安装 &lt;a href=&quot;https://about.gitlab.com/gitlab-ci/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;CI Runner&lt;/a&gt; 应该是一件&lt;a href=&quot;https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/#installation&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;很简单的事情&lt;/a&gt;，下面是 &lt;a href=&quot;https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/blob/master/docs/install/linux-repository.md&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Linux 的安装方法&lt;/a&gt;：&lt;/p&gt;
&lt;p&gt;Add GitLab’s official repository via apt-get or yum:&lt;/p&gt;
&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# For Debian/Ubuntu&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-ci-multi-runner/script.deb.sh | sudo bash&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# For CentOS&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-ci-multi-runner/script.rpm.sh | sudo bash&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Docker" scheme="http://csbun.github.io/blog/tags/Docker/"/>
    
      <category term="ci" scheme="http://csbun.github.io/blog/tags/ci/"/>
    
  </entry>
  
  <entry>
    <title>Vue 2.0 Server-Side Rendering</title>
    <link href="http://csbun.github.io/blog/2016/08/vue-2-0-server-side-rendering/"/>
    <id>http://csbun.github.io/blog/2016/08/vue-2-0-server-side-rendering/</id>
    <published>2016-08-03T08:52:04.000Z</published>
    <updated>2020-11-03T11:52:46.334Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/vuejs/vue/issues/2873" target="_blank" rel="noopener">Vue 2.0</a> is now in beta6. What I am going to do is checkout how to use <a href="https://www.npmjs.com/package/vue-server-renderer" target="_blank" rel="noopener">SSR (server-side rendering)</a>.</p><a id="more"></a><h2><span id="simple-example">Simple Example</span></h2><p>Let’s make a project first and install some dependencies:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir vue-ssr</span><br><span class="line"><span class="built_in">cd</span> vue-ssr</span><br><span class="line">npm init</span><br><span class="line">npm i vue@next vue-server-renderer --save</span><br></pre></td></tr></table></figure><p>Here is what we get in <em>package.json</em>:</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"vue-ssr"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">  <span class="attr">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"vue"</span>: <span class="string">"^2.0.0-beta.6"</span>,</span><br><span class="line">    <span class="attr">"vue-server-renderer"</span>: <span class="string">"^2.0.0-beta.6"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Now we can render a Vue instance to string:</p><figure class="highlight javascript"><figcaption><span>ssr.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Vue = <span class="built_in">require</span>(<span class="string">'vue'</span>);</span><br><span class="line"><span class="keyword">const</span> renderer = <span class="built_in">require</span>(<span class="string">'vue-server-renderer'</span>).createRenderer();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Cmp = Vue.component(<span class="string">'my-cmp'</span>, &#123;</span><br><span class="line">  template: <span class="string">`&lt;p&gt;this is a component&lt;/p&gt;`</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> App = Vue.component(<span class="string">'my-app'</span>, &#123;</span><br><span class="line">  components: &#123;</span><br><span class="line">    MyCmp,</span><br><span class="line">  &#125;,</span><br><span class="line">  template: <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div class="server-uptime"&gt;</span></span><br><span class="line"><span class="string">      &lt;h1&gt;&#123;&#123;name&#125;&#125;&lt;/h1&gt;</span></span><br><span class="line"><span class="string">      &lt;h2&gt;age &#123;&#123;age&#125;&#125;&lt;/h2&gt;</span></span><br><span class="line"><span class="string">      &lt;my-cmp&gt;&lt;/my-cmp&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> vm = <span class="keyword">new</span> App(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    name: <span class="string">'Hans'</span>,</span><br><span class="line">    age: <span class="number">18</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">renderer.renderToString(vm, (err, html) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (err)&#123;</span><br><span class="line">    <span class="built_in">console</span>.error(err.message);</span><br><span class="line">    <span class="built_in">console</span>.error(err.stack);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(html);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>Run <code>node ssr.js</code> comes out the html string:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">server-rendered</span>=<span class="string">"true"</span> <span class="attr">class</span>=<span class="string">"server-uptime"</span>&gt;</span><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hans<span class="tag">&lt;/<span class="name">h1</span>&gt;</span> <span class="tag">&lt;<span class="name">h2</span>&gt;</span>age 18<span class="tag">&lt;/<span class="name">h2</span>&gt;</span> <span class="tag">&lt;<span class="name">p</span>&gt;</span>this is a component<span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p> The root element has a <code>server-rendered=&quot;true&quot;</code> attribute. We’ll talk about it <a href="#client-side-hydration">later</a>.</p><h2><span id="bundle-renderer">Bundle Renderer</span></h2><p>In most cases, we use numerous <em>.vue</em> files. As we have:</p><figure class="highlight html"><figcaption><span>src/App.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"my-app"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123;name&#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>age: &#123;&#123;age&#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">my-cmp</span> <span class="attr">:name</span>=<span class="string">"name"</span>&gt;</span><span class="tag">&lt;/<span class="name">my-cmp</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">import</span> MyCmp <span class="keyword">from</span> <span class="string">'./MyCmp.vue'</span>;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">randNum</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">return</span> <span class="built_in">Math</span>.round(<span class="built_in">Math</span>.random() * <span class="number">100</span>);</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="undefined">  components: &#123;</span></span><br><span class="line"><span class="undefined">    MyCmp,</span></span><br><span class="line"><span class="undefined">  &#125;,</span></span><br><span class="line"><span class="undefined">  data() &#123;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">      name: <span class="string">`Hans-<span class="subst">$&#123;randNum()&#125;</span>`</span>,</span></span><br><span class="line"><span class="undefined">      age: randNum(),</span></span><br><span class="line"><span class="undefined">    &#125;;</span></span><br><span class="line"><span class="undefined">  &#125;,</span></span><br><span class="line"><span class="undefined">&#125;;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css"><span class="selector-class">.my-app</span> &#123;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">background</span>: <span class="selector-id">#eee</span>;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight html"><figcaption><span>src/MyCmp.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Hello &#123;&#123; name &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Welcome to China!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="actionscript">  props: [ <span class="string">'name'</span> ],</span></span><br><span class="line"><span class="actionscript">  replace: <span class="literal">false</span>,</span></span><br><span class="line"><span class="undefined">&#125;;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>In our server-side entry point, export a function. The function will receive the render context object (passed to bundleRenderer.renderToString or bundleRenderer.renderToStream), and should return a Promise, which should eventually resolve to the app’s root Vue instance:</p><figure class="highlight javascript"><figcaption><span>server.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server-entry.js</span></span><br><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span>;</span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App.vue'</span>;</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Vue(App);</span><br><span class="line"></span><br><span class="line"><span class="comment">// the default export should be a function</span></span><br><span class="line"><span class="comment">// which will receive the context of the render call</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>(<span class="params">context</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    resolve(app);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>We can easily use <a href="https://webpack.github.io/" target="_blank" rel="noopener">webpack</a> + <a href="https://www.npmjs.com/package/vue-loader" target="_blank" rel="noopener">vue-loader</a> with the bundleRenderer.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i webpack vue-loader@next babel-loader babel-preset-es2015 --save-dev</span><br></pre></td></tr></table></figure><p> We do need to use a slightly different <em>webpack.config.js</em> and entry point for our server-side bundle.</p><figure class="highlight javascript"><figcaption><span>webpack/webpack.server.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> projectRoot = path.resolve(__dirname, <span class="string">'..'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  target: <span class="string">'node'</span>, <span class="comment">// !different</span></span><br><span class="line">  entry: path.join(projectRoot, <span class="string">'src/server.js'</span>),</span><br><span class="line">  output: &#123;</span><br><span class="line">    libraryTarget: <span class="string">'commonjs2'</span>, <span class="comment">// !different</span></span><br><span class="line">    path: path.join(projectRoot, <span class="string">'dist'</span>),</span><br><span class="line">    filename: <span class="string">'bundle.server.js'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    loaders: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.vue$/</span>,</span><br><span class="line">        loader: <span class="string">'vue'</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        loader: <span class="string">'babel'</span>,</span><br><span class="line">        include: projectRoot,</span><br><span class="line">        exclude: <span class="regexp">/node_modules/</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>And <em>.babelrc</em> is needed:</p><figure class="highlight json"><figcaption><span>.babelrc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"presets"</span>: [ <span class="string">"es2015"</span> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Run <code>webpack --config webpack/webpack.server.js</code> we’ll get a <em>dist/bundle.server.js</em> file as the server-side bundle which can be read in server-side.</p><figure class="highlight javascript"><figcaption><span>ssr-bundle.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> vueServerRenderer = <span class="built_in">require</span>(<span class="string">'vue-server-renderer'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> filePath = path.join(__dirname, <span class="string">'./dist/bundle.server.js'</span>)</span><br><span class="line"><span class="keyword">const</span> code = fs.readFileSync(filePath, <span class="string">'utf8'</span>);</span><br><span class="line"><span class="keyword">const</span> bundleRenderer = vueServerRenderer.createBundleRenderer(code);</span><br><span class="line"></span><br><span class="line">bundleRenderer.renderToString(<span class="function">(<span class="params">err, html</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (err)&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err.message);</span><br><span class="line">    <span class="built_in">console</span>.log(err.stack);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(html);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>Run <code>node ssr-bundle.js</code> comes out a similar html string:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">server-rendered</span>=<span class="string">"true"</span> <span class="attr">class</span>=<span class="string">"my-app"</span>&gt;</span><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hans-97<span class="tag">&lt;/<span class="name">h1</span>&gt;</span> <span class="tag">&lt;<span class="name">h2</span>&gt;</span>age&amp;colon; 20<span class="tag">&lt;/<span class="name">h2</span>&gt;</span> <span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">p</span>&gt;</span>Hello Hans-97<span class="tag">&lt;/<span class="name">p</span>&gt;</span> <span class="tag">&lt;<span class="name">p</span>&gt;</span>Welcome to China&amp;excl;<span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><h2><span id="client-side-hydration">Client Side Hydration</span></h2><p>First of all, we have to create another bundle file for client-side. A <em>webpack.client.js</em> is needed. It is almost the same with <em>webpack.server.js</em> except <strong>NOT</strong> having <code>target: &#39;node&#39;</code> and <code>output.libraryTarget: &#39;commonjs2&#39;</code>, which bundle the client-side entry file:</p><figure class="highlight javascript"><figcaption><span>src/client.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span>;</span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App.vue'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> VueApp = Vue.extend(App);</span><br><span class="line"><span class="keyword">new</span> VueApp(&#123;</span><br><span class="line">  el: <span class="string">'.my-app'</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>Then we will improve the above <em>ssr-bundle.js</em> example to an express server:</p><figure class="highlight javascript"><figcaption><span>server/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> vueServerRenderer = <span class="built_in">require</span>(<span class="string">'vue-server-renderer'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Server-Side Bundle File</span></span><br><span class="line"><span class="keyword">const</span> serverBundleFilePath = path.join(__dirname, <span class="string">'../dist/bundle.server.js'</span>)</span><br><span class="line"><span class="keyword">const</span> serverBundleFileCode = fs.readFileSync(serverBundleFilePath, <span class="string">'utf8'</span>);</span><br><span class="line"><span class="keyword">const</span> bundleRenderer = vueServerRenderer.createBundleRenderer(serverBundleFileCode);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Client-Side Bundle File</span></span><br><span class="line"><span class="keyword">const</span> clientBundleFilePath = path.join(__dirname, <span class="string">'../dist/bundle.client.js'</span>);</span><br><span class="line"><span class="keyword">const</span> clientBundleFileUrl = <span class="string">'/bundle.client.js'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Server-Side Rendering</span></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  bundleRenderer.renderToString(<span class="function">(<span class="params">err, html</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err)&#123;</span><br><span class="line">      res.status(<span class="number">500</span>).send(<span class="string">`</span></span><br><span class="line"><span class="string">        &lt;h1&gt;Error: <span class="subst">$&#123;err.message&#125;</span>&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;pre&gt;<span class="subst">$&#123;err.stack&#125;</span>&lt;/pre&gt;</span></span><br><span class="line"><span class="string">      `</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      res.send(<span class="string">`</span></span><br><span class="line"><span class="string">        &lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">        &lt;html&gt;</span></span><br><span class="line"><span class="string">          &lt;head&gt;</span></span><br><span class="line"><span class="string">            &lt;meta charset="utf-8"&gt;</span></span><br><span class="line"><span class="string">            &lt;title&gt;Vue 2.0 SSR&lt;/title&gt;</span></span><br><span class="line"><span class="string">          &lt;/head&gt;</span></span><br><span class="line"><span class="string">          &lt;body&gt;</span></span><br><span class="line"><span class="string">            <span class="subst">$&#123;html&#125;</span></span></span><br><span class="line"><span class="string">            &lt;script src="<span class="subst">$&#123;clientBundleFileUrl&#125;</span>"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">          &lt;/body&gt;</span></span><br><span class="line"><span class="string">        &lt;/html&gt;`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Client-Side Bundle File</span></span><br><span class="line">app.get(clientBundleFileUrl, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> clientBundleFileCode = fs.readFileSync(clientBundleFilePath, <span class="string">'utf8'</span>);</span><br><span class="line">  res.send(clientBundleFileCode);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Start server</span></span><br><span class="line"><span class="keyword">const</span> PORT = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line">app.listen(PORT, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Example app listening on port <span class="subst">$&#123;PORT&#125;</span>!`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><blockquote><p> For each render call, the code will be re-run in a new context using Node.js’ vm module. This ensures your application state is discrete between requests, and you don’t need to worry about structuring your application in a limiting pattern just for the sake of SSR.</p></blockquote><p>Now, start the server and hit <a href="http://127.0.0.1:3000/" target="_blank" rel="noopener">http://127.0.0.1:3000/</a> on your favorite browser. But we get a warning message in the DevTool:</p><p><code>[Vue warn]: The client-side rendered virtual DOM tree is not matching server-rendered content. Bailing hydration and performing full client-side render.</code></p><p>Cause we have the <code>data()</code> function returning a random value in <em>src/App.vue</em>, so we got different html string form server and client via virtual-DOM.</p><blockquote><p>In server-rendered output, the root element will have the server-rendered=”true” attribute. On the client, when you mount a Vue instance to an element with this attribute, it will attempt to “hydrate” the existing DOM instead of creating new DOM nodes.</p></blockquote><p>Let’s make some change:</p><figure class="highlight html"><figcaption><span>src/App.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"my-app"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123;name&#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>age: &#123;&#123;age&#125;&#125; <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"plus"</span>&gt;</span>+1<span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">my-cmp</span> <span class="attr">:name</span>=<span class="string">"name"</span>&gt;</span><span class="tag">&lt;/<span class="name">my-cmp</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">import</span> MyCmp <span class="keyword">from</span> <span class="string">'./MyCmp.vue'</span>;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="undefined">  components: &#123;</span></span><br><span class="line"><span class="undefined">    MyCmp,</span></span><br><span class="line"><span class="undefined">  &#125;,</span></span><br><span class="line"><span class="undefined">  data() &#123;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="actionscript">      name: <span class="string">'Hans'</span>,</span></span><br><span class="line"><span class="undefined">      age: 0,</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  &#125;,</span></span><br><span class="line"><span class="undefined">  created() &#123;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="string">'created &gt; '</span> + <span class="keyword">this</span>.age);</span></span><br><span class="line"><span class="actionscript">    ++<span class="keyword">this</span>.age;</span></span><br><span class="line"><span class="undefined">  &#125;,</span></span><br><span class="line"><span class="undefined">  methods: &#123;</span></span><br><span class="line"><span class="undefined">    plus() &#123;</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">this</span>.age++;</span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="undefined">  &#125;,</span></span><br><span class="line"><span class="undefined">&#125;;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css"><span class="selector-class">.my-app</span> &#123;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">background</span>: <span class="selector-id">#eee</span>;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Refresh the page and click the <code>+1</code> button. See what’s happening on both server and client side. Checkout <a href="https://github.com/csbun/vue2-ssr-example" target="_blank" rel="noopener">this repo</a> to see the full example.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://github.com/vuejs/vue/issues/2873&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Vue 2.0&lt;/a&gt; is now in beta6. What I am going to do is checkout how to use &lt;a href=&quot;https://www.npmjs.com/package/vue-server-renderer&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;SSR (server-side rendering)&lt;/a&gt;.&lt;/p&gt;
    
    </summary>
    
    
      <category term="Vue" scheme="http://csbun.github.io/blog/tags/Vue/"/>
    
      <category term="ssr" scheme="http://csbun.github.io/blog/tags/ssr/"/>
    
  </entry>
  
  <entry>
    <title>“氵忄曼”台湾</title>
    <link href="http://csbun.github.io/blog/2016/04/culture-and-people-of-taiwan/"/>
    <id>http://csbun.github.io/blog/2016/04/culture-and-people-of-taiwan/</id>
    <published>2016-04-21T09:44:59.000Z</published>
    <updated>2020-11-03T11:52:46.314Z</updated>
    
    <content type="html"><![CDATA[<p>嗯，距离创建这个个博客文件已经有 2 个月了，都快要出发下一次远行了，还在写上一个地方的游记。（当我发布时，我已经从斯里兰卡回来了……😂）</p><h2><span id="漫慢">漫慢</span></h2><p>我的理解，<strong>“漫慢”</strong> 是台湾人（特别是台南人）的一种处世之道，一种生活态度。</p><a id="more"></a><h3><span id="漫但不散漫">漫但不散漫</span></h3><p>一场名为“南吼”的草地音乐会，没有电视广告，也没有卡片传单。我们从民宿房东的口中获知这个信息，在觅食回来的路上顺道去感受一番。时值下午，听众大多都懒坐在有树荫的地方，也有铁杆粉丝和穿着统一的志愿者顶着烈日在最佳位置加油助威。我们一开始也是挑了个靠边的树荫位置，席地而坐。听着本土歌手唱着一首首原创歌曲，看着愈来愈多人在周围坐下：有三五成群的年轻人带着食物饮料，边吃边聊；有外国夫妇抱着婴儿、带着小孩，嬉戏玩耍。直到我们的肚子饿得咕咕叫时，已经是傍晚时分，有更多的人坐到了草地中间，我们也不得不起身离开这份清闲。但这场已经进行了大半天的音乐会还将继续，还会有更多的人前来观看。</p><img src="/2016/04/culture-and-people-of-taiwan/DSC04188.JPG" title="“南吼”草地音乐会和粉丝"><p>回到台南市区，继续寻觅各种百年老店。没错，在台南，也许石精臼上一家不起眼的小吃店，就是有近百年历史的老店；在瑞芳，走到火车站对面的美食街，随便一家推车小贩动辄也是有四五十年历史；在台东，第二市场里的小吃、饮料、卤肉饭店虽然看起来都是年轻人在打理，然则也有几十年历史。这样的情况并不是特例，在全台湾比比皆是。这并不容易，百年历史需要几代人共同努力，秉承着相同的信念，同守着一份坚持。</p><img src="/2016/04/culture-and-people-of-taiwan/DSC04083.JPG" title="全美戏院至今仍然使用手绘电影看板"><h3><span id="慢但不缓慢">慢但不缓慢</span></h3><p>这次到台湾，非常不巧，遇到突然加强为台风的杜鹃。所幸的是，我们避开了重灾的新北，南下到了花莲。台风将在次日深夜登陆，但前一天的花莲却是一片晴朗烈日当空（热带低压台风外围相对高压，嗯，我高中地理学得好好）。太鲁阁一日游回来并不尽兴，想着到七星潭捡石子看日落。此时离台风登陆还有1天多，然而在离海边老远的地方早早就拉起的警戒线，还有专人把守。于是乎，我并没有看到传说中美丽的石滩和蔚蓝的大海，但是，我看到了台湾人民快速的办事效率和谨慎的工作态度。（其实台风当天我们也顶着雨出去觅食，贪好玩到了另一个海滨公园想看看，然而在入口不远又看到了警戒线，依旧有人把守！独自一人！！在这台风天里！！！）</p><img src="/2016/04/culture-and-people-of-taiwan/DSC03543.JPG" title="有警戒线过不去不嗨森"><p>从七星潭回来，继续各种觅食。来到有名的两家包心粉圆（正宗包心粉圆 &amp; 五霸焦糖包心粉圆）点门前。那是一条不宽的单行线，我们站在门口犹豫踌躇了好久，纠结要吃哪一家（已经吃得很饱实在吃不下两家了）。猛然回头发现一辆的士被我们拦住了去路，然而他并没有闪灯更没有鸣喇叭，而是慢慢地跟在我们后面，等我们向前走。这才意识到错误的我们赶紧让开了道路，司机才慢慢加速向前离开。</p><h2><span id="热情">热情</span></h2><p>刚刚到花莲时是烤(zhong)肉(qiu)节前一天的晚上，按地图寻到<a href="https://zh.airbnb.com/rooms/7778696" target="_blank" rel="noopener">小幸福民宿</a>，一张大桌子围着5、6个人在吃烤肉，美女主人<a href="https://zh.airbnb.com/users/show/36513527" target="_blank" rel="noopener">小涵</a>热情招呼我们一起吃，我们觉得怪不好意思的，委婉拒绝。小涵招呼我们上楼之后，耐心详细地介绍民宿里面的每一项设施之后才离开。我们俩稍作休整之后背着小包准备去夜市解决晚餐，一出房间就遇到小涵端着烤的鸡翅等送了过来，说是还是要我们尝尝，盛情难却，我们也下楼加入了烤肉狂欢，吃了我在台湾最难忘的一餐：倒不只是因为可以吃到很多我爱的肉肉肉🍖、各种美味海鲜🐟和新鲜水果🍍，更重要的是认识了什么蛋糕🍰布丁🍮都会自己做的左邻右里，去过很多地方有很多故事的小涵及她的小伙伴们，还有小涵的妹妹和他的法国男票和他的法国白酒……</p><img src="/2016/04/culture-and-people-of-taiwan/P50926-211814.jpg" title="杯盘狼藉"><p>因为台风的关系，滞留花莲，后面的行程已经压缩了1天，再不离开可能就去不了绿岛潜水了。一早，我骑着提供的免费脚踏车到火车站碰运气，看有没有最新消息；而女票就在民宿边收拾东西边等我的消息。踌躇间，我突然看到一辆加开的南下列车，但距离发车时间只剩10min不到，我只能打电话给小涵求助（可能把她吵醒了），二话没说，她男票就开车把我女票送到了火车站，我们也因此赶上了这天早上仅有的一趟列车，也因此能有时间在中途的池上骑单车、吃便当。匆匆的离别，还有那个被我骑去火车站的单车，还得麻烦小涵他们再走一趟去取，这件事也一直让我感到非常内疚。</p><img src="/2016/04/culture-and-people-of-taiwan/P50929-110635.jpg" title="上传再补票"><p>到了台南，<a href="https://zh.airbnb.com/rooms/1111018" target="_blank" rel="noopener">六圓(南)</a>的帅哥房东阿硕就和我们聊了起来，得知我们希望吃吃吃，便拿出了一张简化地图和笔，开始向我们一项项介绍台南市区的道地美食，并在地图上标记好。我问他，为什么不直接重新做一张地图，把这些点都标记好，不用每次都画呢。他说，这样能更好地和客人聊天。的确，这种手把手式的“教学”互动性更强，同时也能因客人的喜好定制出他们的专属的台南地图。而且这样的聊天不止一次，在我们在六圓(南)的几天里，每天都有阿硕和格林给我们台南建议和他们的故事，甚至台中的步伐 tips。文章开头说到的“南吼”就是他们介绍我们去的，他们也是“南吼”的志愿者。至于台南乃至台湾美食，就看我之前写的这个<a href="http://csbun.github.io/blog/2015/11/eating-around-taiwan/">台湾好好呷</a>吧。</p><div><div style="width:50%;float:left;"><img src="/2016/04/culture-and-people-of-taiwan/P51006-065713.jpg" title="地图正面"></div><div style="width:50%;float:left;"><img src="/2016/04/culture-and-people-of-taiwan/P51003-234900.jpg" title="地图背面"></div><div style="clear:both;"></div></div><p>台湾人民的热情当然不能只用民宿来概括，那位在火车上和我们大谈她儿子在大陆工作的奶奶，那些路上热心指路的路人甲乙丙丁，也都让人感到温暖。</p><h2><span id="淳朴">淳朴</span></h2><p>在台北的夜里，徒步游走。一条空旷的路上并没有太多车，一位老爷爷在路边看着往来的车。我们以为他只是想要过马路（虽然他等的位置离斑马线还有十来米的距离），并没有太在意。当我们走过马路的时候，看到他也走向马路，然后把一个弹开的井盖（只有大概杯口大，听声音像是金属，应该能叫井盖吧，欢迎指正）踢回原处，然后回到路边，离开。</p><h2><span id="结语">结语</span></h2><p>通常这个时候要大大发表感慨一番，然而我并不会这样做😋。台湾的游记也就到此为止（虽然只有2篇），不写风景的专题，也是因为这样的内容网路上太多了，我们的照片虽然漂亮，但是我就是不给你们看😜。</p><img src="/2016/04/culture-and-people-of-taiwan/DSC04400.JPG" title="彩虹村">]]></content>
    
    <summary type="html">
    
      &lt;p&gt;嗯，距离创建这个个博客文件已经有 2 个月了，都快要出发下一次远行了，还在写上一个地方的游记。（当我发布时，我已经从斯里兰卡回来了……😂）&lt;/p&gt;
&lt;h2 id=&quot;漫慢&quot;&gt;&lt;a href=&quot;#漫慢&quot; class=&quot;headerlink&quot; title=&quot;漫慢&quot;&gt;&lt;/a&gt;漫慢&lt;/h2&gt;&lt;p&gt;我的理解，&lt;strong&gt;“漫慢”&lt;/strong&gt; 是台湾人（特别是台南人）的一种处世之道，一种生活态度。&lt;/p&gt;
    
    </summary>
    
      <category term="旅行" scheme="http://csbun.github.io/blog/categories/%E6%97%85%E8%A1%8C/"/>
    
    
      <category term="风土人情" scheme="http://csbun.github.io/blog/tags/%E9%A3%8E%E5%9C%9F%E4%BA%BA%E6%83%85/"/>
    
  </entry>
  
  <entry>
    <title>Modules in CommonJS and ES2015</title>
    <link href="http://csbun.github.io/blog/2016/01/modules/"/>
    <id>http://csbun.github.io/blog/2016/01/modules/</id>
    <published>2016-01-27T08:20:18.000Z</published>
    <updated>2020-11-03T11:52:46.313Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="commonjs">CommonJS</span></h2><p>Let’s see 2 examples in CommonJS:</p><a id="more"></a><ul><li>Example 1</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ----- lib.js -----</span></span><br><span class="line"><span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line">exports.up = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ++count;</span><br><span class="line">&#125;</span><br><span class="line">exports.count = count;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ----- main.js -----</span></span><br><span class="line"><span class="keyword">var</span> lib = <span class="built_in">require</span>(<span class="string">'./lib'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(lib.count); <span class="comment">// 0</span></span><br><span class="line"><span class="built_in">console</span>.log(lib.up());  <span class="comment">// 1</span></span><br><span class="line"><span class="built_in">console</span>.log(lib.count); <span class="comment">// 0</span></span><br></pre></td></tr></table></figure><p>In this case, <code>lib.count</code> in <em>main.js</em> would not change after function <code>lib.up</code> called. In <em>lib.js</em> we can see, <code>count</code> is a <strong>number</strong>, which is <a href="https://developer.mozilla.org/en-US/docs/Glossary/Primitive" target="_blank" rel="noopener">primitive</a>, so is <code>exports.count</code>. Thus, <code>exports.count</code> won’t change when we change <code>count</code>. We can change it to make a different:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ----- lib.change.js -----</span></span><br><span class="line"><span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line">exports.up = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> exports.count = ++count;</span><br><span class="line">&#125;</span><br><span class="line">exports.count = count;</span><br></pre></td></tr></table></figure><p>The follow example may looks better.</p><ul><li>Example 2</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ----- lib.2.js -----</span></span><br><span class="line"><span class="keyword">var</span> out = &#123;</span><br><span class="line">    count: <span class="number">0</span>,</span><br><span class="line">    up: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++out.count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">module</span>.exports = out;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ----- main.2.js -----</span></span><br><span class="line"><span class="keyword">var</span> lib = <span class="built_in">require</span>(<span class="string">'./lib.2'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(lib.count); <span class="comment">// 0</span></span><br><span class="line"><span class="built_in">console</span>.log(lib.up());  <span class="comment">// 1</span></span><br><span class="line"><span class="built_in">console</span>.log(lib.count); <span class="comment">// 1</span></span><br></pre></td></tr></table></figure><h2><span id="es2015-modules">ES2015 modules</span></h2><p>It’s simple to make <strong>Example 2</strong> works in ES2015:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ----- lib.js -----</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">up</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ++count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">unused</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> --count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ----- main.js -----</span></span><br><span class="line"><span class="keyword">import</span> &#123; count, up &#125; <span class="keyword">from</span> <span class="string">'./lib'</span>;</span><br><span class="line"><span class="built_in">console</span>.log(count);</span><br><span class="line"><span class="built_in">console</span>.log(up());</span><br><span class="line"><span class="built_in">console</span>.log(count);</span><br></pre></td></tr></table></figure><h3><span id="babel">Babel</span></h3><p>Using <a href="http://babeljs.io/" target="_blank" rel="noopener">Babel</a> and <a href="https://www.npmjs.com/package/babel-preset-es2015" target="_blank" rel="noopener">babel-preset-es2015</a> make it similar to our <code>lib.change.js</code>:</p><ul><li>babel lib.js</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(exports, <span class="string">"__esModule"</span>, &#123;</span><br><span class="line">    value: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br><span class="line">exports.up = up;</span><br><span class="line"><span class="comment">// ----- lib.js -----</span></span><br><span class="line"><span class="keyword">var</span> count = exports.count = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">up</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> exports.count = count += <span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>babel main.js</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _lib = <span class="built_in">require</span>(<span class="string">'./lib'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(_lib.count); <span class="comment">// ----- main.js -----</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log((<span class="number">0</span>, _lib.up)());</span><br><span class="line"><span class="built_in">console</span>.log(_lib.count);</span><br></pre></td></tr></table></figure><h3><span id="rollup">Rollup</span></h3><p><a href="http://rollupjs.org/" target="_blank" rel="noopener">Rollup</a> bundle up with less code:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ----- lib.js -----</span></span><br><span class="line"><span class="keyword">let</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">up</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ++count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(count);</span><br><span class="line"><span class="built_in">console</span>.log(up());</span><br><span class="line"><span class="built_in">console</span>.log(count);</span><br></pre></td></tr></table></figure><h2><span id="read-more">Read More</span></h2><ul><li><a href="http://www.2ality.com/2014/09/es6-modules-final.html" target="_blank" rel="noopener">ECMAScript 6 modules: the final syntax</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;CommonJS&quot;&gt;&lt;a href=&quot;#CommonJS&quot; class=&quot;headerlink&quot; title=&quot;CommonJS&quot;&gt;&lt;/a&gt;CommonJS&lt;/h2&gt;&lt;p&gt;Let’s see 2 examples in CommonJS:&lt;/p&gt;
    
    </summary>
    
    
      <category term="CommonJS" scheme="http://csbun.github.io/blog/tags/CommonJS/"/>
    
      <category term="ES2015" scheme="http://csbun.github.io/blog/tags/ES2015/"/>
    
  </entry>
  
  <entry>
    <title>Tree-shaking ES2015</title>
    <link href="http://csbun.github.io/blog/2015/12/tree-shaking-es2015/"/>
    <id>http://csbun.github.io/blog/2015/12/tree-shaking-es2015/</id>
    <published>2015-12-25T13:27:23.000Z</published>
    <updated>2020-11-03T11:52:46.312Z</updated>
    
    <content type="html"><![CDATA[<p>🌲🎅 ~~ 圣诞快乐 ~~ 🎉✨</p><h2><span id="rollup">Rollup</span></h2><p>之前看到 <a href="http://rollupjs.org/" target="_blank" rel="noopener">rollup.js</a> 就觉得很有趣，后来终于有空，把我的小项目 <a href="https://github.com/csbun/silly-datetime" target="_blank" rel="noopener">silly-datetime</a> 改成了 ES2015 然后用 Rollup 转成 CommonJS 和 UMD 两个版本分别给 <a href="https://www.npmjs.com/" target="_blank" rel="noopener">npm</a> 和 <a href="http://bower.io/" target="_blank" rel="noopener">Bower</a> 使用。</p><a id="more"></a><p>简单贴一下使用方法：在项目根目录下创建一个 <em><a href="https://github.com/csbun/silly-datetime/blob/master/rollup.js" target="_blank" rel="noopener">rollup.js</a></em> 文件，调用 Rollup 的 API，内容如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> rollup = <span class="built_in">require</span>( <span class="string">'rollup'</span> );</span><br><span class="line"><span class="keyword">var</span> babel = <span class="built_in">require</span>(<span class="string">'rollup-plugin-babel'</span>);</span><br><span class="line"></span><br><span class="line">rollup.rollup(&#123;</span><br><span class="line">  <span class="comment">// 入口文件</span></span><br><span class="line">  entry: <span class="string">'src/index.js'</span>,</span><br><span class="line">  plugins: [</span><br><span class="line">    babel()</span><br><span class="line">  ]</span><br><span class="line">&#125;).then( <span class="function"><span class="keyword">function</span> (<span class="params"> bundle </span>) </span>&#123;</span><br><span class="line">  <span class="comment">// CommonJS</span></span><br><span class="line">  bundle.write(&#123;</span><br><span class="line">    format: <span class="string">'cjs'</span>,</span><br><span class="line">    dest: <span class="string">'dest/index.js'</span></span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// UMD</span></span><br><span class="line">  bundle.write(&#123;</span><br><span class="line">    format: <span class="string">'umd'</span>,</span><br><span class="line">    moduleName: <span class="string">'SillyDatetime'</span>,</span><br><span class="line">    dest: <span class="string">'dest/index.umd.js'</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>命令行运行这个文件 <code>node rollup.js</code> 即可生成 <code>dest/index.js</code> 和 <code>dest/index.umd.js</code>。如果希望方便改组件被别的项目调用，就需进行一些配置声明，包括 <em>package.json</em></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"main"</span>: <span class="string">"dest/index.js"</span>,</span><br><span class="line">  <span class="attr">"jsnext:main"</span>: <span class="string">"src/index.js"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>和 <em>bower.json</em>：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"main"</span>: <span class="string">"dest/index.umd.js"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然而这并不是 Rollup 最强大功能的体现，因为这看不出 Tree-shaking。</p><h2><span id="tree-shaking">Tree-shaking</span></h2><blockquote><p>eliminate unused library code</p></blockquote><p>我们可以看到 <a href="https://github.com/csbun/silly-datetime" target="_blank" rel="noopener">silly-datetime</a> 提供了 <code>format</code>、<code>fromNow</code> 和 <code>locate</code> 3 个方法，然而大部分时间我们只需要用到其中的一个，如果将这么一个完整的文件 bundle 起来，将有很多无用的代码。</p><p>下面，我们将创建这么一个示例说明情况，首先我们新建一个项目，引用上述的 <a href="https://github.com/csbun/silly-datetime" target="_blank" rel="noopener">silly-datetime</a>:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm init</span><br><span class="line">npm i silly-datetime --save</span><br><span class="line">touch index.js</span><br></pre></td></tr></table></figure><p>然后我们修改 <em>index.js</em> ：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; format &#125; <span class="keyword">from</span> <span class="string">'silly-datetime'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> getStr = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> format(<span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> formatedDate = getStr();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`now is <span class="subst">$&#123;formatedDate&#125;</span>`</span>);</span><br></pre></td></tr></table></figure><h3><span id="browserify">Browserify</span></h3><p>我们先试试 Browserify，但在这之前我们需要添加一下 babel 插件：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i babelify babel-preset-es2015 --save-dev</span><br></pre></td></tr></table></figure><p>并配置一下 <em>package.json</em></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"browserify"</span>: &#123;</span><br><span class="line">    <span class="attr">"transform"</span>: [</span><br><span class="line">      [ <span class="string">"babelify"</span>, &#123; <span class="attr">"presets"</span>: [ <span class="string">"es2015"</span> ] &#125; ]</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行 <code>browserify index.js &gt; dest/bundle.browserify.js</code> 后我们可以看到 bundle 文件用的是之前已经用 rollup 生成的 <code>node_modules/silly-datetime/dest/index.js</code>。于是我们将源码复制出来</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp node_modules/silly-datetime/src/index.js lib/silly-datetime.es2015.js</span><br></pre></td></tr></table></figure><p>并改一下 <em>index.js</em>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; format &#125; <span class="keyword">from</span> <span class="string">'./lib/silly-datetime.es2015.js'</span>;</span><br></pre></td></tr></table></figure><p>再来一次如何？看到 bundle 文件已经将 ES2015 转成了 CommonJS 的 ES5:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#123;<span class="number">1</span>:[<span class="function"><span class="keyword">function</span>(<span class="params">require,module,exports</span>)</span>&#123;</span><br><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _datetimeEs = <span class="built_in">require</span>(<span class="string">'./lib/silly-datetime.es2015.js'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> getStr = <span class="function"><span class="keyword">function</span> <span class="title">getStr</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="number">0</span>, _datetimeEs.format)(<span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> formatedDate = getStr();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'now is '</span> + formatedDate);</span><br><span class="line"></span><br><span class="line">&#125;,&#123;<span class="string">"./lib/silly-datetime.es2015.js"</span>:<span class="number">2</span>&#125;],<span class="number">2</span>:[<span class="function"><span class="keyword">function</span>(<span class="params">require,module,exports</span>)</span>&#123;</span><br><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"><span class="comment">/* 注意这里 */</span></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(exports, <span class="string">"__esModule"</span>, &#123;</span><br><span class="line">  value: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br><span class="line">exports.format = format;</span><br><span class="line">exports.locate = locate;</span><br><span class="line">exports.fromNow = fromNow;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;]&#125;</span><br></pre></td></tr></table></figure><p>明显这里的 <code>locate</code> 和 <code>fromNow</code> 是不会被消灭的，即使使用了 <a href="https://github.com/mishoo/UglifyJS" target="_blank" rel="noopener">UglifyJS</a>。另外，细心的同学会发现这段代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">0</span>, _datetimeEs.format)(<span class="keyword">new</span> <span class="built_in">Date</span>());</span><br></pre></td></tr></table></figure><p>为什么会这样？看一下 <a href="http://rauschma.de/" target="_blank" rel="noopener">Dr. Axel Rauschmayer</a> 的 <a href="http://www.2ality.com/2015/12/references.html" target="_blank" rel="noopener">Why is (0,obj.prop)() not a method call?</a>。</p><h3><span id="rollup">Rollup</span></h3><p>我们看看 Rollup 的表现，一样要添加 babel 插件：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i rollup-plugin-babel babel-preset-es2015-rollup --save-dev</span><br></pre></td></tr></table></figure><p>并配置一下 <em>rollup.config.js</em>（详见 <a href="https://github.com/rollup/rollup/wiki/Command-Line-Interface" target="_blank" rel="noopener">Command-Line-Interface</a>）：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> babel <span class="keyword">from</span> <span class="string">'rollup-plugin-babel'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  entry: <span class="string">'index.js'</span>,</span><br><span class="line">  dest: <span class="string">'dest/bundle.rollup.js'</span>,</span><br><span class="line">  format: <span class="string">'umd'</span>,</span><br><span class="line">  plugins: [ babel() ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>和 <em>.babelrc</em>（详见 <a href="https://github.com/rollup/rollup-plugin-babel" target="_blank" rel="noopener">rollup-plugin-babel</a>）：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"presets"</span>: [ <span class="string">"es2015-rollup"</span> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个时候执行 <code>rollup -c rollup.config.js</code> 我们能看到生成的代码量非常的少：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">global, factory</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">typeof</span> exports === <span class="string">'object'</span> &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">module</span> !== <span class="string">'undefined'</span> ? factory() :</span><br><span class="line">  <span class="keyword">typeof</span> define === <span class="string">'function'</span> &amp;&amp; define.amd ? define(factory) :</span><br><span class="line">  factory();</span><br><span class="line">&#125;(<span class="keyword">this</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="string">'use strict'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getDateObject</span>(<span class="params">datetime</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">format</span>(<span class="params">datetime, formatStr</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ... 这里使用了 getDateObject()</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// import &#123; format &#125; from 'silly-datetime';</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> getStr = <span class="function"><span class="keyword">function</span> <span class="title">getStr</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> format(<span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> formatedDate = getStr();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'now is '</span> + formatedDate);</span><br><span class="line"></span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure><p>可以看出，完全没有多余的代码，而且甚至模块都没有了，看不到任何的 <code>require</code> 定义，<code>import</code> 的内容直接 inline 到主文档中了。这回我就好奇了，如果依赖关系再复杂一点，还会是怎样呢？于是我造了一个稍微复杂一点的 <a href="https://github.com/csbun/tree-shaking-demo/tree/master/rollup" target="_blank" rel="noopener">例子</a>，结果还是 <a href="https://github.com/csbun/tree-shaking-demo/blob/master/rollup/bundle.js" target="_blank" rel="noopener">inline 到一起了</a>！</p><p>但是，上面这两个例子都有一个问题，为嘛我需要将源码复制出来？难道不能直接 import ？</p><blockquote><p>Yes, we can!</p></blockquote><p>文章最上面我们的组件已经定义了 <code>&quot;jsnext:main&quot;: &quot;src/index.js&quot;</code>，所以在使用 rollup 的这个 <a href="https://github.com/rollup/rollup/wiki/jsnext:main" target="_blank" rel="noopener">语法糖</a> 后，我们就能直接将该组件 import 进来：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; format &#125; <span class="keyword">from</span> <span class="string">'silly-datetime'</span>;</span><br></pre></td></tr></table></figure><p>但是这样的 bundle 文件不会包含 npm package 的源码，紧急只是转化成 <code>var format = require(&#39;silly-datetime);</code>，所以我们还需要安装一个插件：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev rollup-plugin-npm</span><br></pre></td></tr></table></figure><p>加到配置里 <em>rollup.config.js</em> 面去：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> babel <span class="keyword">from</span> <span class="string">'rollup-plugin-babel'</span>;</span><br><span class="line"><span class="keyword">import</span> npm <span class="keyword">from</span> <span class="string">'rollup-plugin-npm'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  entry: <span class="string">'index.js'</span>,</span><br><span class="line">  dest: <span class="string">'dest/bundle.rollup.js'</span>,</span><br><span class="line">  format: <span class="string">'umd'</span>,</span><br><span class="line">  plugins: [</span><br><span class="line">    babel(),</span><br><span class="line">    npm(&#123;</span><br><span class="line">      jsnext: <span class="literal">true</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>出来的 bundle 文件就和上面的效果一样了~</p><h3><span id="webpack-2">webpack 2</span></h3><p>终于到这一步了，就是因为看了 Axel 的这篇 <a href="http://www.2ality.com/2015/12/webpack-tree-shaking.html" target="_blank" rel="noopener">Tree-shaking with webpack 2 and Babel 6</a> 才有了这篇文章。</p><p><a href="https://webpack.github.io/" target="_blank" rel="noopener">webpack</a> 2 目前还是 beta 版本，但是我们还是可以使用的。按照博士的说法，因为 <a href="https://www.npmjs.com/package/babel-preset-es2015" target="_blank" rel="noopener">babel-preset-es2015</a> <a href="https://github.com/babel/babel/blob/7b369674163e40241ff41e63458c8d98298e942a/packages/babel-preset-es2015/package.json" target="_blank" rel="noopener">包含</a> 了 <a href="https://www.npmjs.com/package/babel-plugin-transform-es2015-modules-commonjs" target="_blank" rel="noopener">babel-plugin-transform-es2015-modules-commonjs</a>，而 commonjs 的打包方式注定不能实现我们的 Tree-shaking 大计，所以我们不能直接使用 babel-preset-es2015，而是直接使用他所包含的除了 commonjs 以外的其他全部依赖 plugin。</p><p>这回要安装的东西就多了，如果是 npm2 的就在 <em>package.json</em> 里直接添加 devDependences 好了：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"webpack"</span>: <span class="string">"^2.0.2-beta"</span>,</span><br><span class="line">    <span class="attr">"babel-loader"</span>: <span class="string">"^6.2.0"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-template-literals"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-literals"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-function-name"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-arrow-functions"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-block-scoped-functions"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-classes"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-object-super"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-shorthand-properties"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-computed-properties"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-for-of"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-sticky-regex"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-unicode-regex"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-check-es2015-constants"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-spread"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-parameters"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-destructuring"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-block-scoping"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-typeof-symbol"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-es2015-modules-commonjs"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-regenerator"</span>: <span class="string">"^6.3.13"</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>npm i</code> 时会说 peer dependency 冲突，请忽略之，因为我们在用 beta 的 webpack。然后写一下我最不喜欢的 <em>webpack.config.js</em>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>); <span class="comment">// webpack 2</span></span><br><span class="line"><span class="keyword">var</span> dir = __dirname;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    entry: path.join(dir, <span class="string">'index.js'</span>),</span><br><span class="line">    output: &#123;</span><br><span class="line">        path: path.join(dir, <span class="string">'dest'</span>),</span><br><span class="line">        filename: <span class="string">'webpack.bundle.js'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="built_in">module</span>: &#123;</span><br><span class="line">        loaders: [&#123;</span><br><span class="line">            loader: <span class="string">'babel-loader'</span>,</span><br><span class="line">            test: dir,</span><br><span class="line">            query: &#123;</span><br><span class="line">                <span class="comment">// presets: ['es2015'],</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// All of the plugins of babel-preset-es2015,</span></span><br><span class="line">                <span class="comment">// minus babel-plugin-transform-es2015-modules-commonjs</span></span><br><span class="line">                plugins: [</span><br><span class="line">                    <span class="string">'transform-es2015-template-literals'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-literals'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-function-name'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-arrow-functions'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-block-scoped-functions'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-classes'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-object-super'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-shorthand-properties'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-computed-properties'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-for-of'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-sticky-regex'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-unicode-regex'</span>,</span><br><span class="line">                    <span class="string">'check-es2015-constants'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-spread'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-parameters'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-destructuring'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-block-scoping'</span>,</span><br><span class="line">                    <span class="string">'transform-es2015-typeof-symbol'</span>,</span><br><span class="line">                    [<span class="string">'transform-regenerator'</span>, &#123; <span class="attr">async</span>: <span class="literal">false</span>, <span class="attr">asyncGenerators</span>: <span class="literal">false</span> &#125;],</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;]</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="comment">// Avoid publishing files when compilation fails</span></span><br><span class="line">        <span class="keyword">new</span> webpack.NoErrorsPlugin()</span><br><span class="line">    ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>因为 webpack 也不认识 <code>jsnext:main</code>，我们还是需要直接 import ES2015 的源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; format &#125; <span class="keyword">from</span> <span class="string">'./lib/silly-datetime.es2015.js'</span>;</span><br></pre></td></tr></table></figure><p>运行 <code>webpack</code> 看看 <em>dest/webpack.bundle.js</em>（我稍微删减并格式化了一下代码）：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/******/</span> (<span class="function"><span class="keyword">function</span>(<span class="params">modules</span>) </span>&#123; <span class="comment">// webpackBootstrap</span></span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line"><span class="comment">/******/</span> &#125;)([</span><br><span class="line"><span class="comment">/* 0 */</span></span><br><span class="line"><span class="comment">/***/</span> <span class="function"><span class="keyword">function</span>(<span class="params">module, exports, __webpack_require__</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* harmony export */</span> exports[<span class="string">"format"</span>] = format;</span><br><span class="line">  <span class="comment">/* unused harmony export locate */</span>;</span><br><span class="line">  <span class="comment">/* unused harmony export fromNow */</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getDateObject</span>(<span class="params">datetime</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">format</span>(<span class="params">datetime, formatStr</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ... 这里使用了 getDateObject()</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">locate</span>(<span class="params">arg</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">fromNow</span>(<span class="params">datetime</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***/</span> &#125;,</span><br><span class="line"><span class="comment">/* 1 */</span></span><br><span class="line"><span class="comment">/***/</span> <span class="function"><span class="keyword">function</span>(<span class="params">module, exports, __webpack_require__</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* harmony import */</span> <span class="keyword">var</span> __WEBPACK_IMPORTED_MODULE_0__lib_silly_datetime_es2015_js__ = __webpack_require__(<span class="number">0</span>);</span><br><span class="line"><span class="meta">  'use strict'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> getStr = <span class="function"><span class="keyword">function</span> <span class="title">getStr</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="comment">/* harmony import */</span> __WEBPACK_IMPORTED_MODULE_0__lib_silly_datetime_es2015_js__[<span class="string">"format"</span>](<span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> formatedDate = getStr();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'now is '</span> + formatedDate);</span><br><span class="line"></span><br><span class="line"><span class="comment">/***/</span> &#125;</span><br><span class="line"><span class="comment">/******/</span> ]);</span><br></pre></td></tr></table></figure><p>从第 7 至 9 行可以看到， <code>locate</code> 和 <code>fromNow</code> 并没有被 export，虽然下方还能看到这两个方法的声明，但是只要经过 UglifyJs，这两个方法必然 <a href="http://www.2ality.com/2015/12/webpack-tree-shaking.html#how_webpack_2_eliminates_unused_exports" target="_blank" rel="noopener">会被消除</a>：</p><blockquote><h5><span id="how-webpack-2-eliminates-unused-exports">How webpack 2 eliminates unused exports</span></h5><p>webpack 2, a new version that is in beta, eliminates unused exports in two steps:</p></blockquote><blockquote><ul><li>First, all ES6 module files are combined into a single bundle file. In that file, exports that were not imported anywhere are not exported, anymore.</li></ul></blockquote><blockquote><ul><li>Second, the bundle is minified, while eliminating dead code. Therefore, entities that are neither exported nor used inside their modules do not appear in the minified bundle. Without the first step, dead code elimination would never remove exports (registering an export keeps it alive).</li></ul></blockquote><p>可以运行 <code>webpack --optimize-minimize</code> 看到执行效果：</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">Hash:</span> b8357dea1720f84e6a76</span><br><span class="line"><span class="symbol">Version:</span> webpack <span class="number">2.0</span>.<span class="number">2</span>-beta</span><br><span class="line"><span class="symbol">Time:</span> <span class="number">9812</span>ms</span><br><span class="line">            Asset       Size  Chunks             Chunk Names</span><br><span class="line">webpack.bundle.js  <span class="number">935</span> bytes       <span class="number">0</span>  [emitted]  main</span><br><span class="line">    + <span class="number">2</span> hidden modules</span><br><span class="line"></span><br><span class="line">WARNING in webpack.bundle.js from UglifyJs</span><br><span class="line">Dropping unused function locate [./<span class="class"><span class="keyword">lib</span>/<span class="title">silly</span>-<span class="title">datetime</span>.<span class="title">es2015</span>.<span class="title">js</span>:84,16]</span></span><br><span class="line">Dropping unused function fromNow [./<span class="class"><span class="keyword">lib</span>/<span class="title">silly</span>-<span class="title">datetime</span>.<span class="title">es2015</span>.<span class="title">js</span>:120,16]</span></span><br><span class="line">Dropping unused variable LOCALE_EN [./<span class="class"><span class="keyword">lib</span>/<span class="title">silly</span>-<span class="title">datetime</span>.<span class="title">es2015</span>.<span class="title">js</span>:55,6]</span></span><br><span class="line">Dropping unused variable LOCALE_ZH_CN [./<span class="class"><span class="keyword">lib</span>/<span class="title">silly</span>-<span class="title">datetime</span>.<span class="title">es2015</span>.<span class="title">js</span>:66,6]</span></span><br><span class="line">Dropping unused variable _curentLocale [./<span class="class"><span class="keyword">lib</span>/<span class="title">silly</span>-<span class="title">datetime</span>.<span class="title">es2015</span>.<span class="title">js</span>:77,4]</span></span><br><span class="line">Dropping unused variable DET_STD [./<span class="class"><span class="keyword">lib</span>/<span class="title">silly</span>-<span class="title">datetime</span></span></span><br></pre></td></tr></table></figure><p>文件体积由原来的 5.68 kB 下降到了 935 bytes（当然这里也有 UglifyJs 的功劳）。</p><h3><span id="再回到-browserify">再回到 Browserify</span></h3><p>受上面的启发，在 Browserify 里面也能这样麽？我把 <em>package.json</em> 配置成这样：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"browserify"</span>: &#123;</span><br><span class="line">    <span class="attr">"transform"</span>: [</span><br><span class="line">      [ <span class="string">"babelify"</span>, &#123;</span><br><span class="line">        <span class="attr">"plugins"</span>: [</span><br><span class="line">          <span class="string">"transform-es2015-template-literals"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-literals"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-function-name"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-arrow-functions"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-block-scoped-functions"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-classes"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-object-super"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-shorthand-properties"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-computed-properties"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-for-of"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-sticky-regex"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-unicode-regex"</span>,</span><br><span class="line">          <span class="string">"check-es2015-constants"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-spread"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-parameters"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-destructuring"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-block-scoping"</span>,</span><br><span class="line">          <span class="string">"transform-es2015-typeof-symbol"</span>,</span><br><span class="line">          [<span class="string">"transform-regenerator"</span>, &#123; <span class="attr">"async"</span>: <span class="literal">false</span>, <span class="attr">"asyncGenerators"</span>: <span class="literal">false</span> &#125;]</span><br><span class="line">        ]</span><br><span class="line">      &#125; ]</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再运行 <code>browserify index.js &gt; dest/bundle.browserify.js</code>，结果以失败告终…<br>没有 commonjs，browserify 应该还是干不来的，如果有成功的童鞋麻烦告诉我怎么破。</p><h2><span id="碎碎念">碎碎念</span></h2><p>本文特别是 webpack 一节，参(chao)考(xi) <a href="http://www.2ality.com/2015/12/webpack-tree-shaking.html" target="_blank" rel="noopener">Tree-shaking with webpack 2 and Babel 6</a>。上面大部分源码可以在我的 GitHub 上面 <a href="https://github.com/csbun/tree-shaking-demo" target="_blank" rel="noopener">找到</a>。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;🌲🎅 ~~ 圣诞快乐 ~~ 🎉✨&lt;/p&gt;
&lt;h2 id=&quot;Rollup&quot;&gt;&lt;a href=&quot;#Rollup&quot; class=&quot;headerlink&quot; title=&quot;Rollup&quot;&gt;&lt;/a&gt;Rollup&lt;/h2&gt;&lt;p&gt;之前看到 &lt;a href=&quot;http://rollupjs.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;rollup.js&lt;/a&gt; 就觉得很有趣，后来终于有空，把我的小项目 &lt;a href=&quot;https://github.com/csbun/silly-datetime&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;silly-datetime&lt;/a&gt; 改成了 ES2015 然后用 Rollup 转成 CommonJS 和 UMD 两个版本分别给 &lt;a href=&quot;https://www.npmjs.com/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;npm&lt;/a&gt; 和 &lt;a href=&quot;http://bower.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Bower&lt;/a&gt; 使用。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Browserify" scheme="http://csbun.github.io/blog/tags/Browserify/"/>
    
      <category term="webpack" scheme="http://csbun.github.io/blog/tags/webpack/"/>
    
      <category term="ES2015" scheme="http://csbun.github.io/blog/tags/ES2015/"/>
    
      <category term="Rollup" scheme="http://csbun.github.io/blog/tags/Rollup/"/>
    
  </entry>
  
  <entry>
    <title>在 Android 上开始使用 React Native</title>
    <link href="http://csbun.github.io/blog/2015/12/starting-react-native-with-android/"/>
    <id>http://csbun.github.io/blog/2015/12/starting-react-native-with-android/</id>
    <published>2015-12-11T08:02:27.000Z</published>
    <updated>2020-11-03T11:52:46.312Z</updated>
    
    <content type="html"><![CDATA[<p>以下内容大部分都是 <a href="http://facebook.github.io/react-native/" target="_blank" rel="noopener">React Native</a> 官网中 <a href="http://facebook.github.io/react-native/docs/getting-started.html" target="_blank" rel="noopener">Getting Started</a> 和 <a href="http://facebook.github.io/react-native/docs/android-setup.html" target="_blank" rel="noopener">Android Setup</a> 的内容。当然也记录了我在这个过程中遇到的一些问题。</p><a id="more"></a><h2><span id="准备环境">准备环境</span></h2><p>Mac 用户在已经有 <a href="http://brew.sh/" target="_blank" rel="noopener">Homebrew</a> 和 <a href="https://nodejs.org/" target="_blank" rel="noopener">Node 4.x</a> 的情况下，以下都比较简单：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install -g react-native-cli</span><br><span class="line">brew install watchman</span><br><span class="line">brew install flow</span><br></pre></td></tr></table></figure><p>如果已经安装过，就运行下面命令更新一下：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew update</span><br><span class="line">brew upgrade</span><br></pre></td></tr></table></figure><p>附 <a href="http://facebook.github.io/react-native/docs/linux-windows-support.html" target="_blank" rel="noopener">Linux and Windows Support</a>。</p><h2><span id="先跑个-ios-的起来试试">先跑个 IOS 的起来试试</span></h2><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">react-<span class="keyword">native</span> init AwesomeProject</span><br><span class="line">cd AwesomeProject</span><br></pre></td></tr></table></figure><p>在 Xcode 中打开 <code>ios/AwesomeProject.xcodeproj</code>（或直接运行这个文件），点击左上角的 <code>▶</code> 即会打开 Xcode 自带的 Simulator，非常方便。</p><p>在 Simulator 中使用快捷键 <code>cmd-d</code> 打开开发菜单，选择 <code>Enable Live Relaod</code>。然后修改 <code>index.ios.js</code>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">var</span> &#123;</span><br><span class="line">  AppRegistry,</span><br><span class="line">  StyleSheet,</span><br><span class="line">  Text,</span><br><span class="line">  View,</span><br><span class="line">  SwitchIOS, <span class="comment">// add</span></span><br><span class="line">&#125; = React;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> AwesomeProject = React.createClass(&#123;</span><br><span class="line">  render: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;View style=&#123;styles.container&#125;&gt;</span><br><span class="line">        &lt;Text style=&#123;styles.welcome&#125;&gt;</span><br><span class="line">          Welcome to React-Native!</span><br><span class="line">        &lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">        &lt;Text style=&#123;styles.instructions&#125;&gt;</span></span><br><span class="line"><span class="regexp">          To get started, edit index.ios.js</span></span><br><span class="line"><span class="regexp">        &lt;/</span>Text&gt;</span><br><span class="line">        &lt;Text style=&#123;styles.instructions&#125;&gt;</span><br><span class="line">          Press Cmd+R to reload,&#123;<span class="string">'\n'</span>&#125;</span><br><span class="line">          Cmd+D or shake <span class="keyword">for</span> dev menu</span><br><span class="line">        &lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">        &#123;/</span>* add *<span class="regexp">/&#125;</span></span><br><span class="line"><span class="regexp">        &lt;SwitchIOS /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;);</span></span><br></pre></td></tr></table></figure><p>就能看到 App 的文字底部增加了一个 Switch 按钮。更多的接口可以看 <a href="http://facebook.github.io/react-native/docs/switchios.html" target="_blank" rel="noopener">SwitchIOS</a>，当然还有更多的 COMPONENTS 可以使用，这里不再深究。</p><h2><span id="安装-android-环境">安装 Android 环境</span></h2><p>安装 <a href="http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html" target="_blank" rel="noopener">JDK</a> 的文章一大堆，就不说了。brew 真是个好东西，安装 <a href="https://developer.android.com/sdk/installing/index.html" target="_blank" rel="noopener">Android SDK</a> 和 <a href="https://docs.gradle.org/current/userguide/installation.html" target="_blank" rel="noopener">Gradle</a> 也很简单：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew install android-sdk</span><br><span class="line">brew install gradle</span><br></pre></td></tr></table></figure><p>但是添加环境变量这个还是要做的：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># brew 安装的 android-sdk 和 gradle</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">ANDROID_HOME</span>=/usr/local/opt/android-sdk</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">GRADLE_HOME</span>=/usr/local/opt/gradle</span><br></pre></td></tr></table></figure><h3><span id="下载工具">下载工具</span></h3><p>在命令行中运行 <code>android</code> 即可打开 Android SDK Manager，按照 <a href="http://facebook.github.io/react-native/docs/android-setup.html#configure-your-sdk" target="_blank" rel="noopener">这里的说明</a> 安装：</p><ul><li>Android SDK Build-tools version <strong>23.0.1</strong></li><li>Android 6.0 (API 23)</li><li>Android Support Repository</li></ul><p>注意，Build-tools 必须是 <strong>23.0.1</strong>，我就是没看清楚选了 24.x 后面一直报错：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Build-tools</span> <span class="selector-tag">version</span> 23<span class="selector-class">.0</span><span class="selector-class">.1</span></span><br></pre></td></tr></table></figure><p>当然后续 react-native-cli 升级可能会更新 Build-tools，反正如果看到这个错误，就安装对应的 Build-tools 就好啦。</p><h3><span id="虚拟机">虚拟机</span></h3><p>因为之前开发需要，我已经安装了 <a href="https://www.genymotion.com/" target="_blank" rel="noopener">Genymotion</a>，就直接使用了。但是官网也提供了 <a href="http://facebook.github.io/react-native/docs/android-setup.html#alternative-create-a-stock-google-emulator" target="_blank" rel="noopener">Google emulator</a> 的启动方法，也不麻烦。</p><h2><span id="再跑个-android-虚拟机的试试">再跑个 Android 虚拟机的试试</span></h2><h3><span id="设备">设备</span></h3><p>在 Genymotion 创建并启动一个 device，在命令行运行：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb devices</span><br></pre></td></tr></table></figure><p>就能看到类似的结果：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">List</span> <span class="selector-tag">of</span> <span class="selector-tag">devices</span> <span class="selector-tag">attached</span></span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.56</span><span class="selector-class">.101</span><span class="selector-pseudo">:5555</span> <span class="selector-tag">device</span></span><br></pre></td></tr></table></figure><p>第一列表示设备 ID，第二列表示设备状态，<code>device</code> 表明可以运行。</p><h3><span id="启动">启动</span></h3><p>命令行运行</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">react-native run-android</span><br></pre></td></tr></table></figure><p>等等就能在虚拟机中看到启动了和刚刚 IOS 中一样的应用，点击 Genymotion player 右侧的菜单按钮，同样能打开开发菜单。</p><h2><span id="usb-调试真实设备">USB 调试真实设备</span></h2><p>手机开启 <strong>USB 调试</strong> 之后，用 USB 链接电脑，再次运行 <code>adb devices</code> 一般情况下就能看到类似：</p><figure class="highlight capnproto"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">List</span> <span class="keyword">of</span> devices attached</span><br><span class="line"><span class="number">14</span>ed2fcc device</span><br></pre></td></tr></table></figure><p>说明你的设备已经链接上了，然而我手上的魅族却怎么也不出来。查一下 <a href="http://bbs.flyme.cn/thread-18159-1-1.html" target="_blank" rel="noopener">资料</a> 很快就找到解决方案：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 0x2a45 &gt; .android/adb_usb.ini</span><br></pre></td></tr></table></figure><p>另外官网声明：</p><blockquote><p>You must have <strong>only one device connected</strong>.</p></blockquote><p>有且只能有一个设备链接，这时候再运行 <code>react-native run-android</code> 理论上应该就能和虚拟机一样跑起来了吧。然而真是图样图森破，Building 到 97% 又爆一个问题：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">app:installDebug</span><br><span class="line">Installing APK <span class="string">'app-debug.apk'</span> <span class="keyword">on</span> <span class="string">'m2 - 5.1'</span></span><br><span class="line"><span class="number">03</span>:<span class="number">44</span>:<span class="number">04</span> E/<span class="number">2099056020</span>: Error <span class="keyword">while</span> uploading app-<span class="keyword">debug</span>.apk : Unknown failure</span><br><span class="line">Unable <span class="keyword">to</span> install /path/<span class="keyword">to</span>/AwesomeProject/android/app/build/outputs/apk/app-<span class="keyword">debug</span>.apk</span><br><span class="line"><span class="keyword">com</span>.android.ddmlib.InstallException: Unable <span class="keyword">to</span> upload some APKs</span><br><span class="line">  at <span class="keyword">com</span>.android.ddmlib.Device.installPackages(Device.jav<span class="variable">a:920</span>)</span><br><span class="line">  ...</span><br><span class="line">:app:installDebug FAILED</span><br><span class="line"></span><br><span class="line">FAILURE: Build failed with <span class="keyword">an</span> exception.</span><br><span class="line"></span><br><span class="line">* What went wron<span class="variable">g:</span></span><br><span class="line">Execution failed <span class="keyword">for</span> task <span class="string">':app:installDebug'</span>.</span><br><span class="line">&gt; <span class="keyword">com</span>.android.builder.testing.api.DeviceException: <span class="keyword">com</span>.android.ddmlib.InstallException: Unable <span class="keyword">to</span> upload some APKs</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><a href="https://github.com/facebook/react-native/issues/2720" target="_blank" rel="noopener">React Native 真是被各路国产机坑坏了</a>，还好 <a href="https://github.com/facebook/react-native/issues/2720#issuecomment-153648404" target="_blank" rel="noopener">有人给出了解决方案</a>：将 <code>android/build.gradle</code> 第 8 行的版本号改成 <code>1.2.3</code> 即可</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Top-level build file where you can add configuration options common to all sub-projects/modules.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">buildscript</span> &#123;</span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">dependencies</span> &#123;</span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">'com.android.tools.build:gradle:1.2.3'</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> Do not place your application dependencies here; they belong</span></span><br><span class="line">        <span class="comment">// in the individual module build.gradle files</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再来一次，App 跳出来了！然而，然而是红色的错误界面吖，无论怎么 RELOAD JS 都提示 <code>Unable to download JS bundle</code>。还好 <a href="https://github.com/facebook/react-native/issues/3130" target="_blank" rel="noopener">不是只有我一个遇到这个问题</a>，按照 <a href="https://github.com/facebook/react-native/issues/3130#issuecomment-145235797" target="_blank" rel="noopener">jinmatt 的方法</a> 试一下：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">adb reverse tcp:8081 tcp:8081</span><br><span class="line">react-native run-android</span><br></pre></td></tr></table></figure><p>这回真的好了！大幅度摇一摇手机，调出开发者菜单，我喜欢 <code>Enable Live Relaod</code>，然后就来改改 <code>index.android.js</code>：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> &#123;</span><br><span class="line">  AppRegistry,</span><br><span class="line">  StyleSheet,</span><br><span class="line">  Text,</span><br><span class="line">  View,</span><br><span class="line">  SwitchAndroid, <span class="comment">// add</span></span><br><span class="line">&#125; = React;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> PointsMall = React.createClass(&#123;</span><br><span class="line">  render: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;View style=&#123;styles.container&#125;&gt;</span><br><span class="line">        &lt;Text style=&#123;styles.welcome&#125;&gt;</span><br><span class="line">          Welcome to React-Native!</span><br><span class="line">        &lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">        &lt;Text style=&#123;styles.instructions&#125;&gt;</span></span><br><span class="line"><span class="regexp">          To get started, edit index.android.js</span></span><br><span class="line"><span class="regexp">        &lt;/</span>Text&gt;</span><br><span class="line">        &lt;Text style=&#123;styles.instructions&#125;&gt;</span><br><span class="line">          Shake or press menu button <span class="keyword">for</span> dev menu</span><br><span class="line">        &lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">        &#123;/</span>* add *<span class="regexp">/&#125;</span></span><br><span class="line"><span class="regexp">        &lt;SwitchAndroid /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;);</span></span><br></pre></td></tr></table></figure><p>这回 App 的文字底部增加了一个 Android 的 Switch 按钮。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;以下内容大部分都是 &lt;a href=&quot;http://facebook.github.io/react-native/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;React Native&lt;/a&gt; 官网中 &lt;a href=&quot;http://facebook.github.io/react-native/docs/getting-started.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Getting Started&lt;/a&gt; 和 &lt;a href=&quot;http://facebook.github.io/react-native/docs/android-setup.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Android Setup&lt;/a&gt; 的内容。当然也记录了我在这个过程中遇到的一些问题。&lt;/p&gt;
    
    </summary>
    
    
      <category term="React" scheme="http://csbun.github.io/blog/tags/React/"/>
    
      <category term="Android" scheme="http://csbun.github.io/blog/tags/Android/"/>
    
      <category term="Native" scheme="http://csbun.github.io/blog/tags/Native/"/>
    
  </entry>
  
  <entry>
    <title>使用 Karma 在真实浏览器上测试</title>
    <link href="http://csbun.github.io/blog/2015/11/karma/"/>
    <id>http://csbun.github.io/blog/2015/11/karma/</id>
    <published>2015-11-16T03:57:26.000Z</published>
    <updated>2020-11-03T11:52:46.312Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="安装">安装</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -g karma-cli</span><br></pre></td></tr></table></figure><h2><span id="初始化">初始化</span></h2><p>进入项目跟目录，初始化 karma 配置文件：</p><figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i karma --<span class="built_in">save</span>-<span class="built_in">dev</span></span><br><span class="line">karma init</span><br></pre></td></tr></table></figure><a id="more"></a><p>问一<a href="https://karma-runner.github.io/0.13/intro/configuration.html" target="_blank" rel="noopener">大堆问题</a>，回答就是了。<code>Tab</code> 为选择，<code>Enter</code> 为确认。本文中：</p><ul><li>不使用 RequireJS</li><li>frameworks 选取 Mocha</li><li>browsers 选择 Chrome 和 PhantomJS</li></ul><h2><span id="mocha">Mocha</span></h2><p>假设我们的项目已经有源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// add.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>和测试代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test/index.js</span></span><br><span class="line"><span class="keyword">var</span> assert = <span class="built_in">require</span>(<span class="string">'assert'</span>);</span><br><span class="line"><span class="keyword">var</span> add = <span class="built_in">require</span>(<span class="string">'../add'</span>);</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'add'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    it(<span class="string">'add(1, 1) should be 2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        assert.equal(<span class="number">2</span>, add(<span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>运行 <code>mocha</code> 是没有问题的。但是运行 <code>karma start</code> 就傻逼了，说他不认识 <code>require</code>（这货默认是选择 RequireJS 的）。<code>ctrl-c</code> 退出。</p><h2><span id="安装插件">安装插件</span></h2><p>为了解决这个问题，我们需要类似 webpack 或 Browserify 之类的问题来预处理我们源码，而这些，都是能直接通过 <a href="https://www.npmjs.com/browse/keyword/karma-plugin" target="_blank" rel="noopener">插件</a> 搞定！</p><h3><span id="karma-webpack">karma-webpack</span></h3><p>首先使用 <a href="https://github.com/webpack/karma-webpack" target="_blank" rel="noopener">karma-webpack</a> 解决上面 <code>require</code> 的问题：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i karma-webpack --save-dev</span><br></pre></td></tr></table></figure><p>修改 <code>karma.conf.js</code>：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">config</span>) </span>&#123;</span><br><span class="line">  config.set(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 为测试文件添加 webpack preprocessors</span></span><br><span class="line">    preprocessors: &#123;</span><br><span class="line">      <span class="string">'test/*.js'</span>: [<span class="string">'webpack'</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再次运行一下 <code>karma start</code> 运行结果将包含以下内容：</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">`webpack: bundle is now VALID.`</span><br><span class="line">PhantomJS 1.9.8 (Mac OS X 0.0.0): Executed<span class="number"> 1 </span>of<span class="number"> 1 </span>SUCCESS (0.002 secs /<span class="number"> 0 </span>secs)</span><br><span class="line">Chrome 46.0.2490 (Mac OS X 10.10.5): Executed<span class="number"> 1 </span>of<span class="number"> 1 </span>SUCCESS (0.007 secs /<span class="number"> 0 </span>secs)</span><br><span class="line">TOTAL:<span class="number"> 2 </span>SUCCESS</span><br></pre></td></tr></table></figure><p>嗯，在 PhantomJS 和 Chrome 下面都运行成功了。</p><h3><span id="karma-babel-preprocessor">karma-babel-preprocessor</span></h3><p>下面我们再把 <code>test.js</code> 改一下，弄两个简单的 ES6 进去：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> assert = <span class="built_in">require</span>(<span class="string">'assert'</span>);</span><br><span class="line"><span class="keyword">const</span> add = <span class="built_in">require</span>(<span class="string">'../add'</span>);</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'add'</span>, () =&gt; &#123;</span><br><span class="line">    it(<span class="string">'add(1, 1) should be 2'</span>, () =&gt; &#123;</span><br><span class="line">        assert.equal(<span class="number">2</span>, add(<span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>结果，Chrome (46.0) 通过了，但 PhantomJS (1.9.8) 没有，于是再来一个插件 <a href="https://github.com/babel/karma-babel-preprocessor" target="_blank" rel="noopener">karma-babel-preprocessor</a>：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i karma-babel-preprocessor babel-preset-es2015 --save-dev</span><br></pre></td></tr></table></figure><p>同样在 <code>karma.conf.js</code> 中添加 <code>preprocessors</code>，以及 babel <a href="https://github.com/babel/karma-babel-preprocessor#configuration" target="_blank" rel="noopener">配置</a>：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    preprocessors: &#123;</span><br><span class="line">      <span class="string">'test/*.js'</span>: [<span class="string">'webpack'</span>, <span class="string">'babel'</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    babelPreprocessor: &#123;</span><br><span class="line">      options: &#123;</span><br><span class="line">        presets: [<span class="string">'es2015'</span>],</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>很好，<code>TOTAL: 2 SUCCESS</code>！于是，把 <code>add.js</code> 该成 ES6 也没有问题了：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2><span id="实战">实战</span></h2><p>再拿出上次的 <a href="https://github.com/csbun/resize-image" target="_blank" rel="noopener">resize-image</a> 来折腾，依照上面的方法处理，因为我们还需要加载一个图片进来所以用到了 <a href="https://github.com/webpack/url-loader" target="_blank" rel="noopener">url-loader</a>，直接通过 npm 安装即可使用：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i url-loader --save-dev</span><br></pre></td></tr></table></figure><p>然后编写我们的测试脚本：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> resizeImage = <span class="built_in">require</span>(<span class="string">'../index'</span>);</span><br><span class="line"><span class="keyword">const</span> assert = <span class="built_in">require</span>(<span class="string">'assert'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ASSERT_SIZE = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'resize-image'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    it(<span class="string">'.resize: Resize any image to '</span> + ASSERT_SIZE, <span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> img = <span class="keyword">new</span> Image();</span><br><span class="line">        <span class="comment">// use [url-loader](https://github.com/webpack/url-loader)</span></span><br><span class="line">        img.src = <span class="built_in">require</span>(<span class="string">'url!../example/google.png'</span>);</span><br><span class="line">        img.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">let</span> base64 = resizeImage.resize(img, ASSERT_SIZE, ASSERT_SIZE, resizeImage.PNG);</span><br><span class="line">            <span class="keyword">let</span> resizedImg = <span class="keyword">new</span> Image();</span><br><span class="line">            resizedImg.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">let</span> minWH = <span class="built_in">Math</span>.min(resizedImg.width, resizedImg.height);</span><br><span class="line">                assert.equal(minWH, ASSERT_SIZE);</span><br><span class="line">                done();</span><br><span class="line">            &#125;;</span><br><span class="line">            resizedImg.src = base64;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>browsers 配置了除了 IE 以外的全部浏览器：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">browsers: [</span><br><span class="line">  <span class="string">'Chrome'</span>,</span><br><span class="line">  <span class="string">'ChromeCanary'</span>,</span><br><span class="line">  <span class="string">'Firefox'</span>,</span><br><span class="line">  <span class="string">'Safari'</span>,</span><br><span class="line">  <span class="string">'PhantomJS'</span>,</span><br><span class="line">  <span class="string">'Opera'</span></span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>运行 <code>karma start --single-run</code> 全部通过。</p><h3><span id="coverage">coverage</span></h3><p>之前的 <a href="/2015/07/js-unit-test-coverage-ci/" title="博客">博客</a> 中提到了使用 <a href="https://github.com/gotwarlost/istanbul" target="_blank" rel="noopener">istanbul</a> 做代码覆盖率，这里同样有这样的插件实现 <a href="https://github.com/karma-runner/karma-coverage" target="_blank" rel="noopener">karma-coverage</a>：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i karma karma-coverage --save-dev</span><br></pre></td></tr></table></figure><p>在 <code>karma.conf.js</code> 中配置：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">preprocessors: &#123;</span><br><span class="line">  <span class="string">'test/index.js'</span>: [<span class="string">'webpack'</span>, <span class="string">'babel'</span>, <span class="string">'coverage'</span>]</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">reporters: [<span class="string">'progress'</span>, <span class="string">'coverage'</span>],</span><br><span class="line">coverageReporter: &#123;</span><br><span class="line">  type : <span class="string">'html'</span>,</span><br><span class="line">  dir : <span class="string">'coverage/'</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>再次运行 <code>karma start --single-run</code> 即可在 <code>coverage</code> 文件夹中看到覆盖率报告。但我们可以看到报告里的覆盖率很低，因为 webpack 打包好后的文件包含了很多我们不需要检查的内容（webpack，test 等），于是我们需要 <a href="https://www.npmjs.com/package/istanbul-instrumenter-loader" target="_blank" rel="noopener">istanbul-instrumenter-loader</a>：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i istanbul-instrumenter-loader --save-dev</span><br></pre></td></tr></table></figure><p>再修改一下 <code>karma.conf.js</code>：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">preprocessors: &#123;</span><br><span class="line">  <span class="string">'test/index.js'</span>: [<span class="string">'webpack'</span>, <span class="string">'babel'</span>] <span class="comment">// 这里不需要说明 coverage</span></span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">reporters: [<span class="string">'progress'</span>, <span class="string">'coverage'</span>],</span><br><span class="line">coverageReporter: &#123;</span><br><span class="line">  type : <span class="string">'html'</span>,</span><br><span class="line">  dir : <span class="string">'coverage/'</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">// 添加以下部分</span></span><br><span class="line">webpack: &#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    postLoaders: [&#123;</span><br><span class="line">      test: <span class="regexp">/index\.js$/</span>, <span class="comment">// 源文件</span></span><br><span class="line">      exclude: <span class="regexp">/(test|node_modules|bower_components)\//</span>, <span class="comment">// 排除的文件</span></span><br><span class="line">      loader: <span class="string">'istanbul-instrumenter'</span></span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>再次运行 <code>karma start --single-run</code> 就能看到报告里只剩下我们的 <code>index.js</code> 了。</p><h3><span id="travis-ci-amp-coveralls">Travis CI &amp; COVERALLS</span></h3><p><a href="https://travis-ci.org/" target="_blank" rel="noopener">Travis CI</a> 提供了一个 <a href="http://docs.travis-ci.com/user/firefox/" target="_blank" rel="noopener">Firefox 的运行环境</a>，于是我们要配置一下 <code>.travis.yml</code>：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">language:</span> <span class="string">node_js</span></span><br><span class="line"><span class="attr">node_js:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">"4.2"</span></span><br><span class="line"><span class="attr">before_script:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">export</span> <span class="string">DISPLAY=:99.0</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">sh</span> <span class="bullet">-e</span> <span class="string">/etc/init.d/xvfb</span> <span class="string">start</span></span><br></pre></td></tr></table></figure><p>同时我们将 coverage 报告类型改为 lcov：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">coverageReporter: &#123;</span><br><span class="line">  type : <span class="string">'lcov'</span>,</span><br><span class="line">  dir : <span class="string">'coverage/'</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>方便我们上传到 <a href="https://coveralls.io/" target="_blank" rel="noopener">COVERALLS</a>：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i coveralls --save-dev</span><br></pre></td></tr></table></figure><p><code>package.json</code> 也要加入 test 脚本</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"resize-image"</span>,</span><br><span class="line">  <span class="attr">"main"</span>: <span class="string">"index.js"</span>,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"test"</span>: <span class="string">"./node_modules/karma/bin/karma start --browsers Firefox --single-run &amp;&amp; find coverage -name lcov.info -print0 | xargs -0 cat | ./node_modules/coveralls/bin/coveralls.js &amp;&amp; rm -rf ./coverage"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>提交代码，虽然 <a href="https://travis-ci.org/" target="_blank" rel="noopener">Travis CI</a> 上的输出提示是：</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Firefox <span class="number">31.0</span><span class="number">.0</span> (Linux <span class="number">0.0</span><span class="number">.0</span>): Executed <span class="number">0</span> <span class="keyword">of</span> <span class="number">1</span> SUCCESS (<span class="number">0</span> <span class="built_in">secs</span> / <span class="number">0</span> <span class="built_in">secs</span>)</span><br><span class="line"> SUCCESS (<span class="number">0</span> <span class="built_in">secs</span> / <span class="number">0.026</span> <span class="built_in">secs</span>)</span><br><span class="line"> SUCCESS (<span class="number">0.052</span> <span class="built_in">secs</span> / <span class="number">0.026</span> <span class="built_in">secs</span>)</span><br></pre></td></tr></table></figure><p>但实际上已经成功了，<a href="https://coveralls.io/" target="_blank" rel="noopener">COVERALLS</a> 上已经能看到覆盖率报告！</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;安装&quot;&gt;&lt;a href=&quot;#安装&quot; class=&quot;headerlink&quot; title=&quot;安装&quot;&gt;&lt;/a&gt;安装&lt;/h2&gt;&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;npm i -g karma-cli&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;初始化&quot;&gt;&lt;a href=&quot;#初始化&quot; class=&quot;headerlink&quot; title=&quot;初始化&quot;&gt;&lt;/a&gt;初始化&lt;/h2&gt;&lt;p&gt;进入项目跟目录，初始化 karma 配置文件：&lt;/p&gt;
&lt;figure class=&quot;highlight q&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;npm i karma --&lt;span class=&quot;built_in&quot;&gt;save&lt;/span&gt;-&lt;span class=&quot;built_in&quot;&gt;dev&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;karma init&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="test" scheme="http://csbun.github.io/blog/tags/test/"/>
    
      <category term="ci" scheme="http://csbun.github.io/blog/tags/ci/"/>
    
      <category term="Karma" scheme="http://csbun.github.io/blog/tags/Karma/"/>
    
      <category term="webpack" scheme="http://csbun.github.io/blog/tags/webpack/"/>
    
  </entry>
  
  <entry>
    <title>台湾好好呷</title>
    <link href="http://csbun.github.io/blog/2015/11/eating-around-taiwan/"/>
    <id>http://csbun.github.io/blog/2015/11/eating-around-taiwan/</id>
    <published>2015-11-14T12:20:10.000Z</published>
    <updated>2020-11-03T11:52:46.280Z</updated>
    
    <content type="html"><![CDATA[<p>觉得再不动手写，这个游记就真的无法面世了。要不是最近把博客从 <a href="http://jekyllrb.com/" target="_blank" rel="noopener">jekyll</a> 迁移到 <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>，都可能没有想着要写。拖延症绝症患者快没得救了。</p><p>这是一个系列文章，而这当前一篇（希望不是最后一篇），应该是我觉得最重要的 “<strong>吃</strong>”。本文图多字少，虽然我已经压缩过，但还请自备流量。</p><a id="more"></a><h2><span id="台湾魯肉饭">台湾魯肉饭</span></h2><p>没错，就是这个魯，不是那个卤。为什么上来就说这个，因为貌似大陆也经常看到吖！</p><p>台湾有各种各样的魯肉饭，肉燥饭，猪油捞饭（请允许我偷懒统称为魯肉饭）。和大陆见到的同名作品不同，宝岛的魯肉饭通常都只是普通家用饭碗大小，甚至更小，而且，没有那半个卤鸡蛋！觉得比较好吃的是台北的 <strong>金峰魯肉饭</strong>：</p><img src="/2015/11/eating-around-taiwan/DSC04479.jpg" title="台北 金峰魯肉饭"><p>和 <strong>大隐酒食</strong> 的猪油捞饭：</p><img src="/2015/11/eating-around-taiwan/DSC03203.jpg" title="台北 大隐酒食 猪油捞饭"><p>然而，作为一个潮汕人，吃了几十年的猪脚饭和各种卤味，还是觉得老妈做的略胜一筹。</p><h2><span id="牛肉面牛肉汤">牛肉面牛肉汤</span></h2><p>真正惊艳的美味，当属台南的 <strong>上好吃牛肉面</strong> （现在改名叫 鸿源金好吃牛肉面），当时只点了一个药膳牛肉面，只要喝一口那个汤，就能让你欲罢不能。如果不是离住的地方有点远，一定会再去吃一个原味牛肉面！</p><img src="/2015/11/eating-around-taiwan/DSC04220.jpg" title="台南 上好吃牛肉面"><p>说到台南牛肉，还有一个不能不提的是 “台南人的早餐”，牛肉汤。<strong>西罗殿牛肉汤</strong> 这是仅有的两家我们去吃了两次的店之一，牛肉非常新鲜细嫩，配上秘制辣椒酱（要自己问老板拿，老板见我们第一次来吃，还慢慢给我们讲解吃法，非常友好），完美！每天限量供应，还送一晚肉燥饭哦~</p><img src="/2015/11/eating-around-taiwan/DSC04032.jpg" title="台南 西罗殿牛肉汤"><p>当然还有台北的 <strong>老张牛肉面</strong>，每块牛肉都够厚且带筋，管饱！</p><img src="/2015/11/eating-around-taiwan/DSC04486.jpg" title="台北 老张牛肉面"><p>说到我都饿了，容我吃条香蕉压压惊…</p><h2><span id="便当饭包">便当饭包</span></h2><p>在大陆，我每天吃快餐外卖会兽捕鸟。但要是我住台湾，估计我可以天天吃便当！真实便宜又好吃！先是花莲的 <strong>热海排骨便当</strong> </p><img src="/2015/11/eating-around-taiwan/DSC03604.jpg" title="花莲 热海排骨便当"><p>再是池上，这个盛产大米的地方，打包两个 <strong>池上饭包博物馆</strong> 的便当到伯朗大道上边看风景边吃，也是相当享受</p><img src="/2015/11/eating-around-taiwan/DSC03651.jpg" title="台东 池上饭包博物馆"><p>在火车上，或者去 7 仔、全家买一个也很好吃吖</p><img src="/2015/11/eating-around-taiwan/P51001-140312.jpg" title="台铁便当"><h2><span id="果汁冰品">果汁冰品</span></h2><p>宝岛盛产水果，这是大家都知道的，而此行最可惜的就是没有把水果吃个够。果汁倒是喝了不少，<strong>津芳冰城</strong>，这是台东这座短暂停留的城市给我留下的最好印象，木瓜牛奶和神奇的咸冰棒：</p><img src="/2015/11/eating-around-taiwan/DSC03785.jpg" title="台东 津芳冰城 木瓜牛奶和咸冰棒"><p>花莲有两家挨在一起的包心粉圆店，<strong>正宗包心粉圆</strong> 和 <strong>五霸焦糖包心粉圆</strong>。没错，这货是冰品！都有一大碗冰加炼奶，前者粉圆是单独小碟放，舀一勺冰一起吃；后者则直接将冰盖在粉圆绿豆沙上，挖着吃（颱风天去打包一个路上吃了，没有拍照）。</p><img src="/2015/11/eating-around-taiwan/DSC03553.jpg" title="花莲 正宗包心粉圆"><p>当然也少不了台南老字号，<strong>泰成水果店</strong>，<strong>莉莉水果店</strong> 都是不错的选择。（虽然民宿老板说他们去那里都是吃冰，但是我还是喜欢新鲜水果和鲜榨果汁吖）</p><img src="/2015/11/eating-around-taiwan/DSC04027.jpg" title="台南 泰成水果店 木瓜牛奶"><p>顺带提一下，台南的 <strong>石精臼</strong>，动不动就是近百年的老店。<strong>八宝冰</strong> 就是这其中的一家，品种繁多，分量十足，2 个人吃一份绝对没问题，还能免费加冰哦！</p><img src="/2015/11/eating-around-taiwan/DSC04026.jpg" title="台南 石精臼八宝冰"><h2><span id="红茶">红茶</span></h2><p>不和果汁们放在一起，是因为台湾的红茶实在太好喝了。这里有三家特别推荐：</p><p><strong>花莲庙口红茶</strong>，24小时营业的50年老店，看这的钢管女郎的架势，管里面是满满的红茶，绝无仅有！</p><img src="/2015/11/eating-around-taiwan/miaokouredtea.jpg" title="花莲 庙口红茶"><p>花莲还有一家卖龙凤腿的，店名 <strong>肉羹张</strong>。那里的自制红茶也很好喝！</p><img src="/2015/11/eating-around-taiwan/DSC03613.jpg" title="花莲 肉羹张 自制红茶"><p>最后，台中唯一推荐，第二市场的 老 Like <strong>老赖红茶</strong>。没有独照，给只有一张他和 <strong>山河卤肉饭</strong> 的合照：</p><img src="/2015/11/eating-around-taiwan/DSC04235.jpg" title="台中 老赖红茶"><h2><span id="还有很多好吃的">还有很多好吃的</span></h2><p>上面提到仅有的两家店是我们去吃了两次的，另外一家依旧是在台南：<strong>保哥黑輪</strong>，黑轮就是麻辣烫，然而这里最好吃的不是黑轮，而是神奇的 <strong>炒泡面</strong>，我还是第一次那么喜欢吃泡面！</p><img src="/2015/11/eating-around-taiwan/DSC04093.jpg" title="台南 保哥黑輪的炒泡面"><p>台南不可能只有这么少吃的，<strong>不老庄</strong> 的药膳香肠，绝对又是一个神奇之作。不要看外表那么丑，但每一口都是扎实的黑猪肉和丰满的药膳味，喜欢闻中药味的我表示干得漂亮！</p><img src="/2015/11/eating-around-taiwan/DSC04194.jpg" title="台南 不老庄 药膳香肠"><p>瑞芳火车站正门出去一直向前走，有个美食街，进门就有一家 <strong>李记蚵仔煎</strong>，是我再台湾吃过的最好吃的蚵仔煎，没有之一。又是药膳酱汁，蚵仔是坚持每天从嘉义东石新鲜运过来。</p><img src="/2015/11/eating-around-taiwan/DSC03496.jpg" title="瑞芳 李记蚵仔煎"><p><strong>宜兰香葱牛肉卷</strong>，这个是再花莲自强夜市的一个角落看到的一个流动摊位，然而排队的人炒鸡多，好奇心战胜了懒惰症。宜兰葱，完全不呛，嘎嘣脆，只有香味！</p><img src="/2015/11/eating-around-taiwan/DSC03588.jpg" title="花莲 自强夜市 宜兰香葱牛肉卷"><p>嗯，我终于提到夜市了。对于夜市，我只能说一个比一个印象不好，也可能是因为好奇心过了吧。花莲的 <strong>自强夜市</strong> 虽然不大，秩序井然，非常干净，地面完全不见垃圾或积水。而台南的 <strong>花园夜市</strong> 就真的是脏乱差了，没记住有什么好吃的。台中的 <strong>逢甲夜市</strong>，就是很多小吃的商业街，我只记得 <strong>官芝霖大肠包小肠</strong>。</p><img src="/2015/11/eating-around-taiwan/DSC04318.jpg" title="台中 逢甲夜市 官芝霖 大肠包小肠"><p>以上美食，不要问我价格，最多不到 150 TND。在台湾就是随便吃，炒鸡便宜！也不要问我拍照技术什么时候变这么好了，我不会告诉你这些都是我女票拍的，我只负责吃。没什么贡献的我回来本来想画一张台南美食地图的，可惜技术不到家，字也丑，最终放弃。不甘心的我还是从 Google Map 导出了部分我们在台湾吃过的东西和少景点的数据（到台南才开始记录，所以东岸的几乎没有），转换成百度地图如下。</p><script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=j5D7AFvOU6flFPs1XVv9RcoR"></script><div style="width:100%;height:550px;border:#ccc solid 1px;font-size:12px" id="map"></div><script type="text/javascript">  //创建和初始化地图函数：  function initMap(){    createMap();//创建地图    setMapEvent();//设置地图事件    addMapControl();//向地图添加控件    addMapOverlay();//向地图添加覆盖物  }  function createMap(){     map = new BMap.Map("map");     map.centerAndZoom(new BMap.Point(120.194652,22.994535),14);  }  function setMapEvent(){    map.enableScrollWheelZoom();    map.enableKeyboard();    map.enableDragging();    map.enableDoubleClickZoom()  }  function addClickHandler(target,window){    target.addEventListener("click",function(){      target.openInfoWindow(window);    });  }  function addMapOverlay(){    var markers = [      {        "t": "成都楊桃冰",        "p": {          "lng": 121.5185096,          "lat": 25.0460545        }      },      {        "t": "阿泉麵線",        "p": {          "lng": 121.5269114,          "lat": 25.0488728        }      },      {        "t": "謝謝魷魚羹",        "p": {          "lng": 121.51817179999999,          "lat": 25.048498300000002        }      },      {        "t": "老張牛肉麵",        "p": {          "lng": 121.5327466,          "lat": 25.0342448        }      },      {        "t": "金峰魯肉飯",        "p": {          "lng": 121.52912979999999,          "lat": 25.0354515        }      },      {        "t": "林東芳牛肉麵",        "p": {          "lng": 121.55194589999999,          "lat": 25.050224500000002        }      },      {        "t": "辉松食品 (原黑松牛轧糖)",        "p": {          "lng": 121.5225155,          "lat": 25.0476005        }      },      {        "t": "万师父牛肉卷饼",        "p": {          "lng": 121.5248438,          "lat": 25.049327        }      },      {        "t": "高美湿地",        "p": {          "lng": 120.5612392,          "lat": 24.3149298        }      },      {        "t": "東海蓮心冰雞爪凍",        "p": {          "lng": 120.6033175,          "lat": 24.1845936        }      },      {        "t": "爆漿炭烤按摩雞排",        "p": {          "lng": 120.65719229999999,          "lat": 24.1793206        }      },      {        "t": "官芝霖大腸包小腸",        "p": {          "lng": 120.65669249999999,          "lat": 24.1828986        }      },      {        "t": "王記菜頭粿糯米腸",        "p": {          "lng": 120.68972889999999,          "lat": 24.1455342        }      },      {        "t": "李海魯肉飯",        "p": {          "lng": 120.689324,          "lat": 24.145697300000002        }      },      {        "t": "國立自然科學博物館",        "p": {          "lng": 120.6771955,          "lat": 24.1606566        }      },      {        "t": "逢甲夜市",        "p": {          "lng": 120.6570625,          "lat": 24.1822406        }      },      {        "t": "逢甲夜市",        "p": {          "lng": 120.6570625,          "lat": 24.1822406        }      },      {        "t": "山河魯肉飯",        "p": {          "lng": 120.6897843,          "lat": 24.146047        }      },      {        "t": "宮原眼科",        "p": {          "lng": 120.6941215,          "lat": 24.1412346        }      },      {        "t": "T东海大学",        "p": {          "lng": 120.6212622,          "lat": 24.1869967        }      },      {        "t": "彩虹眷村",        "p": {          "lng": 120.6204879,          "lat": 24.1371451        }      },      {        "t": "小西腳青草茶",        "p": {          "lng": 120.2080553,          "lat": 22.9932935        }      },      {        "t": "老賴茶棧",        "p": {          "lng": 120.6894854,          "lat": 24.145543500000002        }      },      {        "t": "阿憨鹹粥",        "p": {          "lng": 120.216929,          "lat": 23.004922        }      },      {        "t": "古早味魚丸湯",        "p": {          "lng": 120.2157981,          "lat": 23.0025662        }      },      {        "t": "鴻源金好吃牛肉麵(原上好吃)",        "p": {          "lng": 120.2225148,          "lat": 23.016866        }      },      {        "t": "藍晒圖文創園區",        "p": {          "lng": 120.2078965,          "lat": 22.990581600000002        }      },      {        "t": "莉莉水果店",        "p": {          "lng": 120.2146721,          "lat": 22.9925263        }      },      {        "t": "克林台包",        "p": {          "lng": 120.215471,          "lat": 22.9925503        }      },      {        "t": "台灣黑輪",        "p": {          "lng": 120.2170793,          "lat": 22.9936557        }      },      {        "t": "草祭二手書店",        "p": {          "lng": 120.21544349999999,          "lat": 22.9929706        }      },      {        "t": "不老庄药膳食品",        "p": {          "lng": 120.2154393,          "lat": 22.993318600000002        }      },      {        "t": "栄興水果店",        "p": {          "lng": 120.2175347,          "lat": 23.001591        }      },      {        "t": "炸蛋葱油餅",        "p": {          "lng": 120.2081505,          "lat": 22.9977417        }      },      {        "t": "保哥黑輪",        "p": {          "lng": 120.21596439999999,          "lat": 22.9929637        }      },      {        "t": "懷舊小棧",        "p": {          "lng": 120.2158104,          "lat": 22.9860592        }      },      {        "t": "EVA伊娃日式泡芙專賣店",        "p": {          "lng": 120.2162991,          "lat": 22.9879105        }      },      {        "t": "同記安平豆花",        "p": {          "lng": 120.1639686,          "lat": 23.0033477        }      },      {        "t": "茂記黑豆花大王",        "p": {          "lng": 120.1638272,          "lat": 23.0032144        }      },      {        "t": "台南花园夜市",        "p": {          "lng": 120.2102286,          "lat": 23.01408        }      },      {        "t": "泰成水果店",        "p": {          "lng": 120.2077524,          "lat": 22.9978647        }      },      {        "t": "八宝冰、花生仁汤",        "p": {          "lng": 120.2121181,          "lat": 23.0006898        }      },      {        "t": "阿忠魚粥",        "p": {          "lng": 120.2115692,          "lat": 23.000816        }      },      {        "t": "連得堂餅家",        "p": {          "lng": 120.2172727,          "lat": 23.0038089        }      },      {        "t": "義豐阿琦冬瓜茶",        "p": {          "lng": 120.1845055,          "lat": 23.0015502        }      },      {        "t": "西羅殿牛肉湯",        "p": {          "lng": 120.2180324,          "lat": 23.0049167        }      },      {        "t": "陳家蚵捲",        "p": {          "lng": 120.1722877,          "lat": 23.0037172        }      },      {        "t": "王氏魚皮店",        "p": {          "lng": 120.17950119999999,          "lat": 23.002387600000002        }      }    ];    var allPoints = [];    for(var index = 0; index < markers.length; index++ ){      var icon = new BMap.Icon(        "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAMAAAAGyf7hAAABDlBMVEUAAADtLS3MzMzcJC/////+/f3Q0NDTHzDjKC756OrHHDTrKy38/PzffozvR0fKLEP++/z5+fnn5+f22t7vvcTssrrihpP1hYXWYXHyX1/SSl3xV1fJIzruNzfYIzDWIjDgJy/99vbz8/P68vP67O7t7e324OT33uHY2Njxxszttr7rrrfmmaTLjZbggo/1jY3XXW7JXGvNRVjPPVHwT0/NNUriLzbMHTH39/f84eHd3d3i29z71dXS0tLRy837y8v6ycngxMjwwcjLxcbLvL75urrKqq73nJzahpL1kJD1i4vbdIL0f3/Jc3/zcHDyaGjVVmjUU2XHQFPrSk3nQETpQEPHLUPvQUHjMzrGIjnzNEA/AAAAAXRSTlMAQObYZgAAARVJREFUKM9Vzdd6gkAQBeChLk1BEJGi2DWWxGjU9N57L+//ItldQOBczffv7BygMTrW0C732pBJvzJfIYRW3lhOyBgtuC/fLdYYqe5txDhWPp3nH4amoUdaDj7udqhQnfexdV6XW0UmDVcw8KLikr3aY/ykBriswrnE9ni+6VNFI4Dpkmzc8zhX8X+A6i+ZbgieRriJsUEmX8DorHEq0fHl5NBJ6kkRkw+yAc5R3lRdBpDfpBxyD00NYBioGZP0M7MLAIXsVWUiiiJG2Uu1vn3BsizgWLqUHHy/ZGMEW1Gjg9/XxESKwm1ITP2bEBqYQNOukrPhEyse7Xd3tQiF3ozDJccDs1USYB1rEc4OWiUtJbqspPIPOm8ZiopMvjYAAAAASUVORK5CYII=",        new BMap.Size(20,25),        { offset: new BMap.Size(10, 25) }      );      var point = new BMap.Point(markers[index].p.lng,markers[index].p.lat);      allPoints.push(point);      var marker = new BMap.Marker(point, { icon: icon });      var label = new BMap.Label(markers[index].t,{offset: new BMap.Size(22,5)});      marker.setLabel(label);      map.addOverlay(marker);    };    setTimeout(function() {      new BMap.Convertor().translate(allPoints, 1, allPoints.length, function(data) {        console.log(data)      });    }, 5000);  }  //向地图添加控件  function addMapControl(){    var scaleControl = new BMap.ScaleControl({anchor:BMAP_ANCHOR_BOTTOM_LEFT});    scaleControl.setUnit(BMAP_UNIT_IMPERIAL);    map.addControl(scaleControl);    var navControl = new BMap.NavigationControl({anchor:BMAP_ANCHOR_TOP_LEFT,type:BMAP_NAVIGATION_CONTROL_LARGE});    map.addControl(navControl);    var overviewControl = new BMap.OverviewMapControl({anchor:BMAP_ANCHOR_BOTTOM_RIGHT,isOpen:true});    map.addControl(overviewControl);  }  var map;    initMap();</script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;觉得再不动手写，这个游记就真的无法面世了。要不是最近把博客从 &lt;a href=&quot;http://jekyllrb.com/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;jekyll&lt;/a&gt; 迁移到 &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;，都可能没有想着要写。拖延症绝症患者快没得救了。&lt;/p&gt;
&lt;p&gt;这是一个系列文章，而这当前一篇（希望不是最后一篇），应该是我觉得最重要的 “&lt;strong&gt;吃&lt;/strong&gt;”。本文图多字少，虽然我已经压缩过，但还请自备流量。&lt;/p&gt;
    
    </summary>
    
      <category term="旅行" scheme="http://csbun.github.io/blog/categories/%E6%97%85%E8%A1%8C/"/>
    
    
      <category term="美食" scheme="http://csbun.github.io/blog/tags/%E7%BE%8E%E9%A3%9F/"/>
    
  </entry>
  
  <entry>
    <title>使用 Nightmare 进行浏览器自动化测试</title>
    <link href="http://csbun.github.io/blog/2015/11/using-nightmare/"/>
    <id>http://csbun.github.io/blog/2015/11/using-nightmare/</id>
    <published>2015-11-09T10:09:32.000Z</published>
    <updated>2020-11-03T11:52:46.278Z</updated>
    
    <content type="html"><![CDATA[<p><a href="http://nightmarejs.org" target="_blank" rel="noopener">Nightmare</a> is a high-level browser automation library. 和之前的 <a href="http://phantomjs.org/" target="_blank" rel="noopener">PhantomJS</a> 很像，但是 <a href="http://nightmarejs.org" target="_blank" rel="noopener">Nightmare</a> 是基于 <a href="http://electron.atom.io/" target="_blank" rel="noopener">Electron</a> 的，也就是还是基于 Chromium 和 Node.js。但是感觉其写法比 <a href="http://phantomjs.org/" target="_blank" rel="noopener">PhantomJS</a> 简单一些：</p><a id="more"></a><h2><span id="安装">安装</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i nightmare</span><br></pre></td></tr></table></figure><h2><span id="使用">使用</span></h2><h3><span id="创建实例">创建实例</span></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Nightmare = <span class="built_in">require</span>(<span class="string">'nightmare'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> nightmare = Nightmare(&#123; <span class="attr">show</span>: <span class="literal">true</span> &#125;); <span class="comment">// options</span></span><br></pre></td></tr></table></figure><p>这里的 <code>options.show = true</code> 可以在运行时打开 <a href="http://electron.atom.io/" target="_blank" rel="noopener">Electron</a> 窗口，方便 <a href="https://github.com/segmentio/nightmare#debugging" target="_blank" rel="noopener">debug</a>，更多的 options 请看 <a href="https://github.com/atom/electron/blob/master/docs/api/browser-window.md#new-browserwindowoptions" target="_blank" rel="noopener">new BrowserWindow(options)</a>。</p><h3><span id="操作页面">操作页面</span></h3><p>因为需要使用了 ES6 的 generator，所以这里还要加入 <a href="https://github.com/tj/co" target="_blank" rel="noopener">co</a>，官网的 <a href="https://github.com/segmentio/nightmare#examples" target="_blank" rel="noopener">Examples</a> 使用的是 <a href="https://github.com/lapwinglabs/vo" target="_blank" rel="noopener">vo</a>。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> co = <span class="built_in">require</span>(<span class="string">'co'</span>);</span><br><span class="line"><span class="keyword">var</span> RES_CLS = <span class="string">'r'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Node 运行环境</span></span><br><span class="line"><span class="keyword">var</span> googleUrl = <span class="string">'https://www.google.com/'</span>;</span><br><span class="line">co(<span class="function"><span class="keyword">function</span>* (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> url = <span class="keyword">yield</span> nightmare</span><br><span class="line">        <span class="comment">// 打开 Google</span></span><br><span class="line">        .goto(googleUrl)</span><br><span class="line">        <span class="comment">// 在输入框中填写内容 'csbun npm'</span></span><br><span class="line">        .type(<span class="string">'input[name="q"]'</span>, <span class="string">'csbun npm'</span>)</span><br><span class="line">        <span class="comment">// 点击搜索</span></span><br><span class="line">        .click(<span class="string">'input[type="submit"]'</span>)</span><br><span class="line">        <span class="comment">// 等待页面返回</span></span><br><span class="line">        .wait(<span class="string">'.'</span> + RES_CLS)</span><br><span class="line">        <span class="comment">// 页面操作</span></span><br><span class="line">        .evaluate(<span class="function"><span class="keyword">function</span> (<span class="params">RES_CLS</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 这里是浏览器的运行环境</span></span><br><span class="line">            <span class="keyword">var</span> resHref = <span class="string">''</span>;</span><br><span class="line">            <span class="keyword">var</span> resH3 = <span class="built_in">document</span>.getElementsByClassName(RES_CLS)[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span> (resH3) &#123;</span><br><span class="line">              <span class="built_in">console</span>.log(resH3);</span><br><span class="line">                <span class="keyword">var</span> resA = resH3.getElementsByTagName(<span class="string">'A'</span>)[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span> (resA) &#123;</span><br><span class="line">                    resHref = resA.href;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 返回给 Node</span></span><br><span class="line">            <span class="keyword">return</span> resHref;</span><br><span class="line">        &#125;, RES_CLS); <span class="comment">// 传参</span></span><br><span class="line">    <span class="comment">// 关闭</span></span><br><span class="line">    <span class="keyword">yield</span> nightmare.end();</span><br><span class="line">    <span class="keyword">return</span> url;</span><br><span class="line">&#125;).then(<span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 输出结果</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'res: '</span> + res);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>运行上述代码，将获得 Google 搜索 <code>csbun npm</code> 的第一个链接： <a href="https://www.npmjs.com/~csbun" target="_blank" rel="noopener">https://www.npmjs.com/~csbun</a>。</p><h3><span id="其他-api">其他 </span></h3><h4><span id="evaluate">evaluate</span></h4><p>在上面的例子里面，我们可以看到，<code>.evaluate(fn, arg1)</code> 中的 <code>fn</code> 是浏览器的运行环境，是不能直接使用闭包中的其他变量的，必须通过 <code>evaluate</code> 的参数 <code>arg1</code> 传入。详情请看 <a href="https://github.com/segmentio/nightmare#evaluatefn-arg1-arg2" target="_blank" rel="noopener">官方解释</a>。</p><h4><span id="wait">wait</span></h4><p><code>wait(ms)</code>，<code>.wait(selector)</code>，<code>.wait(fn)</code> 这三个方法在页面进行异步操作的时候比较好用。<a href="https://github.com/segmentio/nightmare#waitms" target="_blank" rel="noopener">接口文档</a>。</p><p>例如发送请求，等待图片下载等，都可以通过上面的方式实现。</p><h2><span id="测试">测试</span></h2><p>有了 <a href="http://nightmarejs.org" target="_blank" rel="noopener">Nightmare</a>，我们就可以结合 <a href="http://mochajs.org/" target="_blank" rel="noopener">Mocha</a>，给我们的项目编写测试例，下面将以我的一个小项目 <a href="https://github.com/csbun/resize-image" target="_blank" rel="noopener">resize-image</a> 为例：</p><p>同样的，因为使用了 generator，我们加入 <a href="https://www.npmjs.com/package/mocha-generators" target="_blank" rel="noopener">mocha-generators</a>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* test.js */</span></span><br><span class="line"><span class="comment">// enable generator `it('', function * () &#123;&#125;)`</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'mocha-generators'</span>).install();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> Nightmare = <span class="built_in">require</span>(<span class="string">'nightmare'</span>);</span><br><span class="line"><span class="keyword">var</span> assert = <span class="built_in">require</span>(<span class="string">'assert'</span>);</span><br></pre></td></tr></table></figure><h3><span id="本地服务器">本地服务器</span></h3><p>然后我们需要一个本地服务器，基于 Node，我们可以很简单写就写一个出来：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* server.js */</span></span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> html = fs.readFileSync(path.join(__dirname, <span class="string">'test.html'</span>), <span class="string">'utf8'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> pngFile = path.join(__dirname, <span class="string">'../example/google.png'</span>);</span><br><span class="line"><span class="keyword">var</span> pngStat = fs.statSync(pngFile);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> jsFile = path.join(__dirname, <span class="string">'../index.js'</span>);</span><br><span class="line"><span class="keyword">var</span> jsStat = fs.statSync(jsFile);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (req.url === <span class="string">'/index.js'</span>) &#123;</span><br><span class="line">    res.writeHead(<span class="number">200</span>, &#123;</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'text/javascript'</span>,</span><br><span class="line">        <span class="string">'Content-Length'</span>: jsStat.size</span><br><span class="line">    &#125;);</span><br><span class="line">    fs.createReadStream(jsFile).pipe(res);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (req.url === <span class="string">'/google.png'</span>) &#123;</span><br><span class="line">    res.writeHead(<span class="number">200</span>, &#123;</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'image/png'</span>,</span><br><span class="line">        <span class="string">'Content-Length'</span>: pngStat.size</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">var</span> readStream = fs.createReadStream(pngFile);</span><br><span class="line">    readStream.pipe(res);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/html'</span>&#125;);</span><br><span class="line">    res.end(html);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>其中，<code>google.png</code> 只是一张普通的图片，<code>index.js</code> 则为 <a href="https://github.com/csbun/resize-image" target="_blank" rel="noopener">resize-image</a> 的源码，<code>test.html</code> 则为一个简单的测试页面：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Resize Image<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"index.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">"img"</span> <span class="attr">src</span>=<span class="string">"./google.png"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h3><span id="测试代码">测试代码</span></h3><p>下面我们就能开始测试：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* test.js */</span></span><br><span class="line"><span class="keyword">var</span> PORT = <span class="number">7500</span>;</span><br><span class="line"><span class="keyword">var</span> ASSERT_SIZE = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'resize-image'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// start server</span></span><br><span class="line">  before(<span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">'./server'</span>).listen(PORT, done);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// test `.resize`</span></span><br><span class="line">  it(<span class="string">'.resize: Resize any image to '</span> + ASSERT_SIZE, <span class="function"><span class="keyword">function</span> * (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> nightmare = Nightmare(); <span class="comment">// 不要 show 了</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> min = <span class="keyword">yield</span> nightmare</span><br><span class="line">      .goto(<span class="string">'http://0.0.0.0:'</span> + PORT + <span class="string">'/'</span>)</span><br><span class="line">      .evaluate(<span class="function"><span class="keyword">function</span> (<span class="params">ASSERT_SIZE</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> img = <span class="built_in">document</span>.getElementById(<span class="string">'img'</span>);</span><br><span class="line">        <span class="comment">// resize</span></span><br><span class="line">        <span class="keyword">var</span> base64 = <span class="built_in">window</span>.ResizeImage.resize(img, ASSERT_SIZE, ASSERT_SIZE, ResizeImage.PNG);</span><br><span class="line">        <span class="comment">// get resized image size</span></span><br><span class="line">        <span class="keyword">var</span> resizedImg = <span class="keyword">new</span> Image();</span><br><span class="line">        resizedImg.src = base64;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Math</span>.min(resizedImg.width, resizedImg.height);</span><br><span class="line">      &#125;, ASSERT_SIZE)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">yield</span> nightmare.end();</span><br><span class="line">    assert.equal(min, ASSERT_SIZE);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>运行 <code>mocha</code>，执行结果如下：</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">resize</span>-<span class="built_in">image</span></span><br><span class="line">  ✓ .<span class="built_in">resize</span>: <span class="built_in">Resize</span> any <span class="built_in">image</span> <span class="keyword">to</span> <span class="number">200</span> (<span class="number">582</span>ms)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">1</span> passing (<span class="number">595</span>ms)</span><br></pre></td></tr></table></figure><p>完成！没问题！完整的例子请看 <a href="https://github.com/csbun/resize-image/tree/master/test" target="_blank" rel="noopener">这里</a>。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;http://nightmarejs.org&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Nightmare&lt;/a&gt; is a high-level browser automation library. 和之前的 &lt;a href=&quot;http://phantomjs.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;PhantomJS&lt;/a&gt; 很像，但是 &lt;a href=&quot;http://nightmarejs.org&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Nightmare&lt;/a&gt; 是基于 &lt;a href=&quot;http://electron.atom.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Electron&lt;/a&gt; 的，也就是还是基于 Chromium 和 Node.js。但是感觉其写法比 &lt;a href=&quot;http://phantomjs.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;PhantomJS&lt;/a&gt; 简单一些：&lt;/p&gt;
    
    </summary>
    
    
      <category term="test" scheme="http://csbun.github.io/blog/tags/test/"/>
    
      <category term="nightmare" scheme="http://csbun.github.io/blog/tags/nightmare/"/>
    
  </entry>
  
  <entry>
    <title>Using Contenteditable</title>
    <link href="http://csbun.github.io/blog/2015/09/using-contenteditable/"/>
    <id>http://csbun.github.io/blog/2015/09/using-contenteditable/</id>
    <published>2015-09-21T07:14:03.000Z</published>
    <updated>2020-11-03T11:52:46.278Z</updated>
    
    <content type="html"><![CDATA[<p>最近才发现的这个东西啊，但是查了一下 <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/contentEditable" target="_blank" rel="noopener">MDN</a>，貌似已经很普及了，连 IE6 都支持（虽然有一大堆的 bug）。</p><a id="more"></a><h2><span id="用法">用法</span></h2><h3><span id="javascript">JavaScript</span></h3><p>很简单的，就是随便在页面上搞个元素，然后设置为可编辑：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"editable"</span>&gt;</span>I'm editable!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> el = <span class="built_in">document</span>.getElementById(<span class="string">'editable'</span>);</span></span><br><span class="line"><span class="actionscript">el.contentEditable = <span class="string">'true'</span>;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中 <code>contentEditable</code> 的值是字符串，有三种选择：</p><ul><li><code>&#39;true&#39;</code> 可编辑的</li><li><code>&#39;false&#39;</code> 不可编辑的</li><li><code>&#39;inherit&#39;</code> 继承父元素的状态</li></ul><h3><span id="attribute">Attribute</span></h3><p>这个是 HTML5 中一个新的全局属性，<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Global_attributes/contenteditable" target="_blank" rel="noopener">MDN</a>：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">contenteditable</span>=<span class="string">"true"</span>&gt;</span>I'm editable!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><h2><span id="用途">用途</span></h2><p>当我看到这货，我第一反应就是拿来做“自定义页面”，运营人员应该会觉得很实在，大致原理如下：</p><ul><li>运营端从数据存储服务输出页面</li><li>页面中可自定义的部分标识为 contenteditable</li><li>运营人员修改该部分内容后点击保存</li><li>获取 contenteditable 元素的 innerHTML，回传至数据存储服务</li><li>终端用户使用更新后的数据存储服务的数据渲染页面</li></ul><p>这里有一个我用 localStorage 用作虚拟的数据存储服务：</p><p></p><p data-height="750" data-theme-id="18973" data-slug-hash="avNpZw" data-default-tab="result" data-user="csbun" class="codepen">See the Pen <a href="http://codepen.io/csbun/pen/avNpZw/" target="_blank" rel="noopener">avNpZw</a> by csbun (<a href="http://codepen.io/csbun" target="_blank" rel="noopener">@csbun</a>) on <a href="http://codepen.io" target="_blank" rel="noopener">CodePen</a>.</p><p></p><script async src="//assets.codepen.io/assets/embed/ei.js"></script><h2><span id="实例">实例</span></h2><p>这里有更多有趣的实例：</p><ul><li><a href="http://substance.io/" target="_blank" rel="noopener">substance</a></li><li><a href="http://getcontenttools.com/demo" target="_blank" rel="noopener">ContentTools</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近才发现的这个东西啊，但是查了一下 &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/contentEditable&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;MDN&lt;/a&gt;，貌似已经很普及了，连 IE6 都支持（虽然有一大堆的 bug）。&lt;/p&gt;
    
    </summary>
    
    
      <category term="contentEditable" scheme="http://csbun.github.io/blog/tags/contentEditable/"/>
    
  </entry>
  
  <entry>
    <title>使用 iron-node 进行 Node Debug</title>
    <link href="http://csbun.github.io/blog/2015/09/using-iron-node/"/>
    <id>http://csbun.github.io/blog/2015/09/using-iron-node/</id>
    <published>2015-09-15T07:05:33.000Z</published>
    <updated>2020-11-03T11:52:46.277Z</updated>
    
    <content type="html"><![CDATA[<p>简单折腾了一下 <a href="http://s-a.github.io/iron-node/" target="_blank" rel="noopener">iron-node</a>，调试 Node 再也不用苦逼地 console.log 了。</p><a id="more"></a><h2><span id="安装">安装</span></h2><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -g iron-<span class="keyword">node</span><span class="title"></span></span><br></pre></td></tr></table></figure><h2><span id="启动">启动</span></h2><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iron-<span class="keyword">node</span> <span class="title">path</span>/to/file.js</span><br></pre></td></tr></table></figure><p>运行上述命令启动，会自动打开一个 Chrome Developer Tools 界面，运行 <code>node path/to/file.js</code> 的输出会在 Console 标签页中输出。</p><h2><span id="断点">断点</span></h2><p>最简单的断点方式当然是在源码中添加 <code>debugger;</code>，如这段：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> inc = <span class="function"><span class="keyword">function</span> (<span class="params">num</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">debugger</span>; <span class="comment">// break point here</span></span><br><span class="line">    <span class="keyword">return</span> ++num;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'inc(3) = '</span> + inc(<span class="number">3</span>));</span><br></pre></td></tr></table></figure><p>同时，也在 Sources 标签页 的 (no domain) 分类中可以看到运行的源码。这样就可以像平时调试页面一样点击行号添加删除断点。</p><blockquote><p>尝试了一下使用 Map Workspace 无效，没有文件目录结果，这一点比较痛苦。</p></blockquote><h2><span id="文件更新">文件更新</span></h2><p>当文件更新时，只要在 Chrome Developer Tools 界面按快捷键 <code>Command+R</code> 刷新即可，而且刷新后短点仍然存在。</p><blockquote><p>焦点必须在 DevTool 上，而不是预览界面（显示 DEBUG.md 或 README.md 的 index.html）</p></blockquote><h2><span id="使用-es6">使用 ES6</span></h2><p>虽然 Node 已经升级的到 v4.0.0，支持 ES6 了，但是 iron-node 好像还没完全跟上，所以要开启一些 <a href="https://github.com/thlorenz/v8-flags/blob/master/flags-0.11.md" target="_blank" rel="noopener">v8 flags</a>。入口文件所在目录创建文件 <code>.iron-node.js.</code>，如在我的例子中，是开启箭头函数：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    v8: &#123;</span><br><span class="line">        flags : [</span><br><span class="line">            <span class="string">'--harmony-arrow-functions'</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    app: &#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>详情可以直接参考 <a href="https://github.com/s-a/iron-node/blob/master/.iron-node.js" target="_blank" rel="noopener">官方例子</a>。如果想设置为全局配置，就看 <a href="https://github.com/s-a/iron-node/blob/master/docs/CONFIGURATION.md" target="_blank" rel="noopener">这里</a>。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;简单折腾了一下 &lt;a href=&quot;http://s-a.github.io/iron-node/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;iron-node&lt;/a&gt;，调试 Node 再也不用苦逼地 console.log 了。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Node" scheme="http://csbun.github.io/blog/tags/Node/"/>
    
      <category term="debug" scheme="http://csbun.github.io/blog/tags/debug/"/>
    
  </entry>
  
</feed>
